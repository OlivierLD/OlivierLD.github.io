<!DOCTYPE html>
<!--
 | Real Time Celestial status.
 | MPS Positioning System demo, WiP.
 | Clean version (or so) for the JavaScript MPS function, no REST calls.
 |
 | All the skill in the "compute" function below, invoked on click.
 | Dynamic background test.
 |
 | Computes the position, intersections of the cones, defined by
 | - The selected bodies
 |     - Obs Alt, UTC Date -> GHA, Dec
 +-->
<html lang="en_US">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/png" href="./images/sextant.png">
    <title>MPS For real</title>

    <!-- Main Module -->
    <script type="module" src="./astro.js"></script> <!-- THAT is the key -->
    <script type="module" src="./MPS.utils.js"></script> <!-- MPS tools -->

    <!-- Web Components -->
    <script type="module" src="./webcomponents/WorldMap.js"></script>
    <script type="module" src="./webcomponents/MarqueePanel.js"></script>
    <!--script type="module" src="./webcomponents/CalendarDisplay.js"></script-->
    <script type="module" src="./webcomponents/SplitFlapDisplay.js"></script>
    <script type="module" src="./webcomponents/JumboDisplay.js"></script>
    <script type="module" src="./webcomponents/JumboPlusDisplay.js"></script>
    <script type="module" src="./webcomponents/ScrollDigit.js"></script>
    <!--script type="module" src="./webcomponents/MoonPhase.js"></script-->
    <script type="module" src="./webcomponents/moonphase.2/MoonPhase.js"></script>
    <script type="module" src="./webcomponents/SunPath.js"></script>
    <script type="module" src="./webcomponents/skymap/SkyMap.js"></script>
    <script type="module" src="./webcomponents/GraphDisplay.js"></script>

    <!-- Specific Scripts -->
    <script type="text/javascript" src="date.proto.js"></script>

    <script type="text/javascript">

// import { astroMain } from "./astro.js";

let globalAstroData;
let globalSRUSun;
let globalSRUMoon;

let globalSRUStars;

let marqueeScrollUpAnimationInterval;
// let defaultMarqueeTextArray = [ 'Raspberry Pi', 'Web Components', 'Java & Processing', 'HTML5, CSS3, ES6', 'NodeJS', 'Python', '3D Printing', 'Arduino & Co', 'AI, ML, DL', 'Artificial Intelligence', 'Artificial Insanity', 'and other toys...' ];

let marqueeScrollUp = (marqueeId) => {
    if (marqueeScrollUpAnimationInterval !== undefined) {
        window.clearInterval(marqueeScrollUpAnimationInterval); // Stop.
        marqueeScrollUpAnimationInterval = undefined;
    } else {
        let marqueeObj = document.getElementById(marqueeId);
        let x = marqueeObj.nbCols;
        let yOffset = marqueeObj.yOffset;
        let y = 12;
        marqueeScrollUpAnimationInterval = window.setInterval(function() { // Start
            let data = JSON.parse(marqueeObj.displayData); // { text-array: txt, x: x, y: y };
            let arrayCardinality = 1;
            if (data['text-array'] !== undefined) {
                arrayCardinality = data['text-array'].length;
            }
            yOffset -= 1;
            if (yOffset < -(arrayCardinality * 12)) {
                yOffset = marqueeObj.nbLines;
            }
            marqueeObj.yOffset = yOffset;

            let toDisplay = [];
            toDisplay.push(new Date().format('d M Y H:i:s Z'));
            // defaultMarqueeTextArray.forEach(item => {
            //     toDisplay.push(item);
            // });
            // Other values
            if (globalAstroData !== undefined) {
                toDisplay.push("Sun GHA: " + globalAstroData.sun.GHA.fmt);
                toDisplay.push("Sun D: " + globalAstroData.sun.DEC.fmt);
                toDisplay.push("Moon GHA: " + globalAstroData.moon.GHA.fmt);
                toDisplay.push("Moon D: " + globalAstroData.moon.DEC.fmt);
                toDisplay.push("Venus GHA: " + globalAstroData.venus.GHA.fmt);
                toDisplay.push("Venus D: " + globalAstroData.venus.DEC.fmt);
                toDisplay.push("Mars GHA: " + globalAstroData.mars.GHA.fmt);
                toDisplay.push("Mars D: " + globalAstroData.mars.DEC.fmt);
                toDisplay.push("Jupiter GHA: " + globalAstroData.jupiter.GHA.fmt);
                toDisplay.push("Jupiter D: " + globalAstroData.jupiter.DEC.fmt);
                toDisplay.push("Saturn GHA: " + globalAstroData.saturn.GHA.fmt);
                toDisplay.push("Saturn D: " + globalAstroData.saturn.DEC.fmt);
            }
            if (userPos !== undefined && userPos.longitude !== undefined) {
                let lhaSun  = calcLHA(globalAstroData.sun.GHA.raw, userPos.longitude);
                let lhaMoon = calcLHA(globalAstroData.moon.GHA.raw, userPos.longitude);
                toDisplay.push("-----------------------");
                toDisplay.push(`LHA Sun: ${decToSex(lhaSun)}`);
                toDisplay.push(`LHA Moon: ${decToSex(lhaMoon)}`);
            }
            if (globalSRUSun !== undefined) {
                toDisplay.push("-----------------------");
                toDisplay.push(`Sun Elev: ${globalSRUSun.alt.toFixed(2)}°`);
                toDisplay.push(`Sun Z: ${globalSRUSun.Z.toFixed(1)}°`);
            }
            if (globalSRUMoon !== undefined) {
                toDisplay.push(`Moon Elev: ${globalSRUMoon.alt.toFixed(2)}°`);
                toDisplay.push(`Moon Z: ${globalSRUMoon.Z.toFixed(1)}°`);
            }
            toDisplay.push("-----------------------");
            // toDisplay.push('And more to come!');

            data['text-array'] = toDisplay;
            marqueeObj.displayData = JSON.stringify(data);
            marqueeObj.repaint();
        }, 30);
    }
};

// console.log("marqueeScrollUp defined");

let setNewTilt = (range, id) => {
    let elem = document.getElementById(id);
    var val = range.value;
    if (elem !== undefined) {
        elem.tilt = val;
        elem.repaint();
    }
};

let setNewZOffset = (range, id) => {
    let elem = document.getElementById(id);
    var val = range.value;
    if (elem !== undefined) {
        elem.zOffset = val;
        elem.repaint();
    }
};

    </script>

    <!-- Nav Bar management -->
    <script type="text/javascript" src="js/nav-bar.js"></script>
    <!-- For the ISS -->
    <script type="text/javascript" src="js/ajax.manager.js"></script>

    <script type="text/javascript">

let transformDataForWorldWebComp = json => {
    let newObj = {};
    newObj.deltaT = json.deltaT;
    // let pos = { // SF
    //     latitude: 37.7489,
    //     longitude: -122.507
    // };
    newObj.from = userPos; // pos;

    // GRID coordinates
    let maidenHeadGridSquare = gridSquare(userPos.latitude, userPos.longitude); // exposed in astro.js
    newObj.gridSquare = maidenHeadGridSquare;

    let sun = {
        decl: json.sun.DEC.raw,
        gha: json.sun.GHA.raw
    };
    newObj.sun = sun;
    let moon ={
        decl: json.moon.DEC.raw,
        gha: json.moon.GHA.raw
    };
    newObj.moon = moon;

    newObj.moonPhase = json.moon.phase.phaseAngle;

    newObj.eclipticObliquity = json.trueObliq.raw;

    newObj.ghaAries = json.aries.GHA.raw;

    if (json.venus !== undefined) {
        wanderingBodies = [];

        wanderingBodies.push({
            name: "aries",
            decl: 0,
            gha: json.aries.GHA.raw
        });

        wanderingBodies.push({
            name: "venus",
            decl: json.venus.DEC.raw,
            gha: json.venus.GHA.raw
        });
        wanderingBodies.push({
            name: "mars",
            decl: json.mars.DEC.raw,
            gha: json.mars.GHA.raw
        });
        wanderingBodies.push({
            name: "jupiter",
            decl: json.jupiter.DEC.raw,
            gha: json.jupiter.GHA.raw
        });
        wanderingBodies.push({
            name: "saturn",
            decl: json.saturn.DEC.raw,
            gha: json.saturn.GHA.raw
        });
        newObj.wanderingBodies = wanderingBodies;
    }

    if (json.stars !== undefined) {
        newObj.stars = json.stars;
    }
    if (json.constellations !== undefined) {
        newObj.constellations = json.constellations;
    }

    return newObj;
};

let displayWorldData = (astroData) => {
    let worldMap = document.getElementById('world-map-01');

    // Set user position!!
    if (astroData === undefined) {
        worldMap.setUserPosition({ longitude: -122.507, latitude: 37.7489 });
    } else {
        worldMap.setUserPosition({ longitude: astroData.from.longitude, latitude: astroData.from.latitude, gridSquare: astroData.gridSquare });
        worldMap.setAstronomicalData(astroData);
        worldMap.repaint();
    }
};

let userSunPos = false; // user by default
let simulatePressureAndHeading = false;

let switchPos = (cb) => {
    userSunPos = cb.checked;
    if (userSunPos) { // Store the backup
        userPosBackup.latitude = userPos.latitude;
        userPosBackup.longitude = userPos.longitude;
    } else {          // Restore the backup
        userPos.latitude = userPosBackup.latitude;
        userPos.longitude = userPosBackup.longitude;
        setUserPos(userPos.latitude, userPos.longitude);
    }
    console.log(`User-Sun: ${userSunPos ? "Using Sun position" : "Using User porsition"}`);
};

let setSimulation = (cb) => {
    simulatePressureAndHeading = cb.checked;
    // simulation-div
    if (simulatePressureAndHeading) {
        document.getElementById("simulation-div").innerHTML = "Heading and PRMSL are <i>simulated</i>";
    } else {
        document.getElementById("simulation-div").innerHTML = "Heading and PRMSL can be <i>simulated</i>";
    }
};

let setTransparency = (wcId, cb) => {
	document.getElementById(wcId).transparentGlobe = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setSun = (wcId, cb) => {
	document.getElementById(wcId).withSun = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setSolarDate = (wcId, cb) => {
	document.getElementById(wcId).style.display = (cb.checked ? 'block' : 'none');
	// document.getElementById(wcId).repaint();
};

let setGrid = (wcId, cb) => {
	document.getElementById(wcId).withGrid = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setMoon = (wcId, cb) => {
	document.getElementById(wcId).withMoon = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setSunlight = (wcId, cb) => {
	document.getElementById(wcId).withSunlight = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setMoonlight = (wcId, cb) => {
	document.getElementById(wcId).withMoonlight = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setWanderingBodies = (wcId, cb) => {
	document.getElementById(wcId).withWanderingBodies = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setStars = (wcId, cb) => {
	document.getElementById(wcId).withStars = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setConstellations = (wcId, cb) => {
	document.getElementById(wcId).withConstellations = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setTropics = (wcId, cb) => {
	document.getElementById(wcId).withTropics = (cb.checked ? 'true' : 'false');
	document.getElementById(wcId).repaint();
};

let setProjection = (id, radio) => {
	document.getElementById(id).projection = radio.value;
	document.getElementById(id).repaint();
};

// Used by setGeolocation
let geoInterval;
const options = {
    enableHighAccuracy: true,
    maximumAge: 0,
    timeout: 5000
};

// Called from navigator.geolocation.getCurrentPosition
// Used by setGeolocation
const onPosSuccess = (pos) => {
    document.getElementById('geo-mess').style.display = 'block'; // Display message
    // Doc at https://w3c.github.io/geolocation-api/
    // Position object at https://w3c.github.io/geolocation-api/#position_interface
    //
    console.log('lat= ' + pos.coords.latitude + ' lon= ' + pos.coords.longitude); // + ' hdg= ' + pos.coords.heading + ' spd= ' + pos.coords.speed + ' m/s');
    //  console.log("Pos data:" + pos.coords);
    // Feed the fields:
    // pos-lat-sign-01, pos-lat-deg-01, pos-lat-min-01
    // pos-lng-sign-01, pos-lng-deg-01, pos-lng-min-01
    let latSign = (pos.coords.latitude < 0) ? 'S' : 'N';
    document.getElementById('pos-lat-sign-01').value = latSign;
    let lat = Math.abs(pos.coords.latitude);
    let lngSign = (pos.coords.longitude < 0) ? 'W' : 'E';
    document.getElementById('pos-lng-sign-01').value = lngSign;
    let lng = Math.abs(pos.coords.longitude);
    // Latitude value
    let latDegVal = Math.floor(lat);
    document.getElementById('pos-lat-deg-01').value = latDegVal;
    let latMinVal = parseFloat(((lat - latDegVal) * 60.0).toFixed(2));
    document.getElementById('pos-lat-min-01').value = latMinVal;
    // Longitude Value
    let lngDegVal = Math.floor(lng);
    document.getElementById('pos-lng-deg-01').value = lngDegVal;
    let lngMinVal = parseFloat(((lng - lngDegVal) * 60.0).toFixed(2));
    document.getElementById('pos-lng-min-01').value = lngMinVal;
};

// Called from navigator.geolocation.getCurrentPosition
// Used by setGeolocation
const onPosError = (err) => {
    let errMess;
    if (err.code === err.PERMISSION_DENIED) {
        errMess = 'Location access was denied by the user.';
    } else {
        errMess = 'location error (' + err.code + '): ' + err.message;
    }
    console.error(errMess);
};

let setGeolocation = (slider) => {
    console.log(`GeoLocation turned ${slider.checked ? 'ON' : 'OFF'}`);
    if (slider.checked) {
        geoInterval = setInterval(() => {
           /* let watchId = */ navigator.geolocation.getCurrentPosition(onPosSuccess, onPosError, options);
        }, 1000);
    } else {
        document.getElementById('geo-mess').style.display = 'none';
        if (geoInterval) {
            clearInterval(geoInterval);
        }
    }
};

// expandCollapseSetPosData
let userPosDataExpanded = false;
let userDateExpanded = false;
let useHelpExpanded = false;
let userMPSExpanded = false;

let expandCollapseSetPosData = () => {

    document.getElementById('user-pos-widgets').classList.toggle('visible-div');

    if (userPosDataExpanded) {
        // document.getElementById('user-pos-widgets').style.display = 'none';
        document.getElementById('pos-char').innerHTML = '&#9658;'; // '\u142f Position on Earth';
    } else {
        //document.getElementById('user-pos-widgets').style.display = 'block';
        document.getElementById('pos-char').innerHTML = '&#9660;'; // '\u1431 Position on Earth';
    }
    userPosDataExpanded = !userPosDataExpanded;
};
let expandCollapseDateData = () => {

    document.getElementById('user-date-widgets').classList.toggle('visible-div');

    if (userDateExpanded) {
        // document.getElementById('user-date-widgets').style.display = 'none';
        document.getElementById('date-char').innerHTML = '&#9658;';
    } else {
        // document.getElementById('user-date-widgets').style.display = 'block';
        document.getElementById('date-char').innerHTML = '&#9660;';
    }
    userDateExpanded = !userDateExpanded;
};

let expandCollapseHelpData = () => {
    document.getElementById('user-help-widgets').classList.toggle('visible-div');

    if (useHelpExpanded) {
        // document.getElementById('user-date-widgets').style.display = 'none';
        document.getElementById('help-char').innerHTML = '&#9658;';
    } else {
        // document.getElementById('user-date-widgets').style.display = 'block';
        document.getElementById('help-char').innerHTML = '&#9660;';
    }
    useHelpExpanded = !useHelpExpanded;
};

let expandCollapseMPSData = () => {
    document.getElementById('user-mps-widgets').classList.toggle('visible-div');
    // document.getElementById('user-help-widgets').classList.toggle('visible-div');
    if (userMPSExpanded) {
        // document.getElementById('user-date-widgets').style.display = 'none';
        document.getElementById('mps-char').innerHTML = '&#9658;';
    } else {
        // document.getElementById('user-date-widgets').style.display = 'block';
        document.getElementById('mps-char').innerHTML = '&#9660;';
    }
    userMPSExpanded = !userMPSExpanded;
};

let updatePosition = () => {

    if (!userSunPos) { // Use user position

        let sgnLat = document.getElementById("pos-lat-sign-01").value;
        let degLat = parseInt(document.getElementById("pos-lat-deg-01").value);
        let minLat = parseFloat(document.getElementById("pos-lat-min-01").value);
        let lat = (degLat + (minLat / 60.0)) * (sgnLat === 'N' ? 1 : -1);

        let sgnLng = document.getElementById("pos-lng-sign-01").value;
        let degLng = parseInt(document.getElementById("pos-lng-deg-01").value);
        let minLng = parseFloat(document.getElementById("pos-lng-min-01").value);
        let lng = (degLng + (minLng / 60.0)) * (sgnLng === 'E' ? 1 : -1);

    //		console.log("Setting pos to " + lat + "/" + lng);
        setUserPos(lat, lng);
        // URL to bookmark
        let toBookmark = `${window.location.protocol}//${window.location.hostname}:${window.location.pathname}?lat=${lat}&long=${lng}`;

        console.log("Bookmark this URL: " + toBookmark);
        document.getElementById("url-to-bookmark").innerText = toBookmark;
        document.getElementById("url-placeHolder").style.display = "block";
    } else {
        // Use Sun pos
        console.log("Use SUN position");
        // globalAstroData
    }
};

let updateFromUserPos = () => {
    document.getElementById("pos-lat-sign-01").value = userPos.latitude < 0 ? "S" : "N";
    document.getElementById("pos-lng-sign-01").value = userPos.longitude < 0 ? "W" : "E";
    let absLat = Math.abs(userPos.latitude);
    let absLong = Math.abs(userPos.longitude);
    document.getElementById("pos-lat-deg-01").value = Math.trunc(absLat);
    document.getElementById("pos-lat-min-01").value = ((absLat - Math.trunc(absLat)) * 60).toFixed(2);
    document.getElementById("pos-lng-deg-01").value = Math.trunc(absLong);
    document.getElementById("pos-lng-min-01").value = ((absLong - Math.trunc(absLong)) * 60).toFixed(2);
};

let userPos = { // Default SF
    latitude: 37.7489,
    longitude: -122.507
};

let userPosBackup = {
    latitude: userPos.latitude,
    longitude: userPos.longitude
}

let setUserPos = (lat, lng) => {
    userPos.latitude = lat;
    userPos.longitude = lng;

    let worldMap = document.getElementById('world-map-01');

    // Set user position!!
    worldMap.setUserPosition(userPos);
    worldMap.repaint();
};

let calculateMPS = () => {
    let worldMap = document.getElementById('world-map-01');
    worldMap.repaint();
}

let hidden = true;
let showHideData = () => {
    let dataZone = document.getElementById("raw-data");
    if (hidden) {
        dataZone.style.display = "block";
    } else {
        dataZone.style.display = "none";
    }
    hidden = !hidden;
};

const FRAME_WIDTH  = 160;
const FRAME_HEIGHT = 160;
// let DEBUG = false;

if (Math.toRadians === undefined) {
    Math.toRadians = deg => {
        return (deg / 180) * Math.PI;
    };
}

// XMLNS Required.
const XMLNS = "http://www.w3.org/2000/svg";

/**
 * Draw an arrow, using SVG
 *
 * @param divId ID of the div to draw the arrow in
 * @param dir Direction to represent in degrees, number [0..360], or object { value: number, label: 'string' }.
 *            label would be like "ENE" when dir is 67.5, for example.
 * @param force Optional. Used for wind (Beaufort)
 * @returns {{svgContent: SVGSVGElement, x: number, y: number}} if divId is undefined.
 */
let drawArrow = (divId, dir, body) => {
    let label = '';
    let fillColor = 'white';
    let direction;  // = dir; //  + 180;
    if (typeof(dir) === 'number') {
        direction = dir - 180;
        label += `${body} Z: ${dir.toFixed(1)}°`
    } else {
        try {
            direction = dir.value;
            label += dir.label;
        } catch (oops) {
            console.log('Akeu what?')
            direction = 0;
        }
    }
    let title = null;
    direction = -direction;

    let parent = (divId !== null) ? document.getElementById(divId) : null;
    if (title !== null && parent !== null) {
        parent.setAttribute('title', title);

    }
    let svg = document.createElementNS(XMLNS, 'svg');
    // svg.setAttribute('xmlns', xmlns);
    svg.setAttributeNS(null, 'width', FRAME_WIDTH.toString());
    svg.setAttributeNS(null, 'height', FRAME_HEIGHT.toString());
    svg.setAttribute('style', 'background-color: transparent; border-radius: 10px; border: 2px solid rgba(128, 128, 128, 0.25);');

    if (parent !== null) {
        parent.appendChild(svg);
    }

    let circle = document.createElementNS(XMLNS, 'circle');
    circle.setAttributeNS(null, 'cx', (FRAME_WIDTH / 2).toString());
    circle.setAttributeNS(null, 'cy', (FRAME_HEIGHT / 2).toString());
    circle.setAttributeNS(null, 'r', '40');
    circle.setAttributeNS(null, 'stroke', 'rgba(255, 255, 2550, 0.35)');
    circle.setAttributeNS(null, 'stroke-width', '4');
    circle.setAttributeNS(null, 'fill', 'rgba(0, 0, 128, 0.15)');
    svg.appendChild(circle);

    let polygon = document.createElementNS(XMLNS, 'polygon');
    polygon.setAttribute('style', `fill: ${fillColor}; stroke: rgba(0, 0, 0, 0.35); stroke-width: 2;`);

    let headX = (FRAME_WIDTH / 2) + (60 * Math.sin(Math.toRadians(direction)));
    let headY = (FRAME_HEIGHT / 2) + (60 * Math.cos(Math.toRadians(direction)));
    let arrow = [{
        // head
        x: headX,
        y: headY
    }, {
        // tail - left
        x: (FRAME_WIDTH / 2) - (60 * Math.sin(Math.toRadians(direction + 10))),
        y: (FRAME_HEIGHT / 2) - (60 * Math.cos(Math.toRadians(direction + 10)))
    }, {
        // tail - center
        x: (FRAME_WIDTH / 2) - (55 * Math.sin(Math.toRadians(direction))),
        y: (FRAME_HEIGHT / 2) - (55 * Math.cos(Math.toRadians(direction)))
    }, {
        // tail - right
        x: (FRAME_WIDTH / 2) - (60 * Math.sin(Math.toRadians(direction - 10))),
        y: (FRAME_HEIGHT / 2) - (60 * Math.cos(Math.toRadians(direction - 10)))
    }];
    // Draw polygon points here
    let points = ""; // `${head.x.toFixed(0)},${head.y.toFixed(0)} ${tailRight.x.toFixed(0)},${tailRight.y.toFixed(0)} ${tail.x.toFixed(0)},${tail.y.toFixed(0)} ${tailLeft.x.toFixed(0)},${tailLeft.y.toFixed(0)}`;
    arrow.forEach(pt => {
        points += `${pt.x.toFixed(0)},${pt.y.toFixed(0)} `;
    });
    // console.log('Points:' + points.trim());
    try {
        polygon.setAttributeNS(null, 'points', points.trim());
        svg.appendChild(polygon);
    } catch (err) {
        console.log(`Oops: ${JSON.stringify(err)}`);
    }

    let text = document.createElementNS(XMLNS, 'text');
    text.setAttributeNS(null, 'x', '10');
    text.setAttributeNS(null, 'y', '25');
    text.setAttributeNS(null, 'font-size', '16');
    text.setAttributeNS(null, 'font-weight', 'bold');
    text.setAttributeNS(null, 'font-family', "'Helvetica Neue', 'Lato', Verdana, Helvetica, Geneva, sans-serif;");
    text.setAttributeNS(null, 'fill', 'rgba(255, 244, 255, 0.75)');
    text.appendChild(document.createTextNode(`${label}`));
    svg.appendChild(text);

    if (parent !== null && DEBUG) {
        console.log(parent.innerHTML);
    }
    //debugger;
    let svgContent = {x: headX, y: headY, svgContent: svg};
    if (divId !== undefined) {
        let svgDiv = document.getElementById(divId);
        // It's a replace, remove first.
        let content = svgDiv.firstElementChild;
        if (content !== null && content !== undefined) {
            svgDiv.removeChild(content);
        }
        svgDiv.appendChild(svg);
    } else {
        return svgContent;
    }
};

// SVG widget for the Sun's altitude.
let drawElevation = (divId, elev, color, circleColor) => { // colors in hex, like #ffff00
    // console.log(`Sun Elevation: ${elev.toFixed(2)}`);
    // document.getElementById(divId).innerHTML = `Sun Elevation: ${elev.toFixed(2)}&deg;`;
    let fillColor = 'rgba(255, 255, 255, 0.5)';
    let parent = (divId !== null) ? document.getElementById(divId) : null;

    let svg = document.createElementNS(XMLNS, 'svg');
    // svg.setAttribute('xmlns', xmlns);
    svg.setAttributeNS(null, 'width', FRAME_WIDTH.toString());
    svg.setAttributeNS(null, 'height', FRAME_HEIGHT.toString());
    svg.setAttribute('style', 'background-color: transparent; border-radius: 10px; border: 2px solid rgba(128, 128, 128, 0.25);');

    if (parent !== null) {
        parent.appendChild(svg);
    }

    // Arc
    /*
    <path d="M150 0 L75 200 L225 200 Z" />
        */
    let path = document.createElementNS(XMLNS, 'path');
    path.setAttribute('style', `fill: ${fillColor}; stroke: rgba(128, 128, 128, 0.5); stroke-width: 2;`);
    let pathDef = `M5,10 A30,30 0 0,1 5,${FRAME_HEIGHT - 10}`;
    //              |                 |
    //              |                 To 5,XX
    //              From 5,10
    path.setAttribute('d', pathDef);
    svg.appendChild(path);

    // Horizontal
    let horizon = document.createElementNS(XMLNS, 'path');
    horizon.setAttribute('style', `fill: ${fillColor}; stroke: rgba(255, 255, 255, 0.35); stroke-width: 1;`);
    let horizonDef = `M5,${FRAME_HEIGHT / 2} L${FRAME_WIDTH - 5},${FRAME_HEIGHT / 2}`;
    horizon.setAttribute('d', horizonDef);
    svg.appendChild(horizon);

    // To the Sun
    let radius = FRAME_HEIGHT / 2;
    let x = radius * Math.cos(Math.toRadians(elev));
    let y = radius * Math.sin(Math.toRadians(elev));
    let toSun = document.createElementNS(XMLNS, 'path');
    toSun.setAttribute('style', `fill: ${fillColor}; stroke: rgba(0, 0, 0, 0.35); stroke-width: 1;`);
    let toSunDef = `M5,${FRAME_HEIGHT / 2} L${x},${(FRAME_HEIGHT / 2) - y}`;
    toSun.setAttribute('d', toSunDef);
    svg.appendChild(toSun);

    // The sun
    /*
    <circle cx="40" cy="40" r="24" style="stroke:#006600; fill:#00cc00"/>
        */
    let sun = document.createElementNS(XMLNS, 'circle');
    sun.setAttribute('style', `stroke:${circleColor !== undefined ? circleColor : '#ff0000'}; fill:${color !== undefined ? color : '#ffff00'};`);
    sun.setAttribute('cx', `${x}`);
    sun.setAttribute('cy', `${(FRAME_HEIGHT / 2) - y}`);
    sun.setAttribute('r', '6');
    svg.appendChild(sun);

    // Text
    /*
    <text x="20" y="40">Example SVG text 1</text>
     */
    let absVal = Math.abs(elev);
    let intValue = Math.floor(absVal);
    let dec = absVal - intValue;
    dec *= 60;
    let min = dec.toFixed(1);
    let label = `Elev:${elev < 0 ? "-" : ""}${intValue}°${min}'`;
    let text = document.createElementNS(XMLNS, 'text');
    let fontSize = 10;
    text.setAttribute('x', 5);
    text.setAttribute('y', `${(FRAME_HEIGHT / 2) + (fontSize / 2) - 2}`);
    text.setAttributeNS(null, 'font-size', fontSize);
    text.setAttributeNS(null, 'font-weight', 'bold');
    text.setAttributeNS(null, 'font-family', "'Helvetica Neue', 'Lato', Verdana, Helvetica, Geneva, sans-serif;");
    text.setAttributeNS(null, 'fill', 'lime'); // 'rgba(0, 0, 0, 0.75)');

    text.appendChild(document.createTextNode(`${label}`));
    svg.appendChild(text);

    if (parent !== null) {
        parent.title = `${label}`;
    }

    let svgContent = {svgContent: svg};
    if (divId !== undefined) {
        let svgDiv = document.getElementById(divId);
        // It's a replace, remove first.
        let content = svgDiv.firstElementChild;
        if (content !== null && content !== undefined) {
            svgDiv.removeChild(content);
        }
        svgDiv.appendChild(svg);
    } else {
        return svgContent;
    }
};

let showForeGround = true;
let toggleForeground = () => {
    showForeGround = !showForeGround;
    document.getElementById('full-foreground').style.display = showForeGround ? 'block' : 'none';

};
    </script>

    <link rel="stylesheet" href="css/web-components.css">
    <link rel="stylesheet" href="css/nav-bar.css">

    <style>
        :root {
            --slide-width: 500px;
            --slide-height: 400px;
            --expanded-nav-width: 450px;
            --slider-scale: 0.5;
        }

        h1, h2, h3 {
            color: silver;
            font-family: Verdana,sans-serif;
            font-style: italic;
        }

        body {
            font-family: Verdana,sans-serif;
            /* color: cyan; */
            color: white;
            background-color: black;
        }

        .background {
            /*color: #999999;*/
            position: absolute;
            width: 100%;
            /*text-align: center;*/
            top: 0;
            left: 0;
            z-index: -100;
        }

        .day {
            width: 40px;
            text-align: center;
        }

        .year {
            width: 80px;
            text-align: center;
        }

        .result {
            margin: auto;
            margin-top: 10px;
            border: solid silver 1px;
            border-radius: 5px;
            width: 90%;
            height: 200px;
            max-height: 200px;
            font-family: "Courier New",sans-serif;
            overflow-y: auto;
        }

        .black-frame {
            padding: 3px;
            margin: 1px;
            border-radius: 5px;
            border: 1px solid silver;
            box-shadow: 0 2px 2px #ccc;
        }

        .centered {
            text-align: center;
        }

        .smooth {
            /*height: 0;*/
            /*visibility: hidden;*/
            /*opacity: 0;*/
            /*transition: visibility 0.5s, height 0.5s, opacity 0.5s linear;*/
            height: 0;
            max-height: 0;
            margin: auto;
            /*transition: transform 0.5s, max-height 1s, height 1s;*/
            transition: all 0.5s ease;
            opacity: 0;
            transform: scaleY(0);
            transform-origin: top;
            overflow: hidden;
        }

        .visible-div {
            opacity: 1;
            width: auto;
            height: auto;
            max-height: 1600px;
            transform: scaleY(1);
            margin-top: 5px;
        }

		button {
			padding: 4px 20px;
			/* give the background a gradient */
			background:#ffae00; /* fallback for browsers that don't support gradients */
			/* background: -webkit-linear-gradient(top, #ffae00, #d67600); */
			background: -webkit-linear-gradient(top, rgba(255, 174, 0, 0.6), rgba(214, 118, 0, 0.6));
			background: -moz-linear-gradient(top, #ffae00, #d67600);
			background: -o-linear-gradient(top, #ffae00, #d67600);
			/* background: linear-gradient(top, #ffae00, #d67600); */
			background: linear-gradient(top, rgba(255, 174, 0, 0.6), rgba(214, 118, 0, 0.6));
			border: 2px outset #dad9d8;
			/* style the text */
			font-family: Lato, Verdana, Andika, Arial, sans-serif; /* Andkia is available at http://www.google.com/webfonts/specimen/Andika */
			font-size: 1.1em;
			letter-spacing: 0.05em;
			text-transform: uppercase;
			color: #fff;
			text-shadow: 0px 1px 10px #000;
			/* add to small curve to the corners of the button */
			-webkit-border-radius: 15px;
			-moz-border-radius: 15px;
			border-radius: 15px;
			/* give the button a drop shadow */
			-webkit-box-shadow: rgba(0, 0, 0, .55) 0 1px 6px;
			-moz-box-shadow: rgba(0, 0, 0, .55) 0 1px 6px;
			box-shadow: rgba(0, 0, 0, .55) 0 1px 6px;
		}
		/* NOW STYLE THE BUTTON'S HOVER STATE */
		/*	button#rCoffee:hover, button#rCoffee:focus { */
		button:hover, button:focus {
			border:2px solid #dad9d8;
		}

        button:disabled {
            background: silver;
            color: gray;
        }

		/* Switch starts here */
		.rocker {
			display: inline-block;
			position: relative;
			/*
			SIZE OF SWITCH
			==============
			All sizes are in em - therefore
			changing the font-size here
			will change the size of the switch.
			See .rocker-small below as example.
			*/
			font-size: 2em;
			font-weight: bold;
			text-align: center;
			text-transform: uppercase;
			color: #888;
			width: 7em;
			height: 4em;
			overflow: hidden;
			border-bottom: 0.5em solid #eee;
		}

		.rocker-small {
			font-size: 0.75em; /* Sizes the switch */
			margin: 1em;
		}

		.rocker-tiny {
			font-size: 0.50em; /* Sizes the switch */
			margin: 1em;
		}

		.rocker::before {
			content: "";
			position: absolute;
			top: 0.5em;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #999;
			border: 0.5em solid #eee;
			border-bottom: 0;
		}

		.rocker input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.switch-left,
		.switch-right {
			cursor: pointer;
			position: absolute;
			display: flex;
			align-items: center;
			justify-content: center;
			height: 2.5em;
			width: 3em;
			transition: 0.2s;
		}

		.switch-left {
			height: 2.4em;
			width: 2.75em;
			left: 0.85em;
			bottom: 0.4em;
			background-color: #ddd;
			transform: rotate(15deg) skewX(15deg);
		}

		.switch-right {
			right: 0.5em;
			bottom: 0;
			background-color: #bd5757;
			color: #fff;
		}

		.switch-left::before,
		.switch-right::before {
			content: "";
			position: absolute;
			width: 0.4em;
			height: 2.45em;
			bottom: -0.45em;
			background-color: #ccc;
			transform: skewY(-65deg);
		}

		.switch-left::before {
			left: -0.4em;
		}

		.switch-right::before {
			right: -0.375em;
			background-color: transparent;
			transform: skewY(65deg);
		}

		input:checked + .switch-left {
			background-color: #4d9c41; /* #0084d0; */
			color: #fff;
			bottom: 0px;
			left: 0.5em;
			height: 2.5em;
			width: 3em;
			transform: rotate(0deg) skewX(0deg);
		}

		input:checked + .switch-left::before {
			background-color: transparent;
			width: 3.0833em;
		}

		input:checked + .switch-left + .switch-right {
			background-color: #ddd;
			color: #888;
			bottom: 0.4em;
			right: 0.8em;
			height: 2.4em;
			width: 2.75em;
			transform: rotate(-15deg) skewX(-15deg);
		}

		input:checked + .switch-left + .switch-right::before {
			background-color: #ccc;
		}

        .bookmark {
            font-family: 'Courier New', Courier, monospace;
            background-color: rgba(240, 255, 240, 0.75);
            color:black;
            margin-left:20px;
            margin-right: 20px;
            margin-bottom: 4px;
            margin-top: 8px;
            padding-left: 5px;
            padding-right: 5px;
            border-radius: 8px;
        }

	/*  select {
			font-size: 30px;
		} */

        .bg-container {
            width: 1386px;
            display: grid;
            grid-template-columns: 800px 250px 280px;
            grid-template-rows: auto;
            grid-template-areas:
                "wm jumbos prmsl"
                "utc utc utc"
                "solar solar solar"
                "wm-m wm-m wm-m"
                "wm-a wm-a wm-a"
                "gl gl gl"
                "gg gg gg"
                "botton-padding botton-padding botton-padding";
        }
        /* For the switch (slider) */
        .switch {
            position: relative;
            display: inline-block;
            width: calc(var(--slider-scale) * 60px);
            height: calc(var(--slider-scale) * 34px);
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: calc(var(--slider-scale) * 26px);
            width: calc(var(--slider-scale) * 26px);
            left: calc(var(--slider-scale) * 4px);
            bottom: calc(var(--slider-scale) * 4px);
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }

        input:checked + .slider {
            background-color: #2196f3;
        }

        input:focus + .slider {
            box-shadow: 0 0 1px #2196f3;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(calc(var(--slider-scale) * 26px));
            -ms-transform: translateX(calc(var(--slider-scale) * 26px));
            transform: translateX(calc(var(--slider-scale) * 26px));
        }

        /* Rounded sliders */
        .slider.round {
            border-radius: calc(var(--slider-scale) * 34px);
        }

        .slider.round:before {
            border-radius: 50%;
        }

        /* Switch grid */
        .switch-container {
            display: grid;
            grid-template-columns: calc(var(--slider-scale) * 80px) 200px;
        }
        .switch-element {
            place-self: flex-start;
        }

        /* Button tooltips, used below */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: silver;
            color: navy;
            text-transform: none;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            top: 150%;
            left: 50%;
            margin-left: -100px;

            /* Fade in tooltip - takes 1 second to go from 0% to 100% opac: */
            opacity: 0;
            transition: opacity 1s;
        }

        .tooltip .tooltiptext-right {
            top: -5px;
            left: 140%;
            /*width: 200px;*/
            margin-left: -60px;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            bottom: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent transparent silver transparent;
        }

        .tooltip .tooltiptext-right::after {
            content: "";
            position: absolute;
            top: 50%;
            margin-left: -110px;
            margin-top: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: transparent silver transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .button-like {
            position: relative;
            background-color: darkgrey;
            color: navy;
            border: 1px solid silver;
            border-radius: 6px;
            padding: 0 4px;
            font-size: 0.8rem;
        }

        .button-like:hover {
            box-shadow: 4px 4px 8px black, 0 0 25px white, 0 0 10px cyan;
            cursor: pointer;
        }

    </style>
</head>
<body>

<!-- A node to be cloned, for the bodies and their observed altitude -->
<div id="one-body-template" style="display: none; grid-template-columns: 30px 150px 800px; text-align: left;">
    <input type="checkbox" name="${body}" id="${body}" value="${body}"/>
    <label for="${body}">${body}</label>
    <div>On
        <input class="day" type="number" placeholder="day" min="1" max="31" title="Day of the Month">
        <select class="month" title="Month of the year">
            <option value="1">Jan</option>
            <option value="2">Feb</option>
            <option value="3">Mar</option>
            <option value="4">Apr</option>
            <option value="5">May</option>
            <option value="6">Jun</option>
            <option value="7">Jul</option>
            <option value="8">Aug</option>
            <option value="9">Sep</option>
            <option value="10">Oct</option>
            <option value="11">Nov</option>
            <option value="12">Dec</option>
        </select>
        <input class="year" type="number" placeholder="year" min="0" title="year">
        at
        <input class="hours" type="number" placeholder="hours" min="0" max="23" title="Hour of the day [0..23]">:
        <input class="minutes" type="number" placeholder="minutes" min="0" max="59" title="minutes">:
        <input class="seconds" type="number" placeholder="seconds" min="0" max="59" title="seconds"> UTC,
        Obs Alt
        <input class="alt-deg" type="number" placeholder="degrees" min="0" max="90" title="Observed Altitude in degrees">°
        <input class="alt-min" type="number" placeholder="minutes" min="0.00" max="59.99" title="minutes" size="4">'

        <a class="button-like" onclick="reverseHeightForBody(this);" title="Calculate what the altitue should be&#13;for ${body}" style="display: none; margin-left: 10px;">Reverse</a>
    </div>
</div>


    <!-- alert-dialog -->
    <dialog id="custom-alert" class="shadow-menu" style="z-index: 10;">
        <div class="dialog-header">
            <span id="alert-header">Alert Title</span>
            <span class="dialog-header-close" onclick="closeCustomAlert();">&times</span>
        </div>
        <div style="margin-bottom: 10px;" id="alert-content">
            <!-- Placeholder for message -->
        </div>
    </dialog>

    <!-- help-dialog -->
    <dialog id="help-dialog" class="shadow-menu" style="z-index: 10;">
        <div class="dialog-header">
            <span>Help!</span>
            <span class="dialog-header-close" onclick="closeHelpDialog();">&times</span>
        </div>
        <div style="margin-bottom: 10px;">
            <p>
                This page shows how to display graphical components in background, always present, even if other elements
                are displayed on top.
            </p>
            <p>
                Use the Background Parameters link in the menu to configure the globe.
            </p>
            <p>
                Use the Show/Hide Computed Data button to display the computed data in the foreground.
            </p>
            <p>
                Select the bodies you want to display the cones for (for the date YOU've set).<br/>
                You can also set the observed altitude for each body, to see how it affects the cone.<br/>
                Based on those cones, the intersection will be calculated, to find the observer's position.<br/>
                You can click on the Reverse link to calculate what the observed altitude should be for that body, from the user's position.<br/>
                For a better precision, the bearing of the selected bodies shpuld be as close to 120&deg; as possible, just like with an hand bearing compass.
            </p>
            <p>
                The Marquee panel (available from the hamburger &#8801; menu) will show the same data, formatted,
                in a dialog, on top of others.
            </p>
            <p>
                <span style="font-style: italic; font-weight: bold;">Featuring:</span>
                <ul>
                    <li>Web Components</li>
                    <li>Custom Tooltips</li>
                    <li>Custom Alerts</li>
                    <li>SVG</li>
                    <li>Celestial Calculations (all in , front and back end)</li>
                    <li>Copy-to-clipboard</li>
                    <li>etc !</li>
                </ul>
            </p>
            <p>
                Credits:<br/>
                All celestial calculations are based on <a href="https://www.celnav.de/" target="HU" style="color: cyan;">Hening Umland</a>'s remarkable work.
            </p>
        </div>
    </dialog>

    <!-- BG parameters -->
    <dialog id="background-prms-dialog" class="shadow-menu" style="z-index: 10;">
        <div class="dialog-header">
          <span>Background Parameters...</span>
          <span class="dialog-header-close" onclick="closePrmsDialog();">&times</span>
        </div>

        <div style="display: grid; grid-template-columns: auto auto; text-align: left;">
            <div>Center on: <span class="switch-element">User Position</span></div>
            <div class="switch-container" style="margin-left: -150px;" title="Sun or User">
                <label class="switch switch-element">
                  <input id="transp-slider-1" type="checkbox" onchange="switchPos(this);">
                  <span class="slider round"></span>
                </label>
                <span class="switch-element">Sun Position</span>
            </div>
        </div>

        <div style="margin-bottom: 10px;">
            <button id="now" class="tooltip" onclick="updateUTCDate();">Now
                <span class="tooltiptext">Set the date/time to the current one (aka now)</span>
            </button>&nbsp;
            <button id="compute" class="tooltip" onclick="compute();">Compute
                <span class="tooltiptext">Compute data for the date set before</span>
            </button>&nbsp;
            <!--input type="checkbox" id="auto-refresh" onchange="autoRefresh(this);"><small>Auto Refresh</small-->
            Real Time
            <div class="tooltip">
                <label class="rocker rocker-small"
                    style="margin-bottom: -15px;"> <!-- One way widget. Will NOT be notified of a change on the server. -->
                    <input type="checkbox" id="auto-refresh" onchange="autoRefresh(this);">
                    <span class="switch-left">On</span>
                    <span class="switch-right">Off</span>
                </label>
                <span class="tooltiptext">Auto-refresh the date every second.</span>
            </div>
        </div>

        <div>
            <!--
             |  WORLD MAP CTRL & Co
             +-->
            <div id="world-map-ctrl" title="Map Controls">
                <div class="black-frame centered">
                    <div class="switch-container" style="margin-left: 30px;" title="Simulate data">
                        <label class="switch switch-element">
                          <input id="transp-slider-2" type="checkbox" onchange="setSimulation(this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element" style="width: 150%; text-align: left;">Simulate Pressure and Heading</span>
                    </div>
                    <!--input type="checkbox" onchange="setTransparency('world-map-01', this);"/>Transparent -->
                    <div class="switch-container" style="margin-left: 30px;" title="Make globe transparent">
                        <label class="switch switch-element">
                          <input id="transp-slider-3" type="checkbox" onchange="setTransparency('world-map-01', this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Transparent Globe</span>
                    </div>
                    <!--input type="checkbox" onchange="setGrid('world-map-01', this);" checked/>Grid -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display grid on the map">
                        <label class="switch switch-element">
                          <input id="grid-slider" type="checkbox" onchange="setGrid('world-map-01', this);" checked>
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Display Polar Grid</span>
                    </div>
                    <!--input type="checkbox" onchange="setSun('world-map-01', this);" checked/>Sun -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display the Sun">
                        <label class="switch switch-element">
                          <input id="sun-slider" type="checkbox" onchange="setSun('world-map-01', this);" checked>
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Display Sun</span>
                    </div>
                    <!--input type="checkbox" onchange="setMoon('world-map-01', this);" checked/>Moon -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display the Moon">
                        <label class="switch switch-element">
                          <input id="moon-slider" type="checkbox" onchange="setMoon('world-map-01', this);" checked>
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Display Moon</span>
                    </div>
                    <!--input type="checkbox" onchange="setSunlight('world-map-01', this);"/>Sunlight -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display Sun light and Sun shadow">
                        <label class="switch switch-element">
                          <input id="sunlight-slider" type="checkbox" onchange="setSunlight('world-map-01', this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Display Sun Light</span>
                    </div>
                    <!--input type="checkbox" onchange="setMoonlight('world-map-01', this);"/>Moonlight -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display Moon light and Moon shadow">
                        <label class="switch switch-element">
                          <input id="moonlight-slider" type="checkbox" onchange="setMoonlight('world-map-01', this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Display Moon Light</span>
                    </div>
                    <!--input type="checkbox"
                            onchange="withWanderingBodies = this.checked; setWanderingBodies('world-map-01', this);"/>Wandering bodies -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display wandering bodies">
                        <label class="switch switch-element">
                          <input id="wb-slider" type="checkbox" onchange="withWanderingBodies = this.checked; setWanderingBodies('world-map-01', this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Wandering Bodies</span>
                    </div>
                    <!--input type="checkbox" onchange="withStars = this.checked; setStars('world-map-01', this);"/>Stars -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display stars">
                        <label class="switch switch-element">
                          <input id="stars-slider" type="checkbox" onchange="withStars = this.checked; setStars('world-map-01', this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Display Stars</span>
                    </div>
                    <!--input type="checkbox" onchange="withStars = this.checked; setStars('world-map-01', this);"/>Stars -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display constellations">
                        <label class="switch switch-element">
                          <input id="constellations-slider" type="checkbox" onchange="withConstellations = this.checked; setConstellations('world-map-01', this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">With Constellations</span>
                    </div>
                    <!--input type="checkbox" onchange="setTropics('world-map-01', this);"/>Tropics -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display polar circles and tropics">
                        <label class="switch switch-element">
                          <input id="tropic-slider" type="checkbox" onchange="setTropics('world-map-01', this);">
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Tropics &amp; Polar Circles</span>
                    </div>
                    <!--input type="checkbox" onchange="setSun('world-map-01', this);" checked/>Sun -->
                    <div class="switch-container" style="margin-left: 30px;" title="Display the Foreground Solar Date/Time">
                        <label class="switch switch-element">
                          <input id="solar-slider" type="checkbox" onchange="setSolarDate('solar-jumbo-wrapper', this);" checked>
                          <span class="slider round"></span>
                        </label>
                        <span class="switch-element">Solar Date Foreground</span>
                    </div>

                    <!--
                    <br/>
                    <input type="checkbox" id="geo-sat-01"/>GeoStationary Satellites
                    <input type="checkbox" id="iss-01" title="Requires Internet connection"/>ISS
                    <input type="checkbox" id="gps-sat-01"/>GPS Satellites in view
                    <input type="checkbox" id="moon-sun-path-01"/>Moon to Sun
                    -->
                    <!--
                    <br/>
                    <input type="radio" name="proj-01" value="GLOBE" onchange="setProjection('world-map-01', this);" checked>Globe
                    <input type="radio" name="proj-01" value="MERCATOR" onchange="setProjection('world-map-01', this);">Mercator
                    <input type="radio" name="proj-01" value="ANAXIMANDRE" onchange="setProjection('world-map-01', this);">Square
                    -->
                </div>
            </div>
        </div>

    </dialog>

    <!-- Marquee values -->
    <dialog id="marquee-dialog" class="shadow-menu" style="z-index: 10;">
        <div class="dialog-header">
            <span>Astro Data Marquee</span>
            <span class="dialog-header-close" onclick="closeMarqueeDialog();">&times</span>
        </div>
        <div style="margin-bottom: 10px;">
            <!-- See defaultMarqueeTextArray -->
            <marquee-panel id="marquee-panel-01"
                        class="marquee-01"
                        width="600"
                        height="350"
                        nb-cols="200"
                        nb-lines="68"
                        title="Computed Data"
                        display-data='{ "text-array": ["You must have", "triggered a computation", "to see something", "in here..."], "x": 4, "y": 12 }'/>
        </div>
    </dialog>

    <!-- Sun Path - Draggable dialog (drag it from the header)
        See in window.onload the
        ondragover, ondrop functions.
    -->
    <dialog id="sun-path-dialog"
            class="shadow-menu"
            style="z-index: 10; width: 470px;" >
            <!--
            draggable="true"
            ondragstart="dragStartSP(event)"
            ondrag="draggingSP(event)"> -->
        <!-- Draggable header -->
        <div class="dialog-header"
             draggable="true"
             ondragstart="dragStartSP(event)"
             ondrag="draggingSP(event)">
            <span>Sun Path</span> <!-- This is tweaked by the window.onload -->
            <span id="sun-path-header-title" style="color: rgba(255, 255, 255, 0.25);"></span>
            <span class="dialog-header-close" onclick="closeSunPathDialog();">&times</span>
        </div>
        <div style="margin-bottom: 10px;">
            <table style="width: 98%;">
                <tr>
                    <td>
                        <div class="black-frame centered">
                            <sun-path id="sun-path-01"
                                      class="sun-path-01"
                                      width="450"
                                      height="450"
                                      tilt="-10"></sun-path>
                        </div>
                    </td>
                    <td>
                        <input type="range"
                               style="-webkit-appearance: slider-vertical; width: 8px; height: 440px; margin-left: 0;"
                               min="-90"
                               max="90"
                               value="-10"
                               onchange="setNewTilt(this, 'sun-path-01');">
                     </td>
                </tr>
                <tr>
                    <td>
                        <input type="range" style="/*width: 566px;*/ width: 450px; height: 8px; margin-left: 0;"
                               min="-90"
                               max="90"
                               value="0"
                               onchange="setNewZOffset(this, 'sun-path-01');">
                    </td>
                    <td></td>
                </tr>
            </table>
        </div>
    </dialog>

    <dialog id="sky-map-dialog"
            class="shadow-menu"
            style="z-index: 10; width: 820px;" >
            <!--
            draggable="true"
            ondragstart="dragStartSP(event)"
            ondrag="draggingSP(event)"> -->
        <!-- Draggable header -->
        <div class="dialog-header"
             draggable="true"
             ondragstart="dragStartSM(event)"
             ondrag="draggingSM(event)">
            <span>Sky Map(s)</span> <!-- This is tweaked by the window.onload -->
            <span id="sky-map-header-title" style="color: rgba(255, 255, 255, 0.25);"></span>
            <span class="dialog-header-close" onclick="closeSkyMapDialog();">&times</span>
        </div>
        <div style="margin-bottom: 10px;">
            <table style="width: 98%;">
                <tr>
                    <td>
                        <div class="black-frame centered">
                            <!-- Sky Map goes here -->
                            <sky-map id="sky-map-01"
                                    class="skymap-display-01"
                                    width="800"
                                    height="500"
                                    latitude="35"/>
                        </div>
                        Type:
                        <select onchange="setMapType('sky-map-01', this);">
                            <option value="STARFINDER" selected>Star Finder</option>
                            <option value="SKYMAP">Sky Map</option>
                        </select>
                        <br/>
                        <div style="display: grid; grid-template-columns: auto auto auto auto;">
                            <span><input type="checkbox" onchange="setWithStars('sky-map-01', this);" checked>Stars.</span>
                            <span><input type="checkbox" onchange="setWithConst('sky-map-01', this);" checked>Const.</span>
                            <span><input type="checkbox" onchange="setStarNames('sky-map-01', this);" checked>Star Names.</span>
                            <span><input type="checkbox" onchange="setConstNames('sky-map-01', this);">Const Names.</span>

                            <span><input type="checkbox" onchange="setVisibleSky('sky-map-01', this);" checked>Visible sky.</span>
                            <span><input type="checkbox" onchange="setSkyGrid('sky-map-01', this);" checked>Sky grid.</span>
                            <span><input type="checkbox" onchange="setWanderingBodiesSM('sky-map-01', this);">Wandering bodies.</span>
                            <span><input type="checkbox" onchange="setAriesLHASM('sky-map-01', this);">Aries LHA.</span>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
    </dialog>

  <!--
    The Big Main Menu on the left

    ◄ = &#9668;
    ► = &#9658;
    ▼ = &#9660;
    ▲ = &#9650;
  -->
<div id="side-nav" class="sidenav" onmouseleave="closeNav()">
    <a href="javascript:void(0)" id="close-nav-button" class="closebtn" onclick="closeNav()">&times;</a>

    <a href="javascript:void(0)" class="active-link list-link" style="margin-top: 20px; margin-right: 20px; text-align: right;" onclick="showHelpDialog();">Help!</a>
    <hr style="color: rgb(192,192,192, 0.5); width: 90%;"/>
    <a href="javascript:void(0)" class="active-link list-link" style="margin-top: 20px;" onclick="showPrmsDialog();">Background parameters</a>
    <a href="javascript:void(0)" class="active-link list-link" onclick="toggleForeground();">Toggle foreground</a>
    <a href="javascript:void(0)" class="active-link list-link" onclick="showMarqueeDialog();">Marquee Panel</a>
    <hr style="color: rgb(192,192,192, 0.5); width: 90%;"/>
    <span>
        <a href="javascript:void(0)" class="active-link list-link" style="display: inline;" onclick="showSunPathDialog();" title="Can take time...&#13;Be patient.">Sun Path</a>
        <a href="javascript:void(0)" class="active-link list-link" style="display: inline;" onclick="showSkyMapDialog();" title="Can take time...&#13;Be patient.">Sky Map</a>
    </span>
    <hr style="color: rgb(192,192,192, 0.5); width: 90%;"/>
    <a href="javascript:void(0)" class="active-link" style="margin-top: 20px;">More links here, some day...</a>

    <a href="javascript:void(0)" class="active-link" style="margin-top: 20px;"><span style="font-size: 40px;" title="Call for details.">&phone;</span></a>

    <!-- More links go here if/when needed -->
</div>

<div style="display: grid; grid-template-columns: auto auto;" title="Single Page Application with Background SVG &amp; Web Components">
    <div style="vertical-align: top; margin-top: 0; font-style: normal; text-shadow: 1px 1px 2px black, 0 0 25px white, 0 0 5px silver;">
        <h1 style="cursor: pointer;" onclick="openNav()" title="Click for menu"><span style="cursor: pointer;" onclick="openNav()" onmouseover="openNav()" title="Hamburger">&nbsp; &#8801;</span> Celestial Computer <span style="font-size: 0.75em;"> - MPS for real</span></h1>
        <h3 style="margin-left: 30px; ">all in ES6, no REST back-end</h3>
    </div>
    <div style="text-align: right;"><small>Last code update Oct 18, 2025, 14:00 CET</small></div>
</div>
<div class="background bg-container"
     style="margin: 10px; margin-top: 120px; border: 2px solid rgba(0, 255, 255, 0.5); border-radius: 10px; padding-bottom: 20px;">
    <!--
        WORLD MAP BG. GLOBE
    +-->
    <div id="world-map" style="grid-area: wm; text-align: right;">
        <div class="centered" style="width: 600px; border: 0px solid silver; border-radius: 5px;">
            <world-map id="world-map-01"
                       class="worldmap-display-bg"
                       title="World Map&#13;Background"
                       with-anti-sun-moon="true"
                       width="800"
                       height="600"></world-map>
        </div>
    </div>

    <!-- JUMBO / MPS Data -->
    <div class="centered" style="grid-area: jumbos; width: 240px; border: 0px solid silver; border-radius: 5px;">

        <div style="margin-top: 50px; margin-bottom: 20px; font-weight: bold; color: rgba(0, 255, 255, 0.5);">MPS Data</div>
        <div id="mps-data-div" class="result" style="font-size: 0.75em; text-align: left; min-height: 100px; border: 1px solid silver; border-radius: 5px; padding: 10px; overflow: auto;">
            <div id="mps-data" style="width: 400%;">
                <ul>
                    <li>MPS Data goes here...</li>
                </ul>

            </div>
        </div>
        <!-- MOON PHASE and TILT -->
        <moon-phase-2 id="moon-phase-01"
                      width="180"
                      height="180"
                      title="Moon Phase"
                      phase="0"
                      tilt="0"
                      label="Moon phase"
                      small-label="..."/>
    </div>

    <!-- SCROLL-DISPLAY (PRMSL), hidden -->
    <div class="centered" style="display: none; grid-area: prmsl; width: 240px; border: 0px solid silver; border-radius: 5px;">

        <div style="margin-top: 50px; margin-bottom: 20px; font-weight: bold; color: rgba(0, 255, 255, 0.5);">PRMSL</div>
        <scroll-digit-display id="scroll-digit-display-01"
                              class="scroll-digit-01"
                              nb-char="6"
                              font-size="40"
                              justified="RIGHT"
                              nb-dec="1"
                              value="1013.5"></scroll-digit-display>
        <div style="margin-top: 50px; margin-top: 20px; font-weight: bold; color: rgba(0, 255, 255, 0.5);">Sun & Moon</div>
        <!--div id="sru-elev-z" style="margin-top: 10px; text-align: left; color: rgba(0, 255, 255, 0.5);"-->
        <div id="sru-elev-z" style="margin-top: 0px; display: grid; grid-template-columns: auto auto;">
            <!-- Sun Z -->
            <div style="text-align: left; margin: 20px 0 0 0;" id="sun-azimuth" title="Sun Azimuth">
                <div style="width: 160px; height: 160px; border: 1px solid blue; border-radius: 5px;">
                    <small>Sun Azimuth (SVG)...</small>
                </div>
            </div>
            <!-- Sun Altitude -->
            <div style="text-align: left; margin: 20px 0 0 0;" id="sun-elevation" title="Sun Elevation">
                <div style="width: 160px; height: 160px; border: 1px solid blue; border-radius: 5px;">
                    <small>Sun Elevation (SVG)...</small>
                </div>
            </div>
            <!-- Moon Z -->
            <div style="text-align: left; margin: 0 0 0 0;" id="moon-azimuth" title="Moon Azimuth">
                <div style="width: 160px; height: 160px; border: 1px solid blue; border-radius: 5px;">
                    <small>Moon Azimuth (SVG)...</small>
                </div>
            </div>
            <!-- Moon Altitude -->
            <div style="text-align: left; margin: 0 0 0 0;" id="moon-elevation" title="Moon Elevation">
                <div style="width: 160px; height: 160px; border: 1px solid blue; border-radius: 5px;">
                    <small>Moon Elevation (SVG)...</small>
                </div>
            </div>
        </div>
        <div style="text-align: left;">
            <span id="lha-sun"></span>
            <br/>
            <span id="lha-moon"></span>
        </div>
    </div>

    <div class="centered" style="grid-area: utc">
        <!-- SPLIT-FLAP UTC -->
        <div style="margin: 10px;">
            <split-flap-display id="split-flap-utc-date-display"
                                class="split-flap-night-bg"
                                nb-char="15"
                                font-size="30"
                                justified="LEFT"
                                title="UTC Date"
                                value="Mon 01 Jan 1970"></split-flap-display>

            <split-flap-display id="split-flap-utc-display"
                                class="split-flap-night-bg"
                                style="margin-left: 10px;"
                                nb-char="12"
                                font-size="30"
                                justified="LEFT"
                                title="UTC Time"
                                value="00:00:00 UTC"></split-flap-display>
        </div>
    </div>

    <div class="centered" style="grid-area: solar">
        <!-- SPLIT-FLAP Solar -->
        <div style="margin: 10px;">
            <split-flap-display id="split-flap-solar-date-display"
                                class="split-flap-night-bg"
                                nb-char="18"
                                font-size="30"
                                justified="LEFT"
                                title="Solar Date"
                                value="SOLAR: 01 Jan 1970"></split-flap-display>

            <split-flap-display id="split-flap-solar-display"
                                class="split-flap-night-bg"
                                style="margin-left: 10px;"
                                nb-char="8"
                                font-size="30"
                                justified="LEFT"
                                title="Solar Time"
                                value="00:00:00"></split-flap-display>
        </div>
    </div>

    <div style="grid-area: botton-padding; min-height: 10px;">
        <!-- Empty -->
    </div>
</div>


<div id="full-foreground" style="display: block;">
    <div style="padding: 6px; border: 0px solid rgba(0, 255, 255, 0.25); border-radius: 5px; margin-top: 50px;">
        <small>
            All renderings happen only in the browser, it generates absolutely NO network traffic,<br/>
            even MPS cones related calculations are done on the client.<br/>
            Guaranteed <b><i>0%</i></b> external libraries (100% pure organic HTML5/CSS3/ES6), no GMO.
        </small>
    </div>
    <table style="width: 96%;">
        <tr>
            <td style="vertical-align: top;" colspan="1">
                <div style="border: 0px solid rgba(0, 255, 255, 0.25); border-radius: 5px;">
                    <div id="user-help-switch" onclick="expandCollapseHelpData();" title="Click to expand/collase"
                         style="margin: 3px; padding-left: 5px; padding-right: 5px; cursor: pointer;"><span id="help-char">&#9658;</span> Help !
                        <div id="user-help-widgets" class="smooth" style="padding: 2px; border: 1px solid rgba(0, 255, 255, 0.25); border-radius: 5px;">
                            <i>How-to:</i> Use the hamburger (&#8801;) at the top left to set the background parameters (Wandering bodies, Sunlight, Real Time...)
                            <br/>
                            Then you can show or hide the computed data... And you can use the "Help" in the sliding menu.
                            <br/>
                            <!-- The "Set Position" button will also display the expected MPS cones. -->
                            <br/>
                            <h4>MPS Cones Computing</h4>
                            Select the bodies you want to display the cones for (for the date YOU've set).<br/>
                            You can also set the observed altitude for each body, to see how it affects the cone.<br/>
                            Based on those cones, the intersection will be calculated, to find the observer's position.<br/>
                            You can click on the Reverse link to calculate what the observed altitude should be for that body, from the user's position.<br/>
                            For a better precision, the bearing of the selected bodies shpuld be as close to 120&deg; as possible, just like with an hand bearing compass.
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td style="text-align: left;" colspan="1">
                <div style="border: 0px solid rgba(0, 255, 255, 0.25); border-radius: 5px;">
                    <!-- See https://unicode-table.com/en/sets/arrow-symbols/ -->
                    <div id="user-pos-switch" onclick="expandCollapseSetPosData();" title="Click to expand/collase"
                        style="margin: 3px; padding-left: 5px; padding-right: 5px; cursor: pointer;"><span id="pos-char">&#9658;</span> User's Position on Earth</div>

                    <div id="user-pos-widgets" class="smooth" style="padding: 2px; border: 1px solid rgba(0, 255, 255, 0.25); border-radius: 5px;"> <!-- display: none;  -->
                        Latitude:
                        <select id="pos-lat-sign-01">
                            <option value="N" selected>N</option> <!-- Default value -->
                            <option value="S">S</option>
                        </select>
                        <input type="number"
                            id="pos-lat-deg-01"
                            placeholder="Deg"
                            title="Lat degrees to set"
                            style="width: 40px; text-align: center;"
                            min="0"
                            max="90"
                            step="1"
                            value="37"/> <!-- Default value -->
                        <input type="number"
                            id="pos-lat-min-01"
                            placeholder="Minutes"
                            title="Lat minutes to set"
                            style="width: 60px; text-align: center;"
                            min="0"
                            max="59.99"
                            step="0.01"
                            value="44.93"/> <!-- Default value -->
                        &nbsp;&nbsp;Longitude:
                        <select id="pos-lng-sign-01">
                            <option value="E">E</option>
                            <option value="W" selected>W</option> <!-- Default value -->
                        </select>
                        <input type="number"
                            id="pos-lng-deg-01"
                            placeholder="Deg"
                            title="Lng degrees to set"
                            style="width: 40px; text-align: center;"
                            min="0"
                            max="180"
                            step="1"
                            value="122"/> <!-- Default value -->
                        <input type="number"
                            id="pos-lng-min-01"
                            placeholder="Minutes"
                            title="Lng minutes to set"
                            style="width: 60px; text-align: center;"
                            min="0"
                            max="59.99"
                            step="0.01"
                            value="30.42"/> <!-- Default value -->
                        &nbsp;&nbsp;
                        <button id="update-position"
                                class="tooltip"
                                onclick="updatePosition();"
                                style="margin-top: 3px;">Set Position
                            <span class="tooltiptext tooltiptext-right">Set position value on the map</span>
                        </button>
                        <br/>
                        <!-- Enable Geolocation APIs -->
                        <div class="switch-container" style="margin-left: 30px;" title="Enable GeoLocation APIs">
                            <label class="switch switch-element">
                              <input id="geoloc-slider" type="checkbox" onchange="setGeolocation(this);">
                              <span class="slider round"></span>
                            </label>
                            <span class="switch-element">Enable GeoLocation</span>
                        </div>
                        <div id="geo-mess" style="display: none;"><small style="font-style: italic; color: yellow;">(hit "Set Position" when GeoLocation is obtained)</small></div>

                        <div id="url-placeHolder" style="display: none;">
                            <div id="alert-zone" class="smooth" style="padding: 2px; border: 1px solid red; border-radius: 5px; padding: 5px;"> <!-- display: none;  -->
                                <div id="alert-mess" style="color: green; background-color: orange; border-radius: 5px; padding: 5px;"></div>
                            </div>

                            <div style="display: grid; grid-template-columns: auto auto auto; align-items: center; border: 1px solid rgba(128, 128, 128, 0.75); border-radius: 5px; margin: 5px; padding: 3px;">
                                <small style="text-align: right;">Bookmark this URL:</small>
                                <div id="url-to-bookmark" class="bookmark" style="white-space: nowrap; overflow-x: scroll; height: fit-content;"></div>
                                <button onclick="copyToClipboard('url-to-bookmark')" style="max-width: 55px; padding: 4px;">
                                    <img src="icons8-copy-to-clipboard-50.png" style="width: 40px; height: auto;" title="Copy URL to Clipboard">
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
            <td style="vertical-align: top; min-width: 50px; max-width: 55px; width: 50px; border: 0px solid silver; border-radius: 4px;" rowspan="2">
                <div id="moon-phase-div" style="text-align: right;" title=""></div>
            </td>
        </tr>
        <tr>
            <td style="vertical-align: top;" colspan="1">
                <div style="border: 0px solid rgba(0, 255, 255, 0.25); border-radius: 5px;">
                    <div id="user-mps-switch" onclick="expandCollapseMPSData();" title="Click to expand/collapse"
                         style="margin: 3px; padding-left: 5px; padding-right: 5px; cursor: pointer;"><span id="mps-char">&#9658;</span> Select the bodies for MPS Cones</div>
                    <div id="user-mps-widgets" class="smooth" style="width: 80%; float: left; padding: 2px; border: 1px solid rgba(0, 255, 255, 0.25); border-radius: 5px;">
                        <div style="display: grid; grid-template-columns: auto auto;">
                            <div>
                                Select the bodies, and provide the observed altitude and observation (UTC) time.
                                <!-- input type="checkbox" id="enable-reverse" onchange="enableReverseCalc(this);"><small>Enable reverse calc.</small-->
                                <div class="switch-container" style="margin-left: 30px;" title="Enable Reverse Calculation for Altitudes">
                                    <label class="switch switch-element">
                                        <input id="enable-reverse" type="checkbox" onchange="enableReverseCalc(this);">
                                        <span class="slider round"></span>
                                    </label>
                                    <span class="switch-element" style="width: 150%; text-align: left;">Enable Reverse Calculation</span>
                                </div>
                            </div>
                            <button id="calc-mps-position"
                                    class="tooltip"
                                    onclick="calculateMPS();"
                                    style="margin-top: 3px;">Calculate Position
                                <span class="tooltiptext">Calculate position&#13;with cone data</span>
                            </button>
                        </div>

                        <div id="bodies-container" class="" style="padding: 10px; max-height: 200px; display: grid; /*grid-area: prmsl;*/ max-width: 840px; border: 1px solid silver; border-radius: 5px; margin-top: 10px; overflow-y: scroll; overflow-x: scroll;">
                            <!-- populated by populateBodyList() -->
                        </div>
                    </div>
                </div>
            </td>
        </tr>
        <tr>
            <td style="vertical-align: top;" colspan="1">
                <div style="border: 0px solid rgba(0, 255, 255, 0.25); border-radius: 5px;">
                    <div id="user-date-switch" onclick="expandCollapseDateData();" title="Click to expand/collapse"
                        style="margin: 3px; padding-left: 5px; padding-right: 5px; cursor: pointer;"><span id="date-char">&#9658;</span> UTC Date, and options</div>

                    <div id="user-date-widgets" class="smooth" style="padding: 2px; border: 1px solid rgba(0, 255, 255, 0.25); border-radius: 5px;">
                        <small>Enter UTC date and time, then click the Compute button (in the background parameters).</small>
                        <div>
                            <input class="day" type="number" id="UTC-day" placeholder="day" min="1" max="31" title="Day of the Month">
                            <select class="month" id="UTC-month" title="Month of the year">
                                <option value="1">Jan</option>
                                <option value="2">Feb</option>
                                <option value="3">Mar</option>
                                <option value="4">Apr</option>
                                <option value="5">May</option>
                                <option value="6">Jun</option>
                                <option value="7">Jul</option>
                                <option value="8">Aug</option>
                                <option value="9">Sep</option>
                                <option value="10">Oct</option>
                                <option value="11">Nov</option>
                                <option value="12">Dec</option>
                            </select>
                            <input class="year" type="number" id="UTC-year" placeholder="year" min="0" title="year">
                            at
                            <input class="day" type="number" id="UTC-hour" placeholder="hours" min="0" max="23" title="Hour of the day [0..23]">:
                            <input class="day" type="number" id="UTC-minute" placeholder="minutes" min="0" max="59" title="minutes">:
                            <input class="day" type="number" id="UTC-second" placeholder="seconds" min="0" max="59" title="seconds"> UTC
                        </div>
                        <div>
                            <!-- Nice sliders -->
                            <!--input type="checkbox" id="no-planet"><small>Skip planets calculations</small-->
                            <div class="switch-container" style="margin-left: 30px; margin-top: 10px;" title="Planet Calculation">
                                <label class="switch switch-element">
                                  <input id="no-planet" type="checkbox">
                                  <span class="slider round"></span>
                                </label>
                                <span class="switch-element"><small>Skip planets calculations</small></span>
                            </div>
                            <!--input type="checkbox" id="no-star"><small>Skip stars calculations</small-->
                            <div class="switch-container" style="margin-left: 30px;" title="Star Calculation">
                                <label class="switch switch-element">
                                  <input id="no-star" type="checkbox">
                                  <span class="slider round"></span>
                                </label>
                                <span class="switch-element"><small>Skip stars calculations</small></span>
                            </div>
                            <!--input type="checkbox" id="verbose" onchange="verbose(this);"><small>Console Verbose</small-->
                            <div class="switch-container" style="margin-left: 30px;" title="Console verbose">
                                <label class="switch switch-element">
                                  <input id="verbose" type="checkbox" onchange="verbose(this);">
                                  <span class="slider round"></span>
                                </label>
                                <span class="switch-element"><small>Console verbose</small></span>
                            </div>
                        </div>
                    </div>
                </div>
            </td>
        </tr>
    </table>
    <h2 style="margin-left: 10px; color: rgba(255, 255, 255, 0.5);" id="simulation-div"></h2>

    <button class="tooltip" onclick="showHideData();" style="margin: 10px;">Show/Hide Computed Data
        <span class="tooltiptext">Computed data will show below</span>
    </button>

    <div id="solar-jumbo-wrapper" class="black-frame" style="border: 2px solid cyan; width: 400px; margin-left: 10px;">
        <jumbo-plus-display id="jumbo-plus-01"
                            class="jumbo-plus-transparent"
                            title="Solar Date and Time"
                            value="01-JAN-1970|00:00:00"
                            label="Solar Date & Time"
                            width="400"
                            height="140"></jumbo-plus-display>
    </div>

    <div id="raw-data" style="display: none;">
        <div id="result" class="result"></div>

        <div id="details" class="result" style="background-color: rgba(0,0,0,0.5);"></div>
    </div>
</div>

</body>
<script type="text/javascript">

    const MONTHS = [ "JAN", "FEB", "MAR", "APR", "MAY", "JUN",
                     "JUL", "AUG", "SEP", "OCT", "NOV", "DEC" ];
    const DELTA_T = 69.2201; // Will be re-calculated

    let consoleVerbose = false;

    // Compute and display
    let compute = () => {

        let calculationData = {
            utcyear: parseInt(document.getElementById('UTC-year').value),
            utcmonth: parseInt(document.getElementById('UTC-month').value),
            utcday: parseInt(document.getElementById('UTC-day').value),
            utchour: parseInt(document.getElementById('UTC-hour').value),
            utcminute: parseInt(document.getElementById('UTC-minute').value),
            utcsecond: parseInt(document.getElementById('UTC-second').value),
            deltaT: DELTA_T,
            noPlanets: document.getElementById('no-planet').checked,
            noStars: !document.getElementById('no-star').checked
        };

        let astroResult = astroMain(calculationData); // in astro.js
        globalAstroData = astroResult;  // Now includes the solar date.
        if (consoleVerbose) {
            console.log("Calculation done %d-%d-%d %d:%d:%d UTC :", calculationData.utcyear, calculationData.utcmonth, calculationData.utcday, calculationData.utchour, calculationData.utcminute, calculationData.utcsecond);
            console.log("Result:\n", JSON.stringify(astroResult, null, 2));
        }

        if (userSunPos) { // Use SUN position
            // console.log("Setting user pos from the sun...");
            setUserPos(globalAstroData.sun.DEC.raw, ghaToLongitude(globalAstroData.sun.GHA.raw)); // from globalAstroData
        }

        // SRU - Sight Reduction Utility
        try {
            let sruSun = sightReduction(userPos.latitude, userPos.longitude, astroResult.sun.GHA.raw, astroResult.sun.DEC.raw);
            globalSRUSun = sruSun;
            // document.getElementById('sru-elev-z').innerHTML =
            //     `SUN<br/>Elev: ${sru.alt.toFixed(2)}&deg;<br/>Z: ${sru.Z.toFixed(1)}&deg;`;

            // hp, semi-diam (upper-lower limb), refraction, horizon depression
            if (false) {
                const LOWER_LIMB = 1;
                const UPPER_LIMB = 2;

                let horizonDip = getHorizonDip(1.80); // 1.80 meters above the surface
                let refraction = '-';
                if (sruSun.alt > 0) {
                    refraction = getRefraction(sruSun.alt);
                }
                let hp = astroResult.sun.HP.raw; // in seconds of arc
                let limb = LOWER_LIMB;
                let sd = 0;
                if (limb === LOWER_LIMB) {
                    sd = astroResult.sun.SD.raw; // in seconds of arc.
                }
                if (limb === UPPER_LIMB) {
                    sd = -astroResult.sun.SD.raw; // in seconds of arc.
                }

                console.log(`Sun SD: ${sd / 60.0}', dip:${horizonDip}', refraction:${refraction}', HP: ${hp / 60.0}'`);
                let apparentCorrection = (sd / 60.0) - horizonDip;
                let totalCorrection = apparentCorrection - (isNaN(refraction) ? 0 : refraction) + (hp / 60.0);
                console.log(`Apparent Correction (SD - Horizon Dip): ${apparentCorrection.toFixed(2)}'`);
                console.log(`Total Correction (App Correction - refraction + hp): ${totalCorrection.toFixed(2)}'`);
                console.log("Total Correction: to be ADDED to the instrumental (measured) elevation.");
            }

            // Background data display
            if (!isNaN(sruSun.Z)) {
                drawArrow('sun-azimuth', sruSun.Z, 'Sun');
            }
            // Sun Altitude: json.CELESTIAL_DATA.elevation
            if (!isNaN(sruSun.alt)) {
                drawElevation('sun-elevation', sruSun.alt);
            }
            let sruMoon = sightReduction(userPos.latitude, userPos.longitude, astroResult.moon.GHA.raw, astroResult.moon.DEC.raw);
            globalSRUMoon = sruMoon;
            if (!isNaN(sruMoon.Z)) {
                drawArrow('moon-azimuth', sruMoon.Z, 'Moon');
            }
            // Moon Altitude: json.CELESTIAL_DATA.elevation
            if (!isNaN(sruMoon.alt)) {
                drawElevation('moon-elevation', sruMoon.alt, '#ffffff', '#808080');
            }
        } catch (error) {
            console.debug(error);
        }

        // LHA Sun & Moon. userPos.longitude & globalAstroData.[sun-moon].GHA.raw
        let lhaSun  = calcLHA(globalAstroData.sun.GHA.raw, userPos.longitude);
        let lhaMoon = calcLHA(globalAstroData.moon.GHA.raw, userPos.longitude);
        // console.log(`LHA Sun : ${decToSex(lhaSun)}`);
        // console.log(`LHA Moon: ${decToSex(lhaMoon)}`);
        document.getElementById('lha-sun').innerText = `LHA Sun: ${decToSex(lhaSun)}`;
        document.getElementById('lha-moon').innerText = `LHA Moon: ${decToSex(lhaMoon)}`;

        document.getElementById('result').innerHTML = '<pre>' + JSON.stringify(astroResult, null, 2) + '</pre>';
        // More here, ...
        let detailsContent =
            " Sun     : GHA: " + astroResult.sun.GHA.fmt + ", RA: " + astroResult.sun.RA.fmt + ", Dec: " + astroResult.sun.DEC.fmt + ", sd:" + astroResult.sun.SD.fmt + ", hp:" + astroResult.sun.HP.fmt + "\n" +
            " Moon    : GHA: " + astroResult.moon.GHA.fmt + ", RA: " + astroResult.moon.RA.fmt + ", Dec: " + astroResult.moon.DEC.fmt + ", sd:" + astroResult.moon.SD.fmt + ", hp:" + astroResult.moon.HP.fmt + "\n" +
            "     Moon Phase:" + astroResult.moon.phase.phaseAngle + "&deg;, " + astroResult.moon.phase.phase + "\n" +
            ` LHA Sun : ${decToSex(lhaSun)}\n` +
            ` LHA Moon: ${decToSex(lhaMoon)}\n`;

        if (!document.getElementById('no-planet').checked) {
            detailsContent +=
                " Venus   : GHA: " + astroResult.venus.GHA.fmt + ", RA: " + astroResult.venus.RA.fmt + ", Dec: " + astroResult.venus.DEC.fmt + ", sd:" + astroResult.venus.SD.fmt + ", hp:" + astroResult.venus.HP.fmt + "\n" +
                " Mars    : GHA: " + astroResult.mars.GHA.fmt + ", RA: " + astroResult.mars.RA.fmt + ", Dec: " + astroResult.mars.DEC.fmt + ", sd:" + astroResult.mars.SD.fmt + ", hp:" + astroResult.mars.HP.fmt + "\n" +
                " Jupiter : GHA: " + astroResult.jupiter.GHA.fmt + ", RA: " + astroResult.jupiter.RA.fmt + ", Dec: " + astroResult.jupiter.DEC.fmt + ", sd:" + astroResult.jupiter.SD.fmt + ", hp:" + astroResult.jupiter.HP.fmt + "\n" +
                " Saturn  : GHA: " + astroResult.saturn.GHA.fmt + ", RA: " + astroResult.saturn.RA.fmt + ", Dec: " + astroResult.saturn.DEC.fmt + ", sd:" + astroResult.saturn.SD.fmt + ", hp:" + astroResult.saturn.HP.fmt + "\n" +
                "\n" +
                " Polaris : GHA: " + astroResult.polaris.GHA.fmt + ", RA: " + astroResult.polaris.RA.fmt + ", Dec: " + astroResult.polaris.DEC.fmt + "\n";
        }
        if (!document.getElementById('no-star').checked) {
            // TODO Display star data ?
            // Calculate SRU for stars
            if (astroResult.stars !== undefined) {
                globalSRUStars = [];
                astroResult.stars.forEach(star => {
                    // console.log(`Computing SRU for ${star.name}`);
                    let sruStar = sightReduction(userPos.latitude, userPos.longitude, star.gha, star.decl);
                    globalSRUStars.push({name: star.name, h: sruStar.alt, z: sruStar.Z });
                    // console.log('Done');
                });
            } else {
                globalSRUStars = undefined;
            }
        }
        detailsContent +=
            " Equation of time: " + astroResult.EOT.fmt + "\n" +
            " Lunar Distance: " + astroResult.lunarDist.fmt + "\n" +
            " Day of Week: " + astroResult.dayOfWeek;

        document.getElementById('details').innerHTML = '<pre>' + detailsContent + '</pre>';

        /* Moon Phase and illum, redundant with moon phase web-comp */
        /*
        try {
            if (astroResult.moon.phase.phaseAngle !== undefined) {
                let phaseIndex = Math.floor(astroResult.moon.phase.phaseAngle / (360 / 28.5)) + 1;
                if (phaseIndex > 28) {
                    phaseIndex = 1;
                }
                let phaseImageName = `moon/phase${(phaseIndex < 10 ? '0' : '') + phaseIndex}.gif`;
                if (consoleVerbose) {
                    console.log('Loading ', phaseImageName);
                }
                let phaseDivImage = document.getElementById('moon-phase-div');
                phaseDivImage.innerHTML =
                    `<img src='${phaseImageName}' alt='${astroResult.moon.phase.phaseAngle}' title='Phase ${astroResult.moon.phase.phaseAngle.toFixed(0) + '&deg'}&#13;Illum ${astroResult.moon.illum.toFixed(0) + '%'}'><br/><small>Phase&nbsp;${astroResult.moon.phase.phaseAngle.toFixed(0) + '&deg'}<br/>Illum&nbsp;${astroResult.moon.illum.toFixed(0) + '%'}</small>`;
                // phaseDivImage.title = `Phase ${astroResult.moon.phase.phaseAngle.toFixed(0)}\272`;
            }
        } catch (oops) {
            console.log(oops);
        }
        */
        // Update World Map
        displayWorldData(transformDataForWorldWebComp(astroResult));
        // Update Calendar
        let utcOffsetInMinutes = new Date().getTimezoneOffset();
        let utcTime = new Date(astroResult.epoch + (utcOffsetInMinutes * 60 * 1000)); // .getUTCDate();

//      let date = utcTime.format("d-m-Y-l");
        let date = utcTime.format("D d M Y");
        let splitFlapDate = document.getElementById('split-flap-utc-date-display');
        splitFlapDate.value = date;
        splitFlapDate.repaint();

        // let calendar = document.getElementById('calendar-01');
        // calendar.value = date;
        // calendar.repaint();
        // Update UTC time
        let time = utcTime.format("H:i:s");
        let splitFlap = document.getElementById('split-flap-utc-display');
        splitFlap.value = time + " UTC";
        splitFlap.repaint();

        // Solar date and time if available
        let solarDate = astroResult.solarDate;
        let splitFlapSolarDate = document.getElementById('split-flap-solar-date-display'); // Date
        splitFlapSolarDate.value = `SOLAR: ${lpad(solarDate.day.toFixed(0), '0', 2)} ${MONTHS[solarDate.month - 1]} ${solarDate.year.toFixed(0)}`;
        splitFlapSolarDate.repaint();

        let splitFlapSolar = document.getElementById('split-flap-solar-display'); // Time
        splitFlapSolar.value = `${lpad(solarDate.hour.toFixed(0), '0', 2)}:${lpad(solarDate.minute.toFixed(0), '0', 2)}:${lpad(solarDate.second.toFixed(0), '0', 2)}`;
        splitFlapSolar.repaint();

        // Big Jumbo
        let bigUTCJumbo = document.getElementById('jumbo-plus-01');
        bigUTCJumbo.value = `${lpad(solarDate.day.toFixed(0), '0', 2)} ${MONTHS[solarDate.month - 1]} ${solarDate.year.toFixed(0)}` +
                            `|${lpad(solarDate.hour.toFixed(0), '0', 2)}:${lpad(solarDate.minute.toFixed(0), '0', 2)}:${lpad(solarDate.second.toFixed(0), '0', 2)}`;
        bigUTCJumbo.label = 'Solar, from ' + // 'Solar Date & Time from ' +
            decToSex(userPos.latitude, "NS") + " / " +
            decToSex(userPos.longitude, "EW");
        bigUTCJumbo.repaint();

        // Moon-tilt
        // userPos.latitude, userPos.longitude
        let moonTilt = getMoonTilt({lat: userPos.latitude, lng: userPos.longitude},
							{gha: astroResult.sun.GHA.raw, dec: astroResult.sun.DEC.raw},
							{gha: astroResult.moon.GHA.raw, dec: astroResult.moon.DEC.raw});
        // console.log(`Moon Tilt: ${moonTilt}`);
        let moonPhase = document.getElementById('moon-phase-01');
        moonPhase.phase = astroResult.moon.phase.phaseAngle;
        moonPhase.tilt = moonTilt;
        let illum = `${astroResult.moon.illum.toFixed(0)} %`;
        moonPhase.title = `Tilt:${moonTilt.toFixed(1)}°\nIllum:${illum}`; // Update tooltip
		// Update small label
		moonPhase.smallLabel = `Tilt:${moonTilt.toFixed(1)}°`;
    };

    let updateUTCDate = () => {
        let now = new Date();
        document.getElementById('UTC-day').value = now.getUTCDate();
        document.getElementById('UTC-month').value = now.getUTCMonth() + 1;
        document.getElementById('UTC-year').value = now.getUTCFullYear();
        document.getElementById('UTC-hour').value = (now.getUTCHours().toString().length < 2 ? "0" : "") + now.getUTCHours();
        document.getElementById('UTC-minute').value = (now.getUTCMinutes().toString().length < 2 ? "0" : "") + now.getUTCMinutes();
        document.getElementById('UTC-second').value = (now.getUTCSeconds().toString().length < 2 ? "0" : "") + now.getUTCSeconds();
    };

    let enableReverseCalc = (cb) => {
        let buttons = document.querySelectorAll('#bodies-container a.button-like');
        buttons.forEach(b => {
            b.style.display = cb.checked ? 'inline-block' : 'none';
            if (cb.checked) {
                // console.log("Enabling reverse calculation for body:", b.parentNode.parentNode.querySelector('label').innerText);
                b.setAttribute("title", `Reverse calculation\nfor ${b.parentNode.parentNode.querySelector('label').innerText}`);
            }
        });
    };

    let reverseHeightForBody = (button) => {

        // This calculation happens on the Client (in ES6).

        let body = button.parentNode.parentNode.querySelector('label').innerText;
        let year = parseInt(button.parentNode.querySelector(".year").value);
        let month = parseInt(button.parentNode.querySelector(".month").value);
        let day = parseInt(button.parentNode.querySelector(".day").value);
        let hours = parseInt(button.parentNode.querySelector(".hours").value);
        let minutes = parseInt(button.parentNode.querySelector(".minutes").value);
        let seconds = parseInt(button.parentNode.querySelector(".seconds").value);

        let UTCDuration = `${year.toFixed(0)}-${month.toFixed(0).padStart(2,'0')}-${day.toFixed(0).padStart(2,'0')}T${hours.toFixed(0).padStart(2,'0')}:${minutes.toFixed(0).padStart(2,'0')}:${seconds.toFixed(0).padStart(2,'0')}`;

        let calculationData = {
            utcyear: year,
            utcmonth: month,
            utcday: day,
            utchour: hours,
            utcminute: minutes,
            utcsecond: seconds,
            deltaT: DELTA_T,
            noPlanets: false,
            noStars: false
        };

        let computed = astroMain(calculationData); // in astro.js
        if (consoleVerbose) {
            console.log("Calculation done %d-%d-%d %d:%d:%d UTC :", calculationData.utcyear, calculationData.utcmonth, calculationData.utcday, calculationData.utchour, calculationData.utcminute, calculationData.utcsecond);
            console.log("Result:\n", JSON.stringify(computed, null, 2));
        }

        let gha = 0, dec = 0;
        switch (body) {
            case 'Sun':
                gha = computed.sun.GHA.raw;
                dec = computed.sun.DEC.raw;
                break;
            case 'Moon':
                gha = computed.moon.GHA.raw;
                dec = computed.moon.DEC.raw;
                break;
            case 'Venus':
                gha = computed.venus.GHA.raw;
                dec = computed.venus.DEC.raw;
                break;
            case 'Mars':
                gha = computed.mars.GHA.raw;
                dec = computed.mars.DEC.raw;
                break;
            case 'Jupiter':
                gha = computed.jupiter.GHA.raw;
                dec = computed.jupiter.DEC.raw;
                break;
            case 'Saturn':
                gha = computed.saturn.GHA.raw;
                dec = computed.saturn.DEC.raw;
                break;
            default:
                let theStar = computed.stars.filter(star => {
                    return star.name == body;
                });
                if (theStar && theStar[0]) {
                    gha = theStar[0].gha;
                    dec = theStar[0].decl;
                }
                break;
        }

        // SRU - Sight Reduction Utility
        try {
            let sru = sightReduction(userPos.latitude, userPos.longitude, gha, dec);
            // console.log(`${body} at ${UTCDuration}, H: ${sru.alt}`);

            button.parentNode.querySelector(".alt-deg").value = Math.trunc(sru.alt);
            button.parentNode.querySelector(".alt-min").value = ((sru.alt - Math.trunc(sru.alt)) * 60.0).toFixed(2);
        } catch (err) {
            console.error(err);
        }
    };

    let interval = undefined;
    const INTERVAL = 1000;

    let autoRefresh = (cb) => {
        document.getElementById('compute').disabled = cb.checked;
        document.getElementById('now').disabled = cb.checked;
        if (cb.checked) {
            interval = window.setInterval(() => {
                updateUTCDate();
                compute();
            }, INTERVAL);
        } else {
            window.clearInterval(interval);
        }
    };

    let verbose = (cb) => {
        consoleVerbose = cb.checked;
    };

    let getQueryParameterByName = (name, url) => {
        if (!url) {
            url = window.location.href;
        }
        name = name.replace(/[\[\]]/g, "\\$&");
        let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) {
            return null;
        }
        if (!results[2]) {
            return '';
        }
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    };

    function setScrollDigitValue(id, value) {
        let elem = document.getElementById(id);
        // Character by character
        let original = elem.paddedValue;
        let newPaddedValue = elem.getPaddedValue(elem.cleanString(value));
        //        console.log("Old [%s], new [%s]", original, newPaddedValue);
        //        assert(old.length === new.length);
        let floatFrom = parseFloat(original);
        let floatTo = parseFloat(newPaddedValue);
        let sign = 0;
        if (floatFrom !== floatTo) {
            sign = (floatTo > floatFrom) ? +1 : -1;
        }
        let scroll = Math.abs(floatFrom - floatTo) <= Math.pow(10, -elem.nbDec);

        function updateValue(idx) { // Now THIS is balaise.
            if (original.charAt(idx).toUpperCase() !== newPaddedValue.charAt(idx).toUpperCase()) {
                setTimeout(() => {
                    let next = elem.getNextChar(original.charAt(idx), sign);
//                                        console.log("Updating %s with %s", original, next);
                    elem.setCharAt(idx, next, sign);
                    original = elem.paddedValue;
                    updateValue(idx); // Recursive call
                }, 50);
            }
        }

        if (scroll || true) {
            if (sign !== 0) {
                for (let idx = 0; idx < original.length; idx++) {
                    updateValue(idx);
                }
            }
        } else { // No scroll
            elem.value = value;
            elem.repaint();
        }
    }

    let hdg = 0.0;
    let prmsl = 1013.5;

    function plotConeBase(context, worldMap, color, circleData) {

        circleData.circle.forEach((pt) => {
            let point = pt.point;
            if (worldMap.projection.type === 'GLOBE') {
                let p = worldMap.getPanelPoint(point.latitude, point.longitude);
                if (worldMap.isBehind(worldMap.toRadians(point.latitude), worldMap.toRadians(point.longitude - worldMap.globeViewLngOffset))) {
                    return; // Behind the globe
                }
                // TODO Try worldMap.lineFromTo ?
                worldMap.fillCircle(context, p, 1.5, color); // A dot on the circle
                // worldMap.plotPoint(context, pt, color, 1.5);
            } else {
                worldMap.plotPosToCanvas(context, point.latitude, point.longitude, "", color, 0.75);
            }
        });
    }

    const rhoE = 635677; // Earth radius, in 100s of km. It's 6356.77 km.
    const earthRadiusNM = (rhoE / 100.0) / 1.852; // Earth radius, in nm.

    function plotCone(context, worldMap, color, coneColor, data) {

        if (worldMap.projection.type === 'GLOBE') {
            // The cone's axis
            let pg = worldMap.getPanelPoint(data.pg.latitude, data.pg.longitude);
            // console.log(`Plotting cone for ${data.bodyName} at pg (${pg.x}, ${pg.y}, lat: ${data.pg.latitude}, lng: ${data.pg.longitude})`);
            context.save();
            let thisPointIsBehind = worldMap.isBehind(Math.toRadians(data.pg.latitude), Math.toRadians(data.pg.longitude - worldMap.globeViewLngOffset));
            if (!thisPointIsBehind || worldMap.transparentGlobe) {
                // Draw Body
                worldMap.plot(context, pg, color);
                context.fillStyle = color;
                context.fillText(data.bodyName, Math.round(pg.x) + 3, Math.round(pg.y) - 3);
                // Arrow, to the Body
                context.setLineDash([2]);
                context.strokeStyle = color;
                context.beginPath();
                let center = worldMap.getPanelPoint(worldMap.userPosition.latitude, worldMap.userPosition.longitude);
                context.moveTo(center.x, center.y);
                context.lineTo(pg.x, pg.y);
                context.stroke();
                context.closePath();
                context.setLineDash([0]); // Reset
                context.strokeStyle = color;
                let deltaX = pg.x - center.x;
                let deltaY = pg.y - center.y;
                context.beginPath();
                context.moveTo(pg.x, pg.y);
                // Cone summit offset
                console.log(`Dist to summit ${data.earthCenterToConeSummit} nm`);

                let distToSummitRatio = data.earthCenterToConeSummit / earthRadiusNM; // in nm

                // context.lineTo(pg.x + deltaX, pg.y + deltaY); // To the cone's summit
                context.lineTo(center.x + (deltaX * distToSummitRatio), center.y + (deltaY * distToSummitRatio)); // The summit
                context.stroke();
                context.closePath();
                let summitX = center.x + (deltaX * distToSummitRatio);
                let summitY = center.y + (deltaY * distToSummitRatio);

                // The cone itself
                context.strokeStyle = coneColor; // Cone color
                data.circle.forEach((pt) => {
                    let point = pt.point;
                    let p = worldMap.getPanelPoint(point.latitude, point.longitude);
                    if (worldMap.isBehind(worldMap.toRadians(point.latitude), worldMap.toRadians(point.longitude - worldMap.globeViewLngOffset))) {
                        return; // Behind the globe
                    }
                    context.beginPath();
                    context.moveTo(summitX, summitY); // The cone's summit
                    context.lineTo(p.x, p.y);         // The cone's base
                    context.stroke();
                    context.closePath();
                });
                context.fillStyle = 'lime'; // Summit color
                // context.strokeStyle = 'lime';
                context.beginPath();
                worldMap.fillCircle(context, {x: summitX, y: summitY}, 5, 'lime'); // The summit
                context.fillText('S ' + data.bodyName, Math.round(summitX) + 3, Math.round(summitY) - 3);
                context.stroke();
                context.closePath();
            }
            context.restore();
        } else {
            worldMap.plotPosToCanvas(context, data.pg.latitude, data.pg.longitude, data.bodyName, color, 2);
        }
    }

    let extraDrawingWorldMap = (wm, context) => {

        // https://www.w3schools.com/tags/canvas_arc.asp

        let width = wm.width;
        let height = wm.height;
        let radius = (height / 2) * 0.9;

        context.beginPath();

        // External Compass Circle
        context.arc(width / 2, height / 2, radius, 0, 2 * Math.PI, false);
		context.lineWidth = 3;

        context.strokeStyle = 'rgba(0, 255, 255, 0.25)'; // Circle
		context.stroke();
		context.closePath();

        let numberTicks = 30;
        let majorTicks  = 10;
        let minorTicks  =  1;

        context.beginPath();
		for (let i = 0; i < 360; i += majorTicks) {
			let heading = i - hdg;
			let xFrom = (width / 2) - ((radius * 0.95) * Math.cos(2 * Math.PI * (heading / 360)));
			let yFrom = (height / 2) - ((radius * 0.95) * Math.sin(2 * Math.PI * (heading / 360)));
			let xTo = (width / 2) - ((radius * 0.85) * Math.cos(2 * Math.PI * (heading / 360)));
			let yTo = (height / 2) - ((radius * 0.85) * Math.sin(2 * Math.PI * (heading / 360)));
			context.moveTo(xFrom, yFrom);
			context.lineTo(xTo, yTo);
		}
		context.lineWidth = 3;
		context.strokeStyle = 'rgba(0, 255, 255, 0.25)'; // Major ticks
		context.stroke();
		context.closePath();

		// Minor Ticks
		if (minorTicks > 0) {
			context.beginPath();
			for (let i = 0; i <= 360; i += minorTicks) {
				let heading = i - hdg;
				let xFrom = (width / 2) - ((radius * 0.95) * Math.cos(2 * Math.PI * (heading / 360)));
				let yFrom = (height / 2) - ((radius * 0.95) * Math.sin(2 * Math.PI * (heading / 360)));
				let xTo = (width / 2) - ((radius * 0.90) * Math.cos(2 * Math.PI * (heading / 360)));
				let yTo = (height / 2) - ((radius * 0.90) * Math.sin(2 * Math.PI * (heading / 360)));
				context.moveTo(xFrom, yFrom);
				context.lineTo(xTo, yTo);
			}
			context.lineWidth = 1;
			context.strokeStyle = 'rgba(0, 255, 255, 0.25)'; // Minor ticks
			context.stroke();
			context.closePath();
		}
		// Numbers
        let digitColor = 'rgba(0, 255, 255, 0.5)'; // Numbers
		context.beginPath();
		let scale = 1;
		for (let i = 0; i < 360; i += numberTicks) {
			let heading = i - hdg;
			context.save();
			context.translate(width / 2, (height / 2));
			context.rotate((2 * Math.PI * (heading / 360)));
			context.font = "bold " + Math.round(scale * 15) + "px Arial"; // Like "bold 15px Arial"
			context.fillStyle = (i === 0) ? 'cyan' : digitColor;
			let str = i.toString();
			let len = context.measureText(str).width;
			context.fillText(str, -len / 2, (-(radius * .8) + 10));
			context.lineWidth = 1;
			context.strokeStyle = 'rgba(0, 255, 255, 0.5)';           // Numbers
			context.strokeText(str, -len / 2, (-(radius * .8) + 10)); // Outlined
			context.restore();
		}
		context.closePath();

        // Required cone definitions

        // Get obsAlt, GHA, D from the REST services, for given body, given UTC.
        let utcyear = parseInt(document.getElementById('UTC-year').value);
        let utcmonth = parseInt(document.getElementById('UTC-month').value);
        let utcday = parseInt(document.getElementById('UTC-day').value);
        let utchour = parseInt(document.getElementById('UTC-hour').value);
        let utcminute = parseInt(document.getElementById('UTC-minute').value);
        let utcsecond = parseInt(document.getElementById('UTC-second').value);

        let UTCDuration = `${utcyear.toFixed(0)}-${utcmonth.toFixed(0).padStart(2,'0')}-${utcday.toFixed(0).padStart(2,'0')}T${utchour.toFixed(0).padStart(2,'0')}:${utcminute.toFixed(0).padStart(2,'0')}:${utcsecond.toFixed(0).padStart(2,'0')}`;
        console.log(`UTC Duration: ${UTCDuration}`);

        // Find the cones to plot
        let container = document.getElementById("bodies-container");
        let selected = container.querySelectorAll('input[type="checkbox"]:checked');

        let coneColors = [
            {
                one: "yellow",
                two: "rgba(255, 222, 33, 0.4)"
            },
            {
                one: "red",
                two: "rgba(255, 0, 33, 0.4)"
            },
            {
                one: "lime",
                two: "rgba(0, 255, 33, 0.4)"
            },
            {
                one: "cyan",
                two: "rgba(0, 255, 255, 0.4)"
            }

        ];

        // let payloads_1 = [];
        let payloads_2 = [];

        selected.forEach((cb, idx) => {
            console.log(`Selected ${cb.value}`);
            // Date and obs altitude
            let body = cb.value;
            let day = parseInt(cb.parentNode.querySelector('input.day').value);
            let month = parseInt(cb.parentNode.querySelector('select.month').value);
            let year = parseInt(cb.parentNode.querySelector('input.year').value);
            let hour = parseInt(cb.parentNode.querySelector('input.hours').value);
            let minute = parseInt(cb.parentNode.querySelector('input.minutes').value);
            let second = parseInt(cb.parentNode.querySelector('input.seconds').value);
            let obsAltDeg = parseFloat(cb.parentNode.querySelector('input.alt-deg').value);
            let obsAltMin = parseFloat(cb.parentNode.querySelector('input.alt-min').value);
            let obsAlt = obsAltDeg + (obsAltMin / 60.0);

            let UTCObsTime = `${year.toFixed(0)}-${month.toFixed(0).padStart(2,'0')}-${day.toFixed(0).padStart(2,'0')}T${hour.toFixed(0).padStart(2,'0')}:${minute.toFixed(0).padStart(2,'0')}:${second.toFixed(0).padStart(2,'0')}`;
            // console.log(`For ${body}: ${year}-${month}-${day} ${hour}:${minute}:${second} (${UTCObsTime}), obsAlt: ${obsAltDeg}°${obsAltMin}' (${obsAlt}°)`);

            // THE calculation is going to be done here (GHA, D), for the cones display (not the position !)
            fetchDataForBody(body, UTCObsTime, (payload) => { // This is the callback

                /* callback's payload like:
                    {
                        "hp": 0.0024363295653005066,
                        "sd": 0.2658602388843899,
                        "gha": 260.9130769856097,
                        "d": -1.345999030567647
                    }
                */
                let gha = payload.gha;
                let dec = payload.d;
                console.log(`For ${body} - GHA: ${gha.toFixed(2)}°, Dec: ${dec.toFixed(2)}°`);

                let colorOne = coneColors[idx % coneColors.length].one; // Base
                let colorTwo = coneColors[idx % coneColors.length].two; // Cone itself (generatrices)

                if (true) {
                    let conePayload = {
                        bodyName : body,
                        obsAlt : obsAlt,
                        gha : gha,
                        d : dec
                    };

                    fetchConeData(conePayload, json => {
                        console.log("Cone data received");
                        // console.log(json);
                        let latlngs = json;
                        // Draw the data on the globe
                        // The circle (cone base)
                        plotConeBase(context, wm, colorOne, latlngs);
                        // The axis of the cone
                        plotCone(context, wm, colorOne, colorTwo, latlngs);
                        // Graphs
                        // plotGraphLat('graph-latitude', 'orange', latlngs, graphDataLat);
                        // plotGraphLng('graph-longitude', 'orange', latlngs, graphDataLng);
                    });
                }

            }); // End of fetchDataForBody

            payloads_2.push({
                        bodyName: body,
                        date: UTCObsTime,
                        obsAlt: obsAlt,
                        gha: null,
                        decl: null
                    });

            // Get the cones from userPos, body, UTC (reverse of above)
            let payload = {
                bodyName: cb.value,
                utcDate: UTCObsTime, // UTCDuration, // User set date
                pos: {
                    latitude: userPos.latitude,
                    longitude: userPos.longitude
                }
            };

            let colorOne = coneColors[idx % coneColors.length].one; // Base
            let colorTwo = coneColors[idx % coneColors.length].two; // Cone itself (generatrices)

            // This one uses the User's position + body + UTC to get the cone data
            fetchConeDataV2(payload, json => { // With a callback
                console.log("Cone data received - fetchConeDataV2");
                // console.log(json);
                let latlngs = json;
                // MSP Data ? (in the text box)
                let mpsData = document.getElementById('mps-data');
                let before = mpsData.innerHTML;
                let newData = `- <b>${latlngs.bodyName}</b>, Pg ${decToSex(latlngs.pg.latitude, "NS")} / ${decToSex(latlngs.pg.longitude, "EW")}, ` +
                                `Obs Alt: ${decToSex(latlngs.obsAlt)}, at ${latlngs.observationTime}`;
                if (before.length > 0) {
                    newData = before + '<br/>' + newData;
                }
                mpsData.innerHTML = newData;
            });
        }); // End of selected.forEach

        // Now calculate intersections if we have more than 1 body selected
        console.log(`-- Bodies selected: ${selected.length}, payloads: ${payloads_2.length}`);
        // Wait until numbers are equal
        let waitForPayloads = setInterval(() => {
            console.log(`==> In the loop: Bodies selected: ${selected.length}, payloads: ${payloads_2.length}`);
            if (payloads_2.length === selected.length) {
                clearInterval(waitForPayloads);
                console.log("All payloads ready, calling intersections");
                // console.log("Payloads: ", JSON.stringify(payloads_2, null, 2));
                if (payloads_2.length > 1) {
                    computeCones(payloads_2);
                } else {
                    console.log(`Not enough payloads to compute intersections (have ${payloads_2.length}, need 2+)`);
                }
            }
        }, 500);
        // console.log(`Behind the loop: Bodies selected: ${selected.length}, payloads: ${payloads.length}`);

        // Clean MPS Data box
        let mpsData = document.getElementById('mps-data');
        mpsData.innerHTML = ''; // Clear previous data
    };

    let isWithin90degrees = (userZ, bodyZ) => { // May need some tweaks...
        let rightLimit = (userZ + 90) % 360;
        let leftLimit = (userZ - 90) % 360;

        if (rightLimit < leftLimit) {
            rightLimit += 360;
            if (bodyZ < 180) {
                bodyZ += 360;
            }
        }
        // console.log(`Is ${bodyZ} in [${leftLimit}..${rightLimit}]`);
        return (bodyZ <= rightLimit && bodyZ >= leftLimit);
    }

    let extraDrawingSunPath = (sp, context) => {
        // console.log("Extra Sun Path drawings");
        // globalAstroData
        try {
            let withStars = document.getElementById("stars-slider").checked;
            if (withStars && globalAstroData.stars !== undefined) {
                console.log(`Will plot ${globalAstroData.stars.length} stars`);
                // Stars like {name: 'Altair', decl: 8.93591555402763, gha: 304.71130394967025}
                // Need to have He and Z for each star, in globalSRUStars
                console.log(`${globalSRUStars.length} items in globalSRUStars`);
                // TODO Get those two (center & radius) from the sp context...
                let center = {
                    x: sp.canvas.width / 2,
                    y: sp.canvas.height / 2
                };
                let radius = (sp.canvas.width / 2) * .8;

                // Draw forward / backwards half circle...
                if (globalSRUStars.length > 0) {
                    context.save()
                    context.strokeStyle = 'orange'; // sp.sunPathColorConfig.gridColor;
                    context.beginPath();
                    context.moveTo(center.x + (-1 * radius), center.y);
                    for (let beta = 0; beta <= 180; beta += 1) { // 0-180, top only
                        let x = radius * (Math.sin(Math.toRadians(beta - 90)));
                        let y = radius * (Math.cos(Math.toRadians(beta - 90)));
                        context.lineTo(center.x + x, center.y - y);
                    }
                    context.lineTo(center.x +(-1 * radius), center.y); // Close the semi-circle
                    context.stroke();
                    context.closePath();
                    context.restore();
                }
                // Plot the stars
                globalSRUStars.forEach(star => {
                    if (star.h !== undefined && star.z !== undefined && star.h >= 0) {
                        let z = 180 - sp._zOffset; // The "heading" of the user.
                        if (sp.invertX == -1) { // Pointing north
                            z = - sp._zOffset;
                        }
                        while (z < 0) {
                            z += 360;
                        }
                        // Do not display stars behind...
                        if (isWithin90degrees(z, star.z)) { // (star.z > (z - 90) && star.z < (z + 90)) {
                            sp.plotCelestialBody(context, center, radius, 'white', 'white', star.h, star.z, star.name, false);
                        }
                    }
                });
            }
        } catch (err) {
            console.log(`Oops: ${JSON.stringify(err)}`);
        }
    };

    let extraDrawingSkyMap = (sm, context) => {
        // UTC Date
        let utcOffsetInMinutes = new Date().getTimezoneOffset();
        let utcTime = new Date(globalAstroData.epoch + (utcOffsetInMinutes * 60 * 1000)); // .getUTCDate();

//      let date = utcTime.format("d-m-Y-l");
        let date = utcTime.format("D d M Y");
        let time = utcTime.format("H:i:s");
        let UTCDate = date + ' ' + time + " UTC";

        context.fillStyle = sm.skyMapColorConfig.ariesLabelColor;
		context.font = "bold 16px Arial"; // "bold 40px Arial"
        let displayData = UTCDate;
        let metrics = context.measureText(displayData);
        context.fillText(displayData, sm._width - metrics.width - 10, 18); // this._height - 60);

        // LHA Aries Axis angle
        if (sm.type === 'STARFINDER' && sm.ariesLHA) {
            context.save();
            context.beginPath();

            let ariesLHAAngle = sm.LHAAries;
            let radius = Math.min(sm.width, sm.height) * 0.99 / 2;

            let rad = Math.toRadians(ariesLHAAngle * sm._hemisphere);

            let xFrom = (sm.canvas.width / 2);
            let yFrom = (sm.canvas.height / 2);
            let xTo = (sm.canvas.width / 2) - ((radius * 0.98) * Math.cos(rad - (1 * Math.PI / 2)));
            let yTo = (sm.canvas.height / 2) - ((radius * 0.98) * Math.sin(rad - (1 * Math.PI / 2)));
            context.moveTo(xFrom, yFrom);
            context.lineTo(xTo, yTo);

            context.lineWidth = 2;
            context.strokeStyle = 'cyan'; // this.skyMapColorConfig.ticksColor;
            context.stroke();
            context.closePath();
            context.restore();
        }
    };

    function populateBodyList(json) {
        // console.log(JSON.stringify(json, null, 2));

        let now = new Date();

        let template = document.getElementById('one-body-template'); // the one to clone
        let container = document.getElementById('bodies-container');
        container.innerHTML = '';
        json.forEach(body => {
            // console.log(`Body [${body}]`);
            let clone = template.cloneNode(true);
            clone.style.display = 'grid';
            clone.id = `body-${body}`;
            let cb = clone.querySelectorAll("input[type='checkbox']")[0];
            cb.name = body;
            cb.id = body;
            cb.value = body;
            let label = clone.querySelectorAll("label")[0];
            label.for = body;
            label.innerText = body;

            // Set date to Now.
            clone.querySelectorAll("input.day")[0].value = now.getUTCDate();
            clone.querySelectorAll("select.month")[0].value = now.getUTCMonth() + 1;
            clone.querySelectorAll("input.year")[0].value = now.getUTCFullYear();
            clone.querySelectorAll("input.hours")[0].value = (now.getUTCHours().toString().length < 2 ? "0" : "") + now.getUTCHours();
            clone.querySelectorAll("input.minutes")[0].value = (now.getUTCMinutes().toString().length < 2 ? "0" : "") + now.getUTCMinutes();
            clone.querySelectorAll("input.seconds")[0].value = (now.getUTCSeconds().toString().length < 2 ? "0" : "") + now.getUTCSeconds();

            container.appendChild(clone);
        });
    }

    function messManager(err, mess) {
        // console.error(mess);
        // alert(mess); // JSON.stringify(mess, null, 2));
        if (mess) {
            showCustomAlert(err, mess);
        } else {
            alert(err)
        }
    }

	function fetchBodyList() {
        let json = MPSToolBox.getBodyList();
        populateBodyList(json);
	}

    // curl -X POST http://localhost:9999/mps/getcone -d '{"bodyName":"Saturn","utcDate":"2025-10-05T07:45:00","pos":{"latitude":47.677667,"longitude":-3.135667}}'
    // Requires bodyName, utcDate, and user's position
	function fetchConeDataV2(payload, callback) {
		let headers = [ {name: 'Accept', value: 'application/json'}];
		let getData = getPromise('/mps/getcone',
                                DEFAULT_TIMEOUT,
                                'POST',
                                [200, 201], // Can be an array
                                payload,    // JSON.stringify(payload),  // data
                                false,      // show traffic
                                headers);
		getData.then((value) => {
         // console.log("Done:", value);
			try {
				if (value.length > 0) {
					let json = JSON.parse(value);
					// console.log(JSON.stringify(json, null, 2));
                    console.log(`Body:${json.bodyName}, at ${json.observationTime}, Alt ${decToSex(json.obsAlt)}`);
                    // alert('Got the cone!!');
                    if (callback) {
                        callback(json);
                    } else {
                        console.log("No callback for fetchConeDataV2");
                    }
				} else {
					console.log('Empty response');
				}
			} catch (error) {
				console.error('For data', value);
				console.error(error);
			}
		}, (error, errmess) => {
			let message = "";
			if (errmess) {
				let mess = JSON.parse(errmess);
				if (mess.message) {
					message += mess.message;
				}
			}
			messManager("fetchConeDataV2 : Failed to get bodies data..." + (error ? (typeof(error) === 'object' ? JSON.stringify(error, null, 2) : error.toString()) : ' - ') + ', ' + (message.length > 0 ? message : ' - '));
			// events.publish('valid', null);
		});
	}

    // curl -X POST http://localhost:9999/mps/cone -d '{"bodyName":"Saturn","obsAlt":22.276078,"gha":54.653345,"d":-3.048023}'
    // Requires bodyName, obsAlt, gha, d
	function fetchConeData(payload, callback) {

        let bodyName = payload.bodyName;
        let obsAlt = payload.obsAlt;
        let gha = payload.gha;
        let d = payload.d;

        let fromZ = 0, toZ = 360, zStep = 1; // TODO Get those from input payload ?..
		let coneDefinition = MPSToolBox.calculateCone(obsAlt, gha, d, bodyName, fromZ, toZ, zStep, false);
        if (callback) {
            callback(coneDefinition);
        } else {
            console.log(`No callback in fetchConeData for ${JSON.stringify(coneDefinition, null, 2)}`);
        }
	}

    // curl -X POST http://localhost:9999/mps/alt-and-z -d '{"pos":{"latitude":47.677667,"longitude":-3.135667},"pg":{"gha":230.905951,"d":-1.313542}}'
    function fetchAltAndZ(payload) {
        // From Pos and Pg
        let altNz = MPSToolBox.getAltNZ(payload);
        console.log("Bam!");
        alert('Got the Body Alt and Z!!\n' + JSON.stringify(altNz));
    }

    // curl -X GET http://localhost:9999/mps/pg/Sun/2025-09-26T03:15:00
    function fetchDataForBody(body, utcdate, callback) {
        let bodyData = MPSToolBox.getBodyData(body, utcdate);
        if (callback) {
            callback(bodyData);
        } else {
            console.log("Not callback for fetchDataForBody");
            console.log(`Got ${JSON.stringify(bodyData, null, 2)}`);
        }
    }

    // curl -X POST http://localhost:9999/mps/compute-cones -d '[
    //              {"bodyName" : "Mars","date" : "2025-10-07T15:36:00","gha" : null,"decl" : null,"obsAlt" : 21.942333333333334},
    //              {"bodyName" : "Venus","date" : "2025-10-07T15:36:00","gha" : null,"decl" : null,"obsAlt" : 14.014},
    //              {"bodyName" : "Altair","date" : "2025-10-07T15:36:00","gha" : null,"decl" : null,"obsAlt" : 32.47716666666667}
    //  ]'
    // Returns the calculated position
    function computeCones(payload) {

	    let computedPos = MPSToolBox.computeConesIntersection(payload, false);
        let mess = `Calculated intersection:<br/>` +
                    `<b>${decToSex(computedPos.latitude, "NS")} / ${decToSex(computedPos.longitude, "EW")}</b>`;
        let mpsData = document.getElementById('mps-data');
        let before = mpsData.innerHTML;
        let newData = mess;
        if (before.length > 0) {
            newData = before + '<br/>' + newData;
        }
        mpsData.innerHTML = newData;

        messManager("Calculated intersection", `<b>${decToSex(computedPos.latitude, "NS")} / ${decToSex(computedPos.longitude, "EW")}</b>`);
    }

    // Set default date values, start process(es), etc
    window.onload = () => {

        console.log('On Load, ready...');

        // let mpsToolBox = new MPSToolBox();
        MPSToolBox.welcome();

        // Populate the available celestial bodies
        fetchBodyList(); // See this code for details... Populates the list of bodies for the MPS cones.

        updateUTCDate();
        // Check QS for location
        let qsLat = getQueryParameterByName('lat');
        let qsLong = getQueryParameterByName('long');
        if (qsLat !== null && qsLong !== null) {
            let latitude = parseFloat(qsLat);
            let longitude = parseFloat(qsLong);

            setUserPos(latitude, longitude);
            updateFromUserPos();
        }

        document.getElementById("world-map-01").setDoAfter(extraDrawingWorldMap);
        document.getElementById("sun-path-01").setDoAfter(extraDrawingSunPath);
        document.getElementById("sky-map-01").setDoAfter(extraDrawingSkyMap);

        initAjax(); // ISS Station?

        document.ondragover = (event) => { // Used for Sun-Path and Sky-Map dialogs
            // console.log("On drag Over");
            event.preventDefault();
        };

        document.ondrop = (event) => { // Used for Sun-Path and Sky-Mao dialogs
            // console.log("On drop");
            event.preventDefault();
            let data = event.dataTransfer.getData("drag-data"); // Set in dragStartSP, dragStartSM
            console.log("Dropped -> ", data);
            // event.target.appendChild(document.getElementById(data));
            // document.getElementById("demo").innerHTML = "The SunPath dialog was dropped";
        };

        document.getElementById('sun-path-header-title').innerText = (navigator.userAgent.indexOf("Chrome") > -1 ? "(draggable header)" : "");
        document.getElementById('sky-map-header-title').innerText = (navigator.userAgent.indexOf("Chrome") > -1 ? "(draggable header)" : "");

        console.log('On Load, done!');
    };
</script>
</html>