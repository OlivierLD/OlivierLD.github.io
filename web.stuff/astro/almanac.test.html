<!DOCTYPE html>
<!--
 | All the skill in the "compute" function below,
 | Invoked on click.
 |
 | Do look into the <script type="module" src="app.js"></script>
 +-->
<html lang="en_US">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/jpg" href="./palm.04.jpg">
    <title>Celestial Computer - Almanac test</title>
    <script type="module" src="app.js"></script>
    <style>
h1 {
    color: silver;
    font-family: Verdana,sans-serif;
    font-style: italic;
}

body {
    font-family: Verdana,sans-serif;
}

.day {
    width: 40px;
    text-align: center;
}

.year {
    width: 80px;
    text-align: center;
}

.result {
    margin-top: 10px;
    border: solid silver 2px;
    border-radius: 5px;
    /*width: 80%;*/
    height: 200px;
    max-height: 200px;
    font-family: "Courier New",sans-serif;
    overflow-y: auto;
}

.grid-container {
  display: grid;
  grid-template-columns: 2fr 1fr;
  padding: 10px;
  margin: auto;
}
* {
    font-family: 'Courier New', Courier, monospace;
}
td {
    border: 1px solid silver;
    padding: 0 5px 0 5px;
    text-align: right;
}
th {
    border: 1px solid silver;
    padding: 0 5px 0 5px;
}

table.no-border td {
    border: none;
    padding: 0 5px 0 5px;
    text-align: left;
}

.sub-title {
    font-style: italic;
    font-weight: bold;
    color: blue;
}
    </style>
</head>
<body>
<h1>Almanac Test, ES6 Celestial Computer</h1>
<h2>Compute Sun Almanac for one day</h2>
<table class="no-border">
    <tr>
        <td style="vertical-align: top;">
            <small>Enter UTC date to start from, then click the Compute button.</small>
            <div>
                <input class="day" type="number" id="UTC-day" placeholder="day" min="1" max="31" title="Day of the Month">
                <select class="month" id="UTC-month" title="Month of the year">
                    <option value="1">Jan</option>
                    <option value="2">Feb</option>
                    <option value="3">Mar</option>
                    <option value="4">Apr</option>
                    <option value="5">May</option>
                    <option value="6">Jun</option>
                    <option value="7">Jul</option>
                    <option value="8">Aug</option>
                    <option value="9">Sep</option>
                    <option value="10">Oct</option>
                    <option value="11">Nov</option>
                    <option value="12">Dec</option>
                </select>
                <input class="year" type="number" id="UTC-year" placeholder="year" min="0" title="year">
                <!-- at
                <input class="day" type="number" id="UTC-hour" placeholder="hours" min="0" max="23" title="Hour of the day [0..23]">:
                <input class="day" type="number" id="UTC-minute" placeholder="minutes" min="0" max="59" title="minutes">:
                <input class="day" type="number" id="UTC-second" placeholder="seconds" min="0" max="59" title="seconds"> UTC
                -->
            </div>
            <div style="vertical-align: middle;">
                For <input type="radio" name="duration" value="one-day" checked>One Day 
                    <input type="radio" name="duration" value="one-week">One Week
                    <input type="radio" name="duration" value="one-month">One Month
                    <input type="radio" name="duration" value="one-year">One Year
            </div>
            <div>
                <input type="checkbox" id="verbose" onchange="verbose(this);"><small>Console Verbose</small>
            </div>
            <button id="now" onclick="updateUTCDate();" title="Update time to current time">Today</button>&nbsp;
            <button id="compute" onclick="compute();">Compute</button>&nbsp;
        </td>
    </tr>
</table>
<div id="final-result">
</div>

</body>
</html>
<script type="text/javascript">

    const DELTA_T = 69.2201; // Will be re-calculated

    let consoleVerbose = false;

    let lpad = (str, pad, len) => {
        while (str.length < len) {
            str = pad + str;
        }
        return str;
    };

    let decToSex = (val, ns_ew) => {
        let absVal = Math.abs(val);
        let intValue = Math.floor(absVal);
        let dec = absVal - intValue;
        let i = intValue;
        dec *= 60; //    let s = i + "°" + dec.toFixed(2) + "'";
        //    let s = i + String.fromCharCode(176) + dec.toFixed(2) + "'";
    
        let s = ""; // sign
    
        if (ns_ew !== undefined) {
            if (val < 0) {
                s += ns_ew === 'NS' ? 'S' : 'W';
            } else {
                s += ns_ew === 'NS' ? 'N' : 'E';
            }
            s += " ";
        } else {
            if (val < 0) {
                s += '-';
            }
        }
    
        s += i + "°" + dec.toFixed(2) + "'";
        return s;
    };


    const MONTHS = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
    const DAYS = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];

    let formatDate = (date) => {
        let month = MONTHS[date.getMonth()];
        let day = DAYS[date.getDay()];
        return `${day}, ${month} ${date.getDate()}, ${date.getFullYear()}`;
    };

    let decimalHoursToHMS = (decHours) => {
		let hours = Math.floor(decHours);
		let min = (decHours - hours) * 60;
		let sec = (min - Math.floor(min)) * 60;
		return `${lpad(hours, '0', 2)}:${lpad(Math.floor(min), '0', 2)}:${lpad(sec.toFixed(3), '0', 6)}`;
    }


    let compute = () => {

        let durationElements = document.getElementsByName("duration");
        let duration = 'dunno';
        for (let i=0; i < durationElements.length; i++) {
            if (durationElements[i].checked) {
                duration = durationElements[i].value;
                break;
            }
        }
        console.log(`Duration: ${duration}`);

        let today = { // Start date
            year: parseInt(document.getElementById('UTC-year').value),
            month: parseInt(document.getElementById('UTC-month').value),
            day: parseInt(document.getElementById('UTC-day').value)
        };

        let calDate = new Date(`${today.year}-${today.month}-${today.day} 00:00:00`);
        let endDate;
        switch (duration) {
            case 'one-day':
                endDate = new Date();
                endDate.setDate(calDate.getDate() + 1);
                break;
            case 'one-week':
                endDate = new Date();
                endDate.setDate(calDate.getDate() + 7);
                break;
            case 'one-month':
                let nextMonth = today.month + 1;
                if (nextMonth > 12) {
                    nextMonth = 1;
                    endDate = new Date(`${today.year + 1}-${nextMonth}-${today.day}`); // Watch it, 30, 31, 28, 29...
                } else {
                    endDate = new Date(`${today.year}-${nextMonth}-${today.day}`); // Watch it, 30, 31, 28, 29...
                }
                break;
            case 'one-year':
                endDate = new Date(`${today.year + 1}-${today.month}-${today.day}`);
                break;
            default:
                break;
        }
        endDate.setHours(0);
        endDate.setMinutes(0);
        endDate.setSeconds(0);
        endDate.setMilliseconds(0);
        console.log(`End Date : ${endDate}`);

        let fullHTMLContent = "";

        let keepWorking = true;

        while (keepWorking) {

            keepWorking = (calDate < endDate);
            console.log(`${calDate} < ${endDate} ? ... keep working: ${keepWorking}`);

            if (keepWorking) {

                today = { // Start date
                    year: calDate.getFullYear(),
                    month: calDate.getMonth() + 1, // [0..11]
                    day: calDate.getDate()
                };

                let htmlContentSunMoonAries = "";
                let htmlContentPlanets = "";
                let htmlContentSemiDiamAndCo = "";

                const now = new Date(`${today.year}-${today.month}-${today.day}`);
                htmlContentSunMoonAries += `<h2> ${ formatDate(now) }</h2>`;
                htmlContentSunMoonAries += "<table style='margin: auto;'>";
                htmlContentSunMoonAries += "<tr><th rowspan='2'>UT</th><th colspan='5'>Sun</th><th colspan='6'>Moon</th><th>Aries</th><th rowspan='2'>UT</th></tr>";
                htmlContentSunMoonAries += "<tr><th>GHA</th><th>&delta;GHA</th><th>SHA</th><th>Decl</th><th>d</th><th>GHA</th><th>&delta;GHA</th><th>SHA</th><th>Decl</th><th>d</th><th>hp (&Pi;)</th><th>GHA</th></tr>";

                htmlContentPlanets += "<table style='margin: auto;'>";
                htmlContentPlanets += "<tr><th rowspan='2'>UT</th><th colspan='3'>Venus</th><th colspan='3'>Mars</th><th colspan='3'>Jupiter</th><th colspan='3'>Saturn</th><th rowspan='2'>UT</th></tr>";
                htmlContentPlanets += "<tr><th>GHA</th><th>SHA</th><th>Decl</th><th>GHA</th><th>SHA</th><th>Decl</th><th>GHA</th><th>SHA</th><th>Decl</th><th>GHA</th><th>SHA</th><th>Decl</th></tr>";

                // htmlContentSemiDiamAndCo += "<table>";

                let prevSunGHA, prevSunDecl, prevMoonGHA, prevMoonDecl;

                for (let hours=0; hours<24; hours++) {
                    let calculationData = {
                        utcyear: today.year,
                        utcmonth: today.month,
                        utcday: today.day,
                        utchour: hours,
                        utcminute: 0,
                        utcsecond: 0,
                        deltaT: DELTA_T, /// Recalculated
                        noPlanets: false
                    };

                    // The heart of the system
                    let calcResult = sampleMain(calculationData); // in app.js
                    if (consoleVerbose) {
                        console.log("Calculation done %d-%d-%d %d:%d:%d UTC :", calculationData.utcyear, calculationData.utcmonth, calculationData.utcday, calculationData.utchour, calculationData.utcminute, calculationData.utcsecond);
                        console.log("Result:\n", JSON.stringify(calcResult, null, 2));
                    }

                    let ut = lpad(hours.toFixed(0), '0', 2);
                    let sunGHA = decToSex(calcResult.sun.GHA.raw); // calcResult.sun.GHA.fmt;
                    let moonGHA = decToSex(calcResult.moon.GHA.raw); // calcResult.sun.GHA.fmt;

                    let deltaSunGHA = "";
                    let deltaSunDecl = "";
                    let deltaMoonGHA = "";
                    let deltaMoonDecl = "";

                    let moonHp = `${(calcResult.moon.HP.raw / 60).toFixed(4)}'`;

                    if (prevSunGHA) {
                        let delta = calcResult.sun.GHA.raw - prevSunGHA;
                        while (delta < 0) {
                            delta += 360;
                        }
                        deltaSunGHA = `${delta.toFixed(4)}&deg;`;
                    }
                    if (prevSunDecl) {
                        let delta = Math.abs(calcResult.sun.DEC.raw - prevSunDecl);
                        // while (delta < 0) {
                        //     delta += 360;
                        // }
                        delta *= 60.0; // in minutes
                        deltaSunDecl = `${delta.toFixed(4)}'`;
                    }
                    if (prevMoonGHA) {
                        let delta = calcResult.moon.GHA.raw - prevMoonGHA;
                        while (delta < 0) {
                            delta += 360;
                        }
                        deltaMoonGHA = `${delta.toFixed(4)}&deg;`;
                    }
                    if (prevMoonDecl) {
                        let delta = Math.abs(calcResult.moon.DEC.raw - prevMoonDecl);
                        // while (delta < 0) {
                        //     delta += 360;
                        // }
                        delta *= 60.0; // in minutes
                        deltaMoonDecl = `${delta.toFixed(4)}'`;
                    }

                    prevSunGHA = calcResult.sun.GHA.raw;
                    prevMoonGHA = calcResult.moon.GHA.raw;
                    prevSunDecl = calcResult.sun.DEC.raw;
                    prevMoonDecl = calcResult.moon.DEC.raw;

                    let sunRA = decToSex(calcResult.sun.RA.raw);
                    let sunDecl = decToSex(calcResult.sun.DEC.raw, "NS"); // calcResult.sun.DEC.fmt;

                    let moonRA = decToSex(calcResult.moon.RA.raw);
                    let moonDecl = decToSex(calcResult.moon.DEC.raw, "NS"); // calcResult.sun.DEC.fmt;

                    let ariesGHA = decToSex(calcResult.aries.GHA.raw); // calcResult.aries.GHA.fmt;

                    htmlContentSunMoonAries += (`<tr><td style='font-weight: bold;'>${ut}</td><td>${sunGHA}</td><td>${deltaSunGHA}</td><td>${sunRA}</td><td>${sunDecl}</td><td>${deltaSunDecl}</td>` + 
                                                    `<td>${moonGHA}</td><td>${deltaMoonGHA}</td><td>${moonRA}</td><td>${moonDecl}</td><td>${deltaMoonDecl}</td><td>${moonHp}</td><td>${ariesGHA}</td>` + 
                                                    `<td style='font-weight: bold;'>${ut}</td></tr>`);

                    let venusGHA = decToSex(calcResult.venus.GHA.raw);
                    let venusRA = decToSex(calcResult.venus.RA.raw);
                    let venusDecl = decToSex(calcResult.venus.DEC.raw, "NS");

                    let marsGHA = decToSex(calcResult.mars.GHA.raw);
                    let marsRA = decToSex(calcResult.mars.RA.raw);
                    let marsDecl = decToSex(calcResult.mars.DEC.raw, "NS");

                    let jupiterGHA = decToSex(calcResult.jupiter.GHA.raw);
                    let jupiterRA = decToSex(calcResult.jupiter.RA.raw);
                    let jupiterDecl = decToSex(calcResult.jupiter.DEC.raw, "NS");

                    let saturnGHA = decToSex(calcResult.saturn.GHA.raw);
                    let saturnRA = decToSex(calcResult.saturn.RA.raw);
                    let saturnDecl = decToSex(calcResult.saturn.DEC.raw, "NS");

                    htmlContentPlanets += (`<tr><td style='font-weight: bold;'>${ut}</td><td>${venusGHA}</td><td>${venusRA}</td><td>${venusDecl}</td>` + 
                                                                                    `<td>${marsGHA}</td><td>${marsRA}</td><td>${marsDecl}</td>` + 
                                                                                    `<td>${jupiterGHA}</td><td>${jupiterRA}</td><td>${jupiterDecl}</td>` + 
                                                                                    `<td>${saturnGHA}</td><td>${saturnRA}</td><td>${saturnDecl}</td>` + 
                                                    `<td style='font-weight: bold;'>${ut}</td></tr>`);

                    if (hours === 12) {
                        let semiDiamSun = (calcResult.sun.SD.raw / 60).toFixed(4);
                        let sunHP = (calcResult.sun.HP.raw / 60).toFixed(4);
                        let semiDiamMoon = (calcResult.moon.SD.raw / 60).toFixed(4);
                        let moonPhase = `${calcResult.moon.illum.toFixed(2)}% ${calcResult.moon.phase.phase}`;
                        let phaseIndex = Math.floor(calcResult.moon.phase.phaseAngle / (360 / 28.5)) + 1;
                        let phaseImageName = `./moon/phase${(phaseIndex < 10 ? '0' : '') + phaseIndex}.gif`;

                        let tPassSun = decimalHoursToHMS(12 - (calcResult.EOT.raw / 60));
                        let moonAge = (calcResult.moon.phase.phaseAngle * 28 / 360);

                        htmlContentSemiDiamAndCo += (
                            `<tr><td colspan='14'>&nbsp;</td></tr>` +
                            `<tr>` + 
                                `<td rowspan='3'></td>` + 
                                `<td colspan='2'>&frac12;&nbsp;\u2300 ${semiDiamSun}'</td>` + 
                                `<td colspan='3'>hp (&pi;) ${sunHP}'</td>` + 
                                `<td colspan='3'>&frac12;&nbsp;\u2300 ${semiDiamMoon}'</td>` + 
                                `<td colspan='2'>${moonPhase}</td>` + 
                                `<td rowspan='3' colspan='2'><img src='${phaseImageName}' alt='${calcResult.moon.phase.phaseAngle}' title='${calcResult.moon.phase.phaseAngle + '&deg'}'>` +
                                `<td rowspan='3'></td>` + 
                            `</tr>` +
                            `<tr><td colspan='5'>EoT at 12:00 UTC : ${calcResult.EOT.fmt}</td><td colspan='5'>Phase at 12:00 UTC : ${calcResult.moon.phase.phaseAngle.toFixed(2)}&deg;</td></tr>` +
                            `<tr><td colspan='5'>Meridian Pass. Time : ${tPassSun}</td><td colspan='5'>Age : ${moonAge.toFixed(1)} day(s)</td></tr>` 
                        );
                    }

                }

                htmlContentSunMoonAries += htmlContentSemiDiamAndCo ; // Add it to the same table

                htmlContentSunMoonAries += "</table>";
                htmlContentPlanets += "</table>";
                // htmlContentSemiDiamAndCo += "</table>";

                fullHTMLContent += ("<div class='page-break'><hr/></div>" + "<br/>" + (
                    htmlContentSunMoonAries + "<br/>" + 
                    /* htmlContentSemiDiamAndCo + "<br/>" + */
                    htmlContentPlanets 
                ));

                // document.getElementById("final-result").innerHTML = (
                //     htmlContentSunMoonAries + "<br/>" + 
                //     /* htmlContentSemiDiamAndCo + "<br/>" + */
                //     htmlContentPlanets 
                // );

            } // End keepWorking

            calDate.setDate(calDate.getDate() + 1); // One more day

            // Fix this...
            document.getElementById("final-result").innerHTML = (
                fullHTMLContent + ("<div class='page-break'><hr/></div>")
            );
        }
    };

    let updateUTCDate = () => {
        let now = new Date();
        document.getElementById('UTC-day').value = now.getUTCDate();
        document.getElementById('UTC-month').value = now.getUTCMonth() + 1;
        document.getElementById('UTC-year').value = now.getUTCFullYear();
        // document.getElementById('UTC-hour').value = (now.getUTCHours().toString().length < 2 ? "0" : "") + now.getUTCHours();
        // document.getElementById('UTC-minute').value = (now.getUTCMinutes().toString().length < 2 ? "0" : "") + now.getUTCMinutes();
        // document.getElementById('UTC-second').value = (now.getUTCSeconds().toString().length < 2 ? "0" : "") + now.getUTCSeconds();
    };

    let verbose = (cb) => {
        consoleVerbose = cb.checked;
    };

    if (Math.toRadians === undefined) {
        Math.toRadians = deg => {
            return (deg / 180) * Math.PI;
        };
    }

    // XMLNS Required.
    const XMLNS = "http://www.w3.org/2000/svg";

    // Set default date values
    window.onload = () => {

        console.log('On Load, ready.');
        updateUTCDate();
        console.log('On Load, done.');

    };
</script>
