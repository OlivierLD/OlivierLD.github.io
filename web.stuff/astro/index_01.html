<!DOCTYPE html>
<!--
 | All the skill in the "compute" function below,
 | invoked on click.
 +-->
<html lang="en_US">
<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/jpg" href="./palm.04.jpg">
    <title>Test page for Celestial Computer</title>
    <script type="module" src="app.js"></script>

    <script type="module" src="./webcomponents/WorldMap.js"></script>

    <script type="text/javascript">
// Temporary function

let displayWorldData = () => {
    let worldMap = document.getElementById('world-map-01');

    // Set user position!!
    worldMap.setUserPosition({ longitude: -122.507,latitude: 37.7489});

let data = {
    "epoch": 1624126558000,
    "deltaT": 72.40674257812496,
    "sun": {
        "decl": 23.430845632793943,
        "gha": 93.62233450179929
    },
    "moon": {
        "decl": -3.794373279639114,
        "gha": 342.6860771916642
    },
    "moonPhase": 110.75500121334002,
    "ghaAries": 182.18085948138707,
    "moonToSunSkyRoute": [
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -40.03905652294609,
                    "z": 57.230621188911165
                }
            },
            "p": {
                "latitude": -3.794373279639114,
                "longitude": 17.313922808335803
            },
            "z": 293.63791410042523
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -34.49121062973355,
                    "z": 60.281945816567145
                }
            },
            "p": {
                "latitude": -1.3526357996875413,
                "longitude": 11.76710994282905
            },
            "z": 293.88722259400663
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -28.865667469622267,
                    "z": 62.95455771021555
                }
            },
            "p": {
                "latitude": 1.1066876636820107,
                "longitude": 6.220297077322295
            },
            "z": 293.8991397737503
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -23.202246770065873,
                    "z": 65.3470914426832
                }
            },
            "p": {
                "latitude": 3.5516165198425305,
                "longitude": 0.6734842118155405
            },
            "z": 66.32651097740329
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -17.535423559836605,
                    "z": 67.53293472609532
                }
            },
            "p": {
                "latitude": 5.950727220737206,
                "longitude": -4.873328653691214
            },
            "z": 293.21359685102044
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -11.894740446877028,
                    "z": 69.5685436999783
                }
            },
            "p": {
                "latitude": 8.27432577648092,
                "longitude": -10.42014151919797
            },
            "z": 292.52612922832765
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -6.304832754418365,
                    "z": 71.49906119726688
                }
            },
            "p": {
                "latitude": 10.495426868935947,
                "longitude": -15.966954384704723
            },
            "z": 291.62077686193055
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": -0.7853940265400996,
                    "z": 73.36224466337575
                }
            },
            "p": {
                "latitude": 12.590448424152212,
                "longitude": -21.513767250211476
            },
            "z": 290.50982865048707
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 4.648736817001894,
                    "z": 75.19135760983544
                }
            },
            "p": {
                "latitude": 14.539582013785738,
                "longitude": -27.06058011571823
            },
            "z": 289.20768213622796
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 9.987288092630841,
                    "z": 77.01746224894276
                }
            },
            "p": {
                "latitude": 16.32685040807144,
                "longitude": -32.60739298122498
            },
            "z": 287.730340310992
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 15.224055302065828,
                    "z": 78.87142879862316
                }
            },
            "p": {
                "latitude": 17.939902747312637,
                "longitude": -38.154205846731735
            },
            "z": 286.0949371472638
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 20.35620937661779,
                    "z": 80.78592040780886
                }
            },
            "p": {
                "latitude": 19.369619663636723,
                "longitude": -43.701018712238486
            },
            "z": 284.31932272407073
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 25.383439125422882,
                    "z": 82.79760783518931
                }
            },
            "p": {
                "latitude": 20.60960568908982,
                "longitude": -49.24783157774524
            },
            "z": 282.42172600899323
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 30.306934808518463,
                    "z": 84.9499137186251
                }
            },
            "p": {
                "latitude": 21.655638761194506,
                "longitude": -54.79464444325199
            },
            "z": 280.42050174930034
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 35.12817900010114,
                    "z": 87.29669378499408
                }
            },
            "p": {
                "latitude": 22.505132261717996,
                "longitude": -60.34145730875874
            },
            "z": 278.33395892950097
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 39.847444806610895,
                    "z": 89.90745712232093
                }
            },
            "p": {
                "latitude": 23.15664884235783,
                "longitude": -65.8882701742655
            },
            "z": 276.1802622539814
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 44.46179622739639,
                    "z": 92.875049925468
                }
            },
            "p": {
                "latitude": 23.609490742620366,
                "longitude": -71.43508303977225
            },
            "z": 273.9773947836258
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 48.96221006274813,
                    "z": 96.32721800871771
                }
            },
            "p": {
                "latitude": 23.863380121408014,
                "longitude": -76.981895905279
            },
            "z": 271.74316851131556
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 53.329135421048704,
                    "z": 100.44408176751298
                }
            },
            "p": {
                "latitude": 23.918235497279692,
                "longitude": -82.52870877078574
            },
            "z": 269.49526954579517
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 57.52528677742636,
                    "z": 105.48382620224955
                }
            },
            "p": {
                "latitude": 23.774046273241332,
                "longitude": -88.07552163629249
            },
            "z": 267.2513250238767
        },
        {
            "wpFromPos": {
                "observer": {
                    "latitude": 37.7489,
                    "longitude": -122.507
                },
                "observed": {
                    "alt": 61.48367273018048,
                    "z": 111.81660598586623
                }
            },
            "p": {
                "latitude": 23.430845632793943,
                "longitude": -93.62233450179924
            }
        }
    ],
    "moonTilt": -61.189131832042264,
    "eclipticObliquity": 0,
    "from": {
        "latitude": 37.7489,
        "longitude": -122.507
    },
    "sunObs": {
        "alt": 61.483672730180515,
        "z": 111.8166059858663
    },
    "moonObs": {
        "alt": -40.03905652294609,
        "z": 57.230621188911165
    },
    "ariesObs": {
        "alt": 23.530806323649287,
        "z": 250.2967005270234
    },
    "tPass": {
        "epoch": 0,
        "year": 0,
        "month": 0,
        "day": 0,
        "hour": 20,
        "min": 11,
        "sec": 30,
        "tz": "UTC"
    },
    "solarDate": {
        "epoch": 1624097067680,
        "year": 2021,
        "month": 6,
        "day": 19,
        "hour": 10,
        "min": 4,
        "sec": 27
    }
};

worldMap.setAstronomicalData(data);
worldMap.repaint();

};        
    </script>

    <link rel="stylesheet" href="css/web-components.css">

    <style>
        h1 {
            color: silver;
            font-family: Verdana,sans-serif;
            font-style: italic;
        }

        body {
            font-family: Verdana,sans-serif;
        }

        .day {
            width: 40px;
            text-align: center;
        }

        .year {
            width: 80px;
            text-align: center;
        }

        .result {
            margin-top: 10px;
            border: solid silver 1px;
            border-radius: 5px;
            width: 80%;
            height: 200px;
            max-height: 200px;
            font-family: "Courier New",sans-serif;
            overflow-y: auto;
        }

        .black-frame {
            padding: 3px;
            margin: 1px;
            border-radius: 5px;
            border: 1px solid silver;
            box-shadow: 0 2px 2px #ccc;
        }

        .centered {
            text-align: center;
        }

    </style>
</head>
<body>
<h1>Celestial Computer test, with WebComponents</h1>
<h3>Work in Progress</h3>
<table>
    <tr>
        <td style="vertical-align: top;">
            <small>Enter UTC date and time, then click the Compute button.</small>
            <div>
                <input class="day" type="number" id="UTC-day" placeholder="day" min="1" max="31" title="Day of the Month">
                <select class="month" id="UTC-month" title="Month of the year">
                    <option value="1">Jan</option>
                    <option value="2">Feb</option>
                    <option value="3">Mar</option>
                    <option value="4">Apr</option>
                    <option value="5">May</option>
                    <option value="6">Jun</option>
                    <option value="7">Jul</option>
                    <option value="8">Aug</option>
                    <option value="9">Sep</option>
                    <option value="10">Oct</option>
                    <option value="11">Nov</option>
                    <option value="12">Dec</option>
                </select>
                <input class="year" type="number" id="UTC-year" placeholder="year" min="0" title="year">
                at
                <input class="day" type="number" id="UTC-hour" placeholder="hours" min="0" max="23" title="Hour of the day [0..23]">:
                <input class="day" type="number" id="UTC-minute" placeholder="minutes" min="0" max="59" title="minutes">:
                <input class="day" type="number" id="UTC-second" placeholder="seconds" min="0" max="59" title="seconds"> UTC
            </div>
            <div>
                <input type="checkbox" id="no-planet"><small>Skip planets calculations</small>
                <input type="checkbox" id="verbose" onchange="verbose(this);"><small>Console Verbose</small>
            </div>
            <button id="now" onclick="updateUTCDate();">Now</button>&nbsp;
            <button id="compute" onclick="compute();">Compute</button>&nbsp;
            <input type="checkbox" id="auto-refresh" onchange="autoRefresh(this);"><small>Auto Refresh</small>
        </td>
        <td>
            <div id="moon-phase-div"></div>
        </td>
    </tr>
</table>

<!--
    WORLD MAP
+-->
<div id="world-map">
    <div class="black-frame centered">
        <world-map id="world-map-01"
                    class="worldmap-display"
                    title="World Map"
                    width="700"
                    height="500"></world-map>
    </div>
    <div class="black-frame centered">
        <input type="checkbox" onchange="setTransparency('world-map-01', this);"/>Transparent
        <input type="checkbox" onchange="setGrid('world-map-01', this);" checked/>Grid
        <input type="checkbox" onchange="setSun('world-map-01', this);" checked/>Sun
        <input type="checkbox" onchange="setMoon('world-map-01', this);" checked/>Moon
        <input type="checkbox" onchange="setSunlight('world-map-01', this);"/>Sunlight
        <input type="checkbox" onchange="setMoonlight('world-map-01', this);"/>Moonlight
        <input type="checkbox"
                onchange="withWanderingBodies = this.checked; setWanderingBodies('world-map-01', this);"/>Wandering
        bodies
        <input type="checkbox" onchange="withStars = this.checked; setStars('world-map-01', this);"/>Stars
        <input type="checkbox" onchange="setTropics('world-map-01', this);"/>Tropics
        <br/>
        <input type="checkbox" id="geo-sat-01"/>GeoStationary Satellites
        <input type="checkbox" id="iss-01" title="Requires Internet connection"/>ISS
        <input type="checkbox" id="gps-sat-01"/>GPS Satellites in view
        <input type="checkbox" id="moon-sun-path-01"/>Moon to Sun
        <br/>
        <input type="radio" name="proj-01" value="GLOBE" onchange="setProjection('world-map-01', this);"
                checked>Globe
        <input type="radio" name="proj-01" value="MERCATOR" onchange="setProjection('world-map-01', this);">Mercator
        <input type="radio" name="proj-01" value="ANAXIMANDRE"
                onchange="setProjection('world-map-01', this);">Square
    </div>
</div>


<div id="result" class="result">
</div>

<div id="details" class="result">
</div>

</body>
<script type="text/javascript">

    const DELTA_T = 69.2201; // Will be re-calculated

    let consoleVerbose = false;

    // Compute and display
    let compute = () => {

        let calculationData = {
            utcyear: parseInt(document.getElementById('UTC-year').value),
            utcmonth: parseInt(document.getElementById('UTC-month').value),
            utcday: parseInt(document.getElementById('UTC-day').value),
            utchour: parseInt(document.getElementById('UTC-hour').value),
            utcminute: parseInt(document.getElementById('UTC-minute').value),
            utcsecond: parseInt(document.getElementById('UTC-second').value),
            deltaT: DELTA_T,
            noPlanets: document.getElementById('no-planet').checked
        };

        let testResult = sampleMain(calculationData); // in app.js
        if (consoleVerbose) {
            console.log("Calculation done %d-%d-%d %d:%d:%d UTC :", calculationData.utcyear, calculationData.utcmonth, calculationData.utcday, calculationData.utchour, calculationData.utcminute, calculationData.utcsecond);
            console.log("Result:\n", JSON.stringify(testResult, null, 2));
        }

        document.getElementById('result').innerHTML = '<pre>' + JSON.stringify(testResult, null, 2) + '</pre>';
        // More here, ...
        let detailsContent =
            " Sun    : GHA: " + testResult.sun.GHA.fmt + ", RA: " + testResult.sun.RA.fmt + ", Dec: " + testResult.sun.DEC.fmt + ", sd:" + testResult.sun.SD.fmt + ", hp:" + testResult.sun.HP.fmt + "\n" +
            " Moon   : GHA: " + testResult.moon.GHA.fmt + ", RA: " + testResult.moon.RA.fmt + ", Dec: " + testResult.moon.DEC.fmt + ", sd:" + testResult.moon.SD.fmt + ", hp:" + testResult.moon.HP.fmt + "\n" +
            "     Moon Phase:" + testResult.moon.phase.phaseAngle + "&deg;, " + testResult.moon.phase.phase + "\n";
        if (!document.getElementById('no-planet').checked) {
            detailsContent +=
                " Venus  : GHA: " + testResult.venus.GHA.fmt + ", RA: " + testResult.venus.RA.fmt + ", Dec: " + testResult.venus.DEC.fmt + ", sd:" + testResult.venus.SD.fmt + ", hp:" + testResult.venus.HP.fmt + "\n" +
                " Mars   : GHA: " + testResult.mars.GHA.fmt + ", RA: " + testResult.mars.RA.fmt + ", Dec: " + testResult.mars.DEC.fmt + ", sd:" + testResult.mars.SD.fmt + ", hp:" + testResult.mars.HP.fmt + "\n" +
                " Jupiter: GHA: " + testResult.jupiter.GHA.fmt + ", RA: " + testResult.jupiter.RA.fmt + ", Dec: " + testResult.jupiter.DEC.fmt + ", sd:" + testResult.jupiter.SD.fmt + ", hp:" + testResult.jupiter.HP.fmt + "\n" +
                " Saturn : GHA: " + testResult.saturn.GHA.fmt + ", RA: " + testResult.saturn.RA.fmt + ", Dec: " + testResult.saturn.DEC.fmt + ", sd:" + testResult.saturn.SD.fmt + ", hp:" + testResult.saturn.HP.fmt + "\n" +
                "\n" +
                " Polaris: GHA: " + testResult.polaris.GHA.fmt + ", RA: " + testResult.polaris.RA.fmt + ", Dec: " + testResult.polaris.DEC.fmt + "\n";
        }
        detailsContent +=
            " Equation of time: " + testResult.EOT.fmt + "\n" +
            " Lunar Distance: " + testResult.lunarDist.fmt + "\n" +
            " Day of Week: " + testResult.dayOfWeek;

        document.getElementById('details').innerHTML = '<pre>' + detailsContent + '</pre>';

        try {
            if (testResult.moon.phase.phaseAngle !== undefined) {
                let phaseIndex = Math.floor(testResult.moon.phase.phaseAngle / (360 / 28.5)) + 1;
                let phaseImageName = `moon/phase${(phaseIndex < 10 ? '0' : '') + phaseIndex}.gif`;
                if (consoleVerbose) {
                    console.log('Loading ', phaseImageName);
                }
                document.getElementById('moon-phase-div').innerHTML =
                    `<img src='${phaseImageName}' alt='${testResult.moon.phase.phaseAngle}' title='${testResult.moon.phase.phaseAngle + '&deg'}'>`;
            }
        } catch (oops) {
            console.log(oops);
        }

        // Temporary
        // TODO Turn the data into the expected ones by the WorldMap WebComponent

        displayWorldData();

    };

    let updateUTCDate = () => {
        let now = new Date();
        document.getElementById('UTC-day').value = now.getUTCDate();
        document.getElementById('UTC-month').value = now.getUTCMonth() + 1;
        document.getElementById('UTC-year').value = now.getUTCFullYear();
        document.getElementById('UTC-hour').value = (now.getUTCHours().toString().length < 2 ? "0" : "") + now.getUTCHours();
        document.getElementById('UTC-minute').value = (now.getUTCMinutes().toString().length < 2 ? "0" : "") + now.getUTCMinutes();
        document.getElementById('UTC-second').value = (now.getUTCSeconds().toString().length < 2 ? "0" : "") + now.getUTCSeconds();
    };

    let interval = undefined;
    const INTERVAL = 1000;

    let autoRefresh = (cb) => {
        document.getElementById('compute').disabled = cb.checked;
        document.getElementById('now').disabled = cb.checked;
        if (cb.checked) {
            interval = window.setInterval(() => {
                updateUTCDate();
                compute();
            }, INTERVAL);
        } else {
            window.clearInterval(interval);
        }
    };

    let verbose = (cb) => {
        consoleVerbose = cb.checked;
    };

    // Set default date values
    window.onload = () => {

        console.log('On Load, ready.');
        updateUTCDate();
        console.log('On Load, done.');

    };
</script>
</html>

