<!DOCTYPE html>
<html lang="en">
<!--
 ! Standalone.
 ! All ES6 Astrocomputer
 ! Sight reduction, back and forth.
 +-->
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Sight Reduction</title>
	<link rel="icon" type="image/gif" href="./pix/sextant.gif">
	<link rel="stylesheet" href="./css/stylesheet.css">
	<!--style type="text/css">
		body {
			color: cyan;
		}
	</style-->
	<!-- Scripts -->
    <!-- Main Module -->
    <script type="module" src="app.js"></script> <!-- THAT is the key -->

	<script type="text/javascript">

		function decToSex(val, ns_ew) {
			var absVal = Math.abs(val);
			var intValue = Math.floor(absVal);
			var dec = absVal - intValue;
			var i = intValue;
			dec *= 60;
			var s = "";
			if (ns_ew !== undefined) {
				if (val < 0) {
					s += (ns_ew === 'NS' ? 'S' : 'W');
				} else {
					s += (ns_ew === 'NS' ? 'N' : 'E');
				}
			}
			s += " ";
			s += i + "&deg;" + dec.toFixed(2) + "'";
			return s;
		}

		function updateFieldToNow() {
			let now = new Date();
			let year = now.getUTCFullYear();
			let month = now.getUTCMonth() + 1;
			let day = now.getUTCDate();
			let hours = now.getUTCHours();
			let minutes = now.getUTCMinutes();
			let seconds = now.getUTCSeconds();

			document.getElementById('calendar-year-01').value = year;
			document.getElementById('calendar-month-01').value = (month < 10 ? '0' + month : month);
			document.getElementById('calendar-day-01').value = day;
			document.getElementById('watch-value-01').value =
					(hours < 10 ? '0' + hours : hours) + ':' +
					(minutes < 10 ? '0' + minutes : minutes) + ':' +
					(seconds < 10 ? '0' + seconds : seconds);
		}

    // Used by setGeolocation
    let geoInterval;
    const options = {
        enableHighAccuracy: true,
        maximumAge: 0,
        timeout: 5000
    };

    // Called from navigator.geolocation.getCurrentPosition
    // Used by setGeolocation
    const onPosSuccess = (pos) => {

        // Doc at https://w3c.github.io/geolocation-api/
        // Position object at https://w3c.github.io/geolocation-api/#position_interface
        //
        console.log('lat= ' + pos.coords.latitude + ' lon= ' + pos.coords.longitude); // + ' hdg= ' + pos.coords.heading + ' spd= ' + pos.coords.speed + ' m/s');
        console.log(`GeoLocation position: ${decToSex(pos.coords.latitude, 'NS')} / ${decToSex(pos.coords.longitude, 'EW')}`);
        // console.log("Pos data:" + pos.coords);
        // document.getElementById('center-point').innerHTML = `Centered on ${decToSex(pos.coords.latitude, 'NS')} / ${decToSex(pos.coords.longitude, 'EW')}`;


        // set the pos.coords.latitude, pos.coords.longitude
		let latSign = Math.sign(pos.coords.latitude);
		let latDeg = Math.floor(Math.abs(pos.coords.latitude));
		let latMin = (Math.abs(pos.coords.latitude) - latDeg) * 60.0;
		document.getElementById('pos-lat-sign-01').value = latSign < 0 ? 'S' : 'N';
		document.getElementById('pos-lat-deg-01').value = latDeg;
		document.getElementById('pos-lat-min-01').value = latMin.toFixed(2);

		let lngSign = Math.sign(pos.coords.longitude);
		let lngDeg = Math.floor(Math.abs(pos.coords.longitude));
		let lngMin = (Math.abs(pos.coords.longitude) - lngDeg) * 60.0;
		document.getElementById('pos-lng-sign-01').value = lngSign < 0 ? 'W' : 'E';
		document.getElementById('pos-lng-deg-01').value = lngDeg;
		document.getElementById('pos-lng-min-01').value = lngMin.toFixed(2);

	};

    // Called from navigator.geolocation.getCurrentPosition
    // Used by setGeolocation
    const onPosError = (err) => {
        let errMess;
        if (err.code === err.PERMISSION_DENIED) {
            errMess = 'Location access was denied by the user.';
        } else {
            errMess = 'location error (' + err.code + '): ' + err.message;
        }
        console.error(errMess);
    };

    let setGeolocation = (slider) => {
        console.log(`GeoLocation turned ${slider.checked ? 'ON' : 'OFF'}`);
        if (slider.checked) { // ON
            geoInterval = setInterval(() => {
            /* let watchId = */ navigator.geolocation.getCurrentPosition(onPosSuccess, onPosError, options);
            }, 1000);
        } else {              // OFF
            if (geoInterval) {
                clearInterval(geoInterval);
            }
        }
    };


		/*
		  Sample payload:

		{
		  "estimatedPosition": {
				"latitude": 37.409,
				"longitude": -122.7654
			},
			"utcDate": "2018-11-05T20:50:52",
			"cbd": {
				"name": "Sun",
				"instrumentalAltitude": 35.074,
				"limb": "LOWER",
				"eyeHeight": 1.8
			}
		}
		 */

		const LOWER_LIMB = 1;
		const UPPER_LIMB = 2;

		function findStarGHA(bodyName, globalData) {
			globalData.stars.forEach(star => {
				if (star.name === bodyName) {
					return star.gha;
				}
			});
			return null;
		};
		function findStarDEC(bodyName, globalData) {
			globalData.stars.forEach(star => {
				if (star.name === bodyName) {
					return star.decl;
				}
			});
			return null;
		};

		function getGHAFor(bodyName, globalData) {
			switch (bodyName) {
				case 'Moon':
					return globalData.moon.GHA.raw;
				case 'Venus':
					return globalData.venus.GHA.raw;
				case 'Mars':
					return globalData.mars.GHA.raw;
				case 'Jupiter':
					return globalData.jupiter.GHA.raw;
				case 'Saturn':
					return globalData.saturn.GHA.raw;
				default: // Star ?
					return findStarGHA(bodyName, globalData);
			}
			return null;
		};
		function getDECFor(bodyName, globalData) {
			switch (bodyName) {
				case 'Moon':
					return globalData.moon.DEC.raw;
				case 'Venus':
					return globalData.venus.DEC.raw;
				case 'Mars':
					return globalData.mars.DEC.raw;
				case 'Jupiter':
					return globalData.jupiter.DEC.raw;
				case 'Saturn':
					return globalData.saturn.DEC.raw;
				default: // Star ?
					return findStarDEC(bodyName, globalData);
			}
			return null;
		}
		function getHPFor(bodyName, globalData) {
			switch (bodyName) {
				case 'Moon':
					return globalData.moon.HP.raw;
				case 'Venus':
					return globalData.venus.HP.raw;
				case 'Mars':
					return globalData.mars.HP.raw;
				case 'Jupiter':
					return globalData.jupiter.HP.raw;
				case 'Saturn':
					return globalData.saturn.HP.raw;
				default: // Star ?
					return 0;
			}
			return null;
		}
		function getSDFor(bodyName, globalData) {
			switch (bodyName) {
				case 'Moon':
					return globalData.moon.SD.raw;
				case 'Venus':
					return globalData.venus.SD.raw;
				case 'Mars':
					return globalData.mars.SD.raw;
				case 'Jupiter':
					return globalData.jupiter.HP.raw;
				case 'Saturn':
					return globalData.saturn.SD.raw;
				default: // Star ?
					return 0;
			}
			return null;
		}

		function calculateSightReduction(payload, callback) {
			console.log(payload);

			let calculationData = {                                               // utcDate like 2025-03-31T14:16:31, duration format.
				utcyear: parseInt(payload.utcDate.substring(0, 4)),               //              |    |  |  |  |  |
				utcmonth: parseInt(payload.utcDate.substring(5, 7)),              //              0    |  |  |  |  |
				utcday: parseInt(payload.utcDate.substring(8, 10)),               //                   5  |  |  |  |
				utchour: parseInt(payload.utcDate.substring(11, 13)),             //                      8  |  |  |
				utcminute: parseInt(payload.utcDate.substring(14, 16)),           //                         11 |  |
				utcsecond: parseInt(payload.utcDate.substring(17, 19)),           //                            14 | 
				deltaT: DELTA_T,                                                  //                               17
				noPlanets: false,
				noStars: false
			};

			let globalAstroData = sampleMain(calculationData); // in app.js
			if (false) {
				console.log("Calculation done %d-%d-%d %d:%d:%d UTC :", calculationData.utcyear, calculationData.utcmonth, calculationData.utcday, calculationData.utchour, calculationData.utcminute, calculationData.utcsecond);
				console.log("Result:\n", JSON.stringify(globalAstroData, null, 2));
			}

			// SRU - Sight Reduction Utility
			try { 
				// Default Sun
				let ghaBody = globalAstroData.sun.GHA.raw;
				let decBody = globalAstroData.sun.DEC.raw;
				let hp = globalAstroData.sun.HP.raw; // in seconds of arc
				let sd = globalAstroData.sun.SD.raw; 
				if (payload.cbd.name !== 'Sun') {
					// Update the data !
					ghaBody = getGHAFor(payload.cbd.name, globalAstroData);
					decBody = getDECFor(payload.cbd.name, globalAstroData);
					hp = getHPFor(payload.cbd.name, globalAstroData);
					sd = getSDFor(payload.cbd.name, globalAstroData);
				}
				let sruBody = sightReduction(payload.estimatedPosition.latitude, payload.estimatedPosition.longitude, ghaBody, decBody);
				// document.getElementById('sru-elev-z').innerHTML =
				//     `SUN<br/>Elev: ${sru.alt.toFixed(2)}&deg;<br/>Z: ${sru.Z.toFixed(1)}&deg;`;

				// hp, semi-diam (upper-lower limb), refraction, horizon depression
				let horizonDip = getHorizonDip(payload.cbd.eyeHeight); // 1.80 meters above the surface
				let refraction = 0;
				if (payload.cbd.instrumentalAltitude > 0) {
					refraction = getRefraction(payload.cbd.instrumentalAltitude);
				}
				let limb =  (payload.cbd.limb === 'UPPER') ? UPPER_LIMB : LOWER_LIMB; // Get it from the form
				if (limb === UPPER_LIMB) {
					sd = -sd; // in seconds of arc.
				}

				console.log(`${payload.cbd.name} SD: ${sd / 60.0}', dip:${horizonDip}', refraction:${refraction}', HP: ${hp / 60.0}'`);
				let apparentCorrection = (sd / 60.0) - horizonDip;
				let totalCorrection = apparentCorrection - (isNaN(refraction) ? 0 : refraction) + (hp / 60.0);
				console.log(`Apparent Correction (SD - Horizon Dip): ${apparentCorrection.toFixed(2)}'`);
				console.log(`Total Correction (App Correction - refraction + hp): ${totalCorrection.toFixed(2)}'`);
				console.log("Total Correction: to be ADDED to the instrumental (measured) elevation.");

				console.log(`${payload.cbd.name} Z: ${sruBody.Z}`);
				console.log(`${payload.cbd.name} alt: ${sruBody.alt}`); 

				/*
				For the callback: {
					decl: -16.40498367695131
					delta-t: 68.9677
					gha: 84.8538302416593
					horizon-depression-minutes: 2.361287784239778
					horizontal-parallax-minutes: 0.1479020927681669
					hp: 0.0024650348794694483
					instrumental-altitude: 25.119431796329224
					lunar-distance: 4.873968467166731
					observed-altitude-degrees: 25.317291337175323
					parallax-minutes: 0.13369661970764085
					refraction-minutes: 2.040395775549588
					sd: 0.2689926565141308
					semi-diameter-minutes: 16.139559390847847
					total-correction-minutes: 11.871572450766122

					estimated-altitude-degrees
					intercept-degrees
				}
				*/

				// TODO All bodies...
				callbackContent = {
					"decl": globalAstroData.sun.DEC.raw,
					"delta-t": globalAstroData.deltaT,
					"gha": globalAstroData.sun.GHA.raw,
					"horizon-depression-minutes": horizonDip,
					"horizontal-parallax-minutes": hp,
					"hp": hp / 3600.0,
					"instrumental-altitude": payload.cbd.instrumentalAltitude,
					"lunar-distance": globalAstroData.lunarDist.raw,
					"observed-altitude-degrees": payload.cbd.instrumentalAltitude + (totalCorrection / 60.0),
					"estimated-altitude-degrees": sruBody.alt,
					"intercept-degrees": sruBody.alt - (payload.cbd.instrumentalAltitude + (totalCorrection / 60.0)),
					"parallax-minutes": hp / 60.0,
					"refraction-minutes": refraction,
					"sd": sd / 3600.0,
					"semi-diameter-minutes": sd / 60.0,
					"total-correction-minutes": totalCorrection,
					"z": sruBody.Z
				}

				callback(callbackContent);

			} catch (err) {
				console.log('Oops:', err)
			}		
		}

		const DELTA_T = 69.2201; // Will be re-calculated

		function calculateReverseSight(payload, callback) {
			console.log(payload);

			let calculationData = {                                               // utcDate like 2025-03-31T14:16:31, duration format.
				utcyear: parseInt(payload.utcDate.substring(0, 4)),               //              |    |  |  |  |  |
				utcmonth: parseInt(payload.utcDate.substring(5, 7)),              //              0    |  |  |  |  |
				utcday: parseInt(payload.utcDate.substring(8, 10)),               //                   5  |  |  |  |
				utchour: parseInt(payload.utcDate.substring(11, 13)),             //                      8  |  |  |
				utcminute: parseInt(payload.utcDate.substring(14, 16)),           //                         11 |  |
				utcsecond: parseInt(payload.utcDate.substring(17, 19)),           //                            14 | 
				deltaT: DELTA_T,                                                  //                               17
				noPlanets: false,
				noStars: false
			};

			let globalAstroData = sampleMain(calculationData); // in app.js
			if (false) {
				console.log("Calculation done %d-%d-%d %d:%d:%d UTC :", calculationData.utcyear, calculationData.utcmonth, calculationData.utcday, calculationData.utchour, calculationData.utcminute, calculationData.utcsecond);
				console.log("Result:\n", JSON.stringify(globalAstroData, null, 2));
			}

			// SRU - Sight Reduction Utility
			try { 
				// Default Sun
				let ghaBody = globalAstroData.sun.GHA.raw;
				let decBody = globalAstroData.sun.DEC.raw;
				let hp = globalAstroData.sun.HP.raw; // in seconds of arc
				let sd = globalAstroData.sun.SD.raw; 
				if (payload.cbd.name !== 'Sun') {
					// Update the data !
					ghaBody = getGHAFor(payload.cbd.name, globalAstroData);
					decBody = getDECFor(payload.cbd.name, globalAstroData);
					hp = getHPFor(payload.cbd.name, globalAstroData);
					sd = getSDFor(payload.cbd.name, globalAstroData);
				}
				let sruBody = sightReduction(payload.estimatedPosition.latitude, payload.estimatedPosition.longitude, ghaBody, decBody);
				// document.getElementById('sru-elev-z').innerHTML =
				//     `SUN<br/>Elev: ${sru.alt.toFixed(2)}&deg;<br/>Z: ${sru.Z.toFixed(1)}&deg;`;

				// hp, semi-diam (upper-lower limb), refraction, horizon depression
				let horizonDip = getHorizonDip(payload.cbd.eyeHeight); // 1.80 meters above the surface
				let refraction = 0;
				if (sruBody.alt > 0) {
					refraction = getRefraction(sruBody.alt);
				}
				let limb =  (payload.cbd.limb === 'UPPER') ? UPPER_LIMB : LOWER_LIMB; // Get it from the form
				if (limb === UPPER_LIMB) {
					sd = -sd; // in seconds of arc.
				}

				console.log(`${payload.cbd.name} SD: ${sd / 60.0}', dip:${horizonDip}', refraction:${refraction}', HP: ${hp / 60.0}'`);
				let apparentCorrection = (sd / 60.0) - horizonDip;
				let totalCorrection = apparentCorrection - (isNaN(refraction) ? 0 : refraction) + (hp / 60.0);
				console.log(`Apparent Correction (SD - Horizon Dip): ${apparentCorrection.toFixed(2)}'`);
				console.log(`Total Correction (App Correction - refraction + hp): ${totalCorrection.toFixed(2)}'`);
				console.log("Total Correction: to be ADDED to the instrumental (measured) elevation.");

				console.log(`${payload.cbd.name} Z: ${sruBody.Z}`);
				console.log(`${payload.cbd.name} alt: ${sruBody.alt}`); 

				/*
				For the callback: {
					decl: -16.40498367695131
					delta-t: 68.9677
					gha: 84.8538302416593
					horizon-depression-minutes: 2.361287784239778
					horizontal-parallax-minutes: 0.1479020927681669
					hp: 0.0024650348794694483
					instrumental-altitude: 25.119431796329224
					lunar-distance: 4.873968467166731
					observed-altitude-degrees: 25.317291337175323
					parallax-minutes: 0.13369661970764085
					refraction-minutes: 2.040395775549588
					sd: 0.2689926565141308
					semi-diameter-minutes: 16.139559390847847
					total-correction-minutes: 11.871572450766122
				}
				*/

				// TODO All bodies...
				callbackContent = {
					"decl": globalAstroData.sun.DEC.raw,
					"delta-t": globalAstroData.deltaT,
					"gha": globalAstroData.sun.GHA.raw,
					"horizon-depression-minutes": horizonDip,
					"horizontal-parallax-minutes": hp,
					"hp": hp / 3600.0,
					"instrumental-altitude": sruBody.alt - (totalCorrection / 60.0),
					"lunar-distance": globalAstroData.lunarDist.raw,
					"observed-altitude-degrees": sruBody.alt,
					"parallax-minutes": hp / 60.0,
					"refraction-minutes": refraction,
					"sd": sd / 3600.0,
					"semi-diameter-minutes": sd / 60.0,
					"total-correction-minutes": totalCorrection,
					"z": sruBody.Z
				}

				callback(callbackContent);

			} catch (err) {
				console.log('Oops:', err)
			}
		}

		function calculateSR(reverse) {
			// Gather user data
			let day = document.getElementById('calendar-day-01').value;
			let utcDate =
					document.getElementById('calendar-year-01').value + '-' +
					document.getElementById('calendar-month-01').value + '-' +
					(day.length < 2 ? '0' : '') + day + 'T' +
					document.getElementById('watch-value-01').value;
			let latitude =
					(parseInt(document.getElementById('pos-lat-deg-01').value) +
					(parseFloat(document.getElementById('pos-lat-min-01').value) / 60)) *
					(document.getElementById('pos-lat-sign-01').value === 'S' ? (-1) : 1);
			let longitude =
					(parseInt(document.getElementById('pos-lng-deg-01').value) +
					(parseFloat(document.getElementById('pos-lng-min-01').value) / 60)) *
					(document.getElementById('pos-lng-sign-01').value === 'W' ?  (-1) : 1);

			let body = document.getElementById('celestial-body').value;
			let limb = document.getElementById('limb').value;

			let sextantAltitude =
					parseInt(document.getElementById('sextant-degrees').value) +
					(parseFloat(document.getElementById('sextant-minutes').value) / 60);

			let eyeHeight = parseFloat(document.getElementById('eye-height').value);

			let requestPayload = {
				"estimatedPosition": {
					"latitude": latitude,
					"longitude": longitude
				},
				"utcDate": utcDate,
				"cbd": { // cbd: callback data
					"name": body,
					"instrumentalAltitude": sextantAltitude,
					"limb": limb,
					"eyeHeight": eyeHeight
				}
			};
			// Create and invoke promise
			let srCallback = function(result) {
				/*
				Result looks like: {
					decl: -16.40498367695131,
					delta-t: 68.9677,
					estimated-altitude-degrees: 25.317291337175323,
					gha: 84.8538302416593,
					horizon-depression-minutes: 2.361287784239778,
					horizontal-parallax-minutes: 0.1479020927681669,
					hp: 0.0024650348794694483,
					intercept-degrees: -0.0002860101440127494,
					lunar-distance: 4.873968467166731,
					observed-altitude-degrees: 25.31700532703131,
					parallax-minutes: 0.13399483310705615,
					refraction-minutes: 2.061946817836327,
					sd: 0.2689926565141308,
					semi-diameter-minutes: 16.139559390847847,
					total-correction-minutes: 11.850319621878798,
					z: 139.58829918131767
				}
				*/
				//	console.log("Result:", result);

				let fmtDisplay = "<hr/>";

				let sdCorrected = result['semi-diameter-minutes'] * (limb === 'LOWER' ? 1 : -1);
				let appCorrection = sdCorrected - result['horizon-depression-minutes'];
				let appToObsCorrection = result['parallax-minutes'] - result['refraction-minutes'];
				fmtDisplay += ("<table>");
				fmtDisplay += ("<tr><th style='text-align: left;' colspan='2'>Almanac:</th><th style='text-align: left;' colspan='4'>Corrections:</th></tr>");
				// Line 1
				fmtDisplay += ("<tr><td style='text-align: right;'>GHA</td><td style='text-align: right;'>" + decToSex(result['gha']) + "</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Horizon Dip</td><td style='text-align: right;'>" + (- result['horizon-depression-minutes']).toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Parallax</td><td style='text-align: right;'>" + result['parallax-minutes'].toFixed(2) + "'</td></tr>");
				// Line 2
				fmtDisplay += ("<tr><td style='text-align: right;'>Dec</td><td style='text-align: right;'>" + decToSex(result['decl'], 'NS') + "</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Semi-diameter</td><td style='text-align: right;'>" + sdCorrected.toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Refraction</td><td style='text-align: right;'>" + (- result['refraction-minutes']).toFixed(2) + "'</td></tr>");
				// Line 3
				fmtDisplay += ("<tr><td style='text-align: right;'>Semi-diameter</td><td style='text-align: right;'>" + result['semi-diameter-minutes'].toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Apparent Elevation</td><td style='text-align: right;'><b>" + decToSex(result['observed-altitude-degrees'] - (appToObsCorrection / 60)) + "</b></td>");
				fmtDisplay += (     "<td style='text-align: right;'>Observed Elevation</td><td style='text-align: right;'><b>" + decToSex(result['observed-altitude-degrees']) + "</b></td></tr>");
				// Line 4
				fmtDisplay += ("<tr><td style='text-align: right;'>Horizontal Parallax</td><td style='text-align: right;'>" + (result['hp'] * 60).toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Apparent Correction</td><td style='text-align: right;'>" + appCorrection.toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Total Correction</td><td style='text-align: right;'>" + result['total-correction-minutes'].toFixed(2) + "'</td></tr>");
				if (result['lunar-distance'] !== undefined) {
					// Line 5
					fmtDisplay += ("<tr><td style='text-align: right;'>Lunar Distance</td><td style='text-align: right;'>" + decToSex(result['lunar-distance']) + "</td></tr>");
				}
				fmtDisplay += ("<tr><td style='text-align: center;' colspan='6'><hr/></td></tr>");
				fmtDisplay += ("<tr><th style='text-align: left;' colspan='6'>Dead Reckoning:</th></tr>");
				// Line 6
				fmtDisplay += ("<tr><td style='text-align: right;' colspan='3'>Observed Elevation</td><td style='text-align: left;' colspan='3'>" + decToSex(result['observed-altitude-degrees']) + "</td></tr>");
				// Line 7
				fmtDisplay += ("<tr><td style='text-align: right;' colspan='3'>Z</td><td style='text-align: left;' colspan='3'>" + decToSex(result['z']) + "</td></tr>");
				// Line 8
				fmtDisplay += ("<tr><td style='text-align: right;' colspan='3'>Estimated Elevation</td><td style='text-align: left;' colspan='3'>" + decToSex(result['estimated-altitude-degrees']) + "</td></tr>");
				// Line 9
				fmtDisplay += ("<tr><td style='text-align: right;' colspan='3'>Intercept</td><td style='text-align: left;' colspan='3'>" + Math.abs(result['intercept-degrees'] * 60).toFixed(2) + "' " + (result['intercept-degrees']<0?"away from":"towards") + " " + body + "</td></tr>");

				fmtDisplay += ("</table>");
				fmtDisplay += ("<hr/>");
				fmtDisplay += ("<i>Calculated with DeltaT = " + result['delta-t'] + ' s</i>');
				fmtDisplay += ("<hr/>");

				document.getElementById("result").innerHTML = fmtDisplay;
			};

			let reverseCallback = function(result) {
				/*
				Result looks like: {
					decl: -16.40498367695131
					delta-t: 68.9677
					gha: 84.8538302416593
					horizon-depression-minutes: 2.361287784239778
					horizontal-parallax-minutes: 0.1479020927681669
					hp: 0.0024650348794694483
					instrumental-altitude: 25.119431796329224
					lunar-distance: 4.873968467166731
					observed-altitude-degrees: 25.317291337175323
					parallax-minutes: 0.13369661970764085
					refraction-minutes: 2.040395775549588
					sd: 0.2689926565141308
					semi-diameter-minutes: 16.139559390847847
					total-correction-minutes: 11.871572450766122
				}
				*/
				//	console.log("Result:", result);

				let hi = result['instrumental-altitude'];
				let degPart = Math.floor(hi);
				let minPart = ((hi - degPart) * 60).toFixed(2);

				document.getElementById("sextant-degrees").value = degPart;
				document.getElementById("sextant-minutes").value = minPart;

				let fmtDisplay = "<hr/>";

				let sdCorrected = result['semi-diameter-minutes'] * (limb === 'LOWER' ? 1 : -1);
				let appCorrection = sdCorrected - result['horizon-depression-minutes'];
				let appToObsCorrection = result['parallax-minutes'] - result['refraction-minutes'];
				fmtDisplay += ("<table>");
				fmtDisplay += ("<tr><th style='text-align: left;' colspan='2'>Almanac:</th><th style='text-align: left;' colspan='4'>Corrections:</th></tr>");
				// Line 1
				fmtDisplay += ("<tr><td style='text-align: right;'>GHA</td><td style='text-align: right;'>" + decToSex(result['gha']) + "</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Horizon Dip</td><td style='text-align: right;'>" + (- result['horizon-depression-minutes']).toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Parallax</td><td style='text-align: right;'>" + result['parallax-minutes'].toFixed(2) + "'</td></tr>");
				// Line 2
				fmtDisplay += ("<tr><td style='text-align: right;'>Dec</td><td style='text-align: right;'>" + decToSex(result['decl'], 'NS') + "</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Semi-diameter</td><td style='text-align: right;'>" + sdCorrected.toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Refraction</td><td style='text-align: right;'>" + (- result['refraction-minutes']).toFixed(2) + "'</td></tr>");
				// Line 3
				fmtDisplay += ("<tr><td style='text-align: right;'>Semi-diameter</td><td style='text-align: right;'>" + result['semi-diameter-minutes'].toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Apparent Elevation</td><td style='text-align: right;'><b>" + decToSex(result['observed-altitude-degrees'] - (appToObsCorrection / 60)) + "</b></td>");
				fmtDisplay += (     "<td style='text-align: right;'>Observed Elevation</td><td style='text-align: right;'><b>" + decToSex(result['observed-altitude-degrees']) + "</b></td></tr>");
				// Line 4
				fmtDisplay += ("<tr><td style='text-align: right;'>Horizontal Parallax</td><td style='text-align: right;'>" + (result['hp'] * 60).toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Apparent Correction</td><td style='text-align: right;'>" + appCorrection.toFixed(2) + "'</td>");
				fmtDisplay += (     "<td style='text-align: right;'>Total Correction</td><td style='text-align: right;'>" + result['total-correction-minutes'].toFixed(2) + "'</td></tr>");
				if (result['lunar-distance'] !== undefined) {
					fmtDisplay += ("<tr><td style='text-align: right;'>Lunar Distance</td><td style='text-align: right;'>" + decToSex(result['lunar-distance']) + "</td></tr>");
				}

				fmtDisplay += ("</table>");
				fmtDisplay += ("<hr/>");
				fmtDisplay += ("<i>Calculated with DeltaT = " + result['delta-t'] + ' s</i>');
				fmtDisplay += ("<hr/>");

				document.getElementById("result").innerHTML = fmtDisplay;
			};

			if (reverse === undefined || reverse === false) {
				calculateSightReduction(requestPayload, srCallback);
			}
			if (reverse !== undefined && reverse === true) {
				calculateReverseSight(requestPayload, reverseCallback);
			}
		}

	</script>
</head>
<body>

	<table width="100%">
		<tr>
			<td><h1>Sight Reduction</h1><small>Minimal UI</small></td>
			<td><img src="./pix/sextant.gif" alt="Sextant" style="background-color: white; padding: 10px; border-radius: 50%; border: 1px solid cyan;"></td>
		</tr>
	</table>
	<hr/>

	<!-- A div for the user to set the UTC time -->
	<div id="user-time-set">
		<div id="user-time-widgets" style="display: block; padding: 10px;">
			<span style="margin: 5px;">UTC Date of observation:</span>
			<br/>
			<input type="number"
						 id="calendar-day-01"
						 placeholder="DD"
						 title="Day to set"
						 style="width: 40px; text-align: center;"
						 value="01"/>
			<select id="calendar-month-01">
				<option value="01" selected>Jan</option>
				<option value="02">Feb</option>
				<option value="03">Mar</option>
				<option value="04">Apr</option>
				<option value="05">May</option>
				<option value="06">Jun</option>
				<option value="07">Jul</option>
				<option value="08">Aug</option>
				<option value="09">Sep</option>
				<option value="10">Oct</option>
				<option value="11">Nov</option>
				<option value="12">Dec</option>
			</select>
			<input type="number"
				   id="calendar-year-01"
				   placeholder="YYYY"
				   title="Year to set"
				   style="width: 60px; text-align: center;"
				   value="1970"/>
			<input type="text"
				   id="watch-value-01"
				   placeholder="00:00:00"
				   title="UTC Time to set"
				   style="width: 80px; text-align: center;"
				   value="00:00:00"/>
			&nbsp;&nbsp;
			<button id="button-now"
					onclick="updateFieldToNow()"
					title="Set date value to current time"
					style="margin-top: 3px; border-radius: 3px; box-shadow: 2px 2px silver;">Now</button>
		</div>
		<div id="user-pos-widgets" style="display: block; padding: 10px;">
			<table>
				<tr>
					<td>Estimated Latitude:</td>
					<td>
						<select id="pos-lat-sign-01">
							<option value="N" selected>N</option>
							<option value="S">S</option>
						</select>
					</td>
					<td>
						<input type="number"
									 id="pos-lat-deg-01"
									 placeholder="Deg"
									 title="Lat degrees to set"
									 style="width: 40px; text-align: center;"
									 min="0"
									 max="90"
									 step="1"
									 value="0"/>
						<span>&deg;</span>
					</td>
					<td>
						<input type="number"
									 id="pos-lat-min-01"
									 placeholder="Minutes"
									 title="Lat minutes to set"
									 style="width: 60px; text-align: center;"
									 min="0"
									 max="59.99"
									 step="0.01"
									 value="00.00"/>
						<span>'</span>
					</td>
				</tr>
			    <tr>
					<td>Estimated Longitude:</td>
					<td>
						<select id="pos-lng-sign-01">
							<option value="E" selected>E</option>
							<option value="W">W</option>
						</select>
					</td>
					<td>
						<input type="number"
							   id="pos-lng-deg-01"
							   placeholder="Deg"
							   title="Lng degrees to set"
							   style="width: 40px; text-align: center;"
							   min="0"
							   max="180"
							   step="1"
							   value="0"/>
						<span>&deg;</span>
					</td>
					<td>
						<input type="number"
								id="pos-lng-min-01"
								placeholder="Minutes"
								title="Lng minutes to set"
								style="width: 60px; text-align: center;"
								min="0"
								max="59.99"
								step="0.01"
								value="00.00"/>
						<span>'</span>
					</td>
				</tr>
				<tr>
					<td colspan="4">
						<div class="switch-container" style="margin-left: 30px;" title="Enable GeoLocation APIs">
							<label class="switch switch-element">
							<input id="geoloc-slider" type="checkbox" onchange="setGeolocation(this);">
							<span class="slider round"></span>
							</label>
							<span class="switch-element">Enable GeoLocation</span>
						</div>
					</td>
				</tr>
			</table>
		</div>
		<div id="user-obs-widgets" style="display: block; padding: 10px;">
			<table>
				<tr>
					<td>Body:</td>
					<td>
						<!-- Body list -->
						<select id="celestial-body">
							<option value="Sun" selected>Sun</option>
							<option value="Moon">Moon</option>
							<option value="Venus">Venus</option>
							<option value="Mars">Mars</option>
							<option value="Jupiter">Jupiter</option>
							<option value="Saturn">Saturn</option>
							<option value="Acamar">Acamar</option>
							<option value="Achenar">Achenar</option>
							<option value="Acrux">Acrux</option>
							<option value="Adhara">Adhara</option>
							<option value="Aldebaran">Aldebaran</option>
							<option value="Alioth">Alioth</option>
							<option value="Alkaid">Alkaid</option>
							<option value="Al Na'ir">Al Na'ir</option>
							<option value="Alnilam">Alnilam</option>
							<option value="Alphard">Alphard</option>
							<option value="Alphecca">Alphecca</option>
							<option value="Alpheratz">Alpheratz</option>
							<option value="Altair">Altair</option>
							<option value="Ankaa">Ankaa</option>
							<option value="Antares">Antares</option>
							<option value="Arcturus">Arcturus</option>
							<option value="Atria">Atria</option>
							<option value="Avior">Avior</option>
							<option value="Bellatrix">Bellatrix</option>
							<option value="Betelgeuse">Betelgeuse</option>
							<option value="Canopus">Canopus</option>
							<option value="Capella">Capella</option>
							<option value="Deneb">Deneb</option>
							<option value="Denebola">Denebola</option>
							<option value="Diphda">Diphda</option>
							<option value="Dubhe">Dubhe</option>
							<option value="Elnath">Elnath</option>
							<option value="Eltanin">Eltanin</option>
							<option value="Enif">Enif</option>
							<option value="Fomalhaut">Fomalhaut</option>
							<option value="Gacrux">Gacrux</option>
							<option value="Gienah">Gienah</option>
							<option value="Hadar">Hadar</option>
							<option value="Hamal">Hamal</option>
							<option value="Kaus Australis">Kaus Australis</option>
							<option value="Kochab">Kochab</option>
							<option value="Markab">Markab</option>
							<option value="Menkar">Menkar</option>
							<option value="Menkent">Menkent</option>
							<option value="Miaplacidus">Miaplacidus</option>
							<option value="Mirfak">Mirfak</option>
							<option value="Nunki">Nunki</option>
							<option value="Peacock">Peacock</option>
							<option value="Polaris">Polaris</option>
							<option value="Pollux">Pollux</option>
							<option value="Procyon">Procyon</option>
							<option value="Rasalhague">Rasalhague</option>
							<option value="Regulus">Regulus</option>
							<option value="Rigel">Rigel</option>
							<option value="Rigil Kent">Rigil Kent</option>
							<option value="Sabik">Sabik</option>
							<option value="Schedar">Schedar</option>
							<option value="Shaula">Shaula</option>
							<option value="Sirius">Sirius</option>
							<option value="Spica">Spica</option>
							<option value="Suhail">Suhail</option>
							<option value="Vega">Vega</option>
							<option value="Zubenelgenubi">Zubenelgenubi</option>
						</select>

						<!-- Upper/Lower limb -->
						<select id="limb">
							<option value="LOWER" selected>Lower Limb</option>
							<option value="UPPER">Upper Limb</option>
						</select>

					</td>
				</tr>
				<tr>
					<!-- Instrumental elevation -->
					<td>Sextant Elevation:</td>
					<td>
						<input type="number"
								id="sextant-degrees"
								placeholder="Deg"
								title="Elevation degrees"
								style="width: 40px; text-align: center;"
								min="0"
								max="90"
								step="1"
								value="0"/>
						<span>&deg;</span>
						<input type="number"
								id="sextant-minutes"
								placeholder="Minutes"
								title="Elevation minutes"
								style="width: 60px; text-align: center;"
								min="0"
								max="59.99"
								step="0.01"
								value="00.00"/>
						<span>'</span>
					</td>
				</tr>
				<tr>
					<td>Eye Height (meters)</td>
					<td>
						<input type="number"
								id="eye-height"
								placeholder="Meters"
								title="Eye height above surface"
								style="width: 60px; text-align: center;"
								min="0"
								step="0.1"
								value="1.8"/>
						<span>m</span>
					</td>
				</tr>
			</table>
		</div>
		<div>
			<button onclick="calculateSR();" style="border-radius: 3px; box-shadow: 2px 2px silver;" title="Sight Reduction">Calculate</button>
			<button onclick="calculateSR(true);" style="border-radius: 3px; box-shadow: 2px 2px silver;" title="Calculate the Sextant elevation for your time and position">Reverse</button>
		</div>
		<div id="result" style="margin: 10px;"></div>
	</div>
	<hr/>
	<i>&copy; 2025, Oliv Cool Stuff Soft.</i>

</body>
</html>
