<!DOCTYPE html>
<html>
<!--
 | Requires the leafletjs resources to be in a "leaflet" directory under "web".
 | Available from http://leafletjs.com/
 | Tutorials and examples at https://leafletjs.com/examples.html
 | Note: No native way to change orientation
 +-->
<head>

    <title>Tide Stations - Leaflet. WiP.</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" /-->
    <!-- link rel="icon" type="image/ico" href="icons/hammerhead.02.ico" -->
    <link rel="icon" type="image/png" href="./wave.02.jpeg">

    <!--
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

    <script type="module">
import * as tideEngine from './tideEngine.js';

// Adding features to the Date object.
import * as dateFmt from './date.proto.js';

const THE_YEAR = new Date().getYear() + 1900;
const VERBOSE = false;

let before = 0.0;
let after = 0.0;

let tideStations = tideEngine.default.getStations(); // ["stations"];
let mess = `We have ${Object.keys(tideStations).length} stations. ${ VERBOSE ? `retrieved in ${after - before} ms.)` : '' }`;
console.log(mess);

// Spit out station list, sorted, if needed.
let listContent = "<pre>";
Object.keys(tideStations).sort().forEach(station => {
    listContent += `${decodeURIComponent(station)}, ${tideEngine.decToSex(tideStations[station].latitude, 'NS')  + '/' +
                        tideEngine.decToSex(tideStations[station].longitude, 'EW')} \n`; 
});
listContent += "</pre>";

// Populate a drop-down list
let selectList = document.getElementById('station-list');
while (selectList.length > 0) {
    selectList.remove(0);
}
Object.keys(tideStations).sort().forEach(station => {
    let el = document.createElement("option");
    el.textContent = decodeURIComponent(station); 
    el.value = station;
    selectList.appendChild(el);
});

// Expose outside the module, functions, variables, etc.
window.tideStations = tideStations;
window.tideEngine = tideEngine;
window.THE_YEAR = THE_YEAR;

console.log("Done with inner Module");

    </script>
</head>
<body style='font-family: "Source Code Pro", "Courier New", Helvetica, Geneva; font-weight: bold;'>
<h2>Tide Stations</h2>    
OpenSource JavaScript map API at <a href="https://leafletjs.com/" target="leaflet">leafletjs.com</a>
<table>
    <tr>
        <td valign="top">
            <!--div id="mapid" style="width: 1200px; height: 800px;"></div-->
            <div id="mapid" style="width: 1200px; height: 600px;"></div>
        </td>
        <td valign="top" style="text-align: right;">
            <div id="curr-pos"></div>
            <div id="station-list-div" style="margin-top: 10px;">
                <select id="station-list" style="max-width: 200px;"></select>
                <button onclick="go();" title="Click to go">Go!</button>            
            </div>
        </td>
    </tr>
</table>

<script>

function go() {
    let stationName = document.getElementById("station-list").value; // From the list
    let station = tideEngine.default.findTideStation(stationName, THE_YEAR);
    if (station !== null) {
        console.log(`${stationName} was found: ${decodeURIComponent(station.fullName)}`);
        console.log(`Base height: ${station.baseHeight} ${station.unit}`);
        console.log(`Pos: ${station.latitude} ${station.longitude}`);
        /*
        | Try
        | - map.panTo(new L.LatLng(40.737, -73.923));
        | - map.setView(new L.LatLng(40.737, -73.923), 8);
        | - map.flyTo(new L.LatLng(40.737, -73.923));
        */
        map.panTo(new L.LatLng(station.latitude, station.longitude));
    }
}

let map = L.map('mapid'); // .setView([51.505, -0.09], 13);

// L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
//     maxZoom: 28,
//     attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
//     '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
//     'Imagery © <a href="http://mapbox.com">Mapbox</a>',
//     id: 'mapbox.streets'
// }).addTo(map);

L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    accessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',
    tileSize: 512,
    maxZoom: 28,
    zoomOffset: -1,
    id: 'mapbox/streets-v11'
}).addTo(map);

// map.setView([0, 0], 3);
map.setView([47.5, -3.0], 8);

map.addEventListener('mousemove', (event) => {
    // let lat = Math.round(event.latlng.lat * 100000) / 100000;
    // let lng = Math.round(event.latlng.lng * 100000) / 100000;
    let lat = event.latlng.lat;
    let lng = event.latlng.lng;
    while (lng > 180) {
        lng -= 360;
    }
    while (lng < -180) {
        lng += 360;
    }
    document.getElementById('curr-pos').innerHTML = `${tideEngine.decToSex(lat, "NS")}<br/>${tideEngine.decToSex(lng, "EW")}`;
});

window.onload = () => {
    // document.getElementById('point-card').innerText = `${latlngs.length} points.`;
    console.log("Data loaded!");
    Object.keys(tideStations).sort().forEach(station => {
        L.marker([tideStations[station].latitude, tideStations[station].longitude])
            .addTo(map)
            .bindPopup(`<b>${decodeURIComponent(station)}</b><br/>Base Height: ${tideStations[station].baseHeight.toFixed(2)} ${tideStations[station].unit}<br/><a href="#" onclick="alert('Soon.');">Current Status</a>`)
            .bindTooltip(`${decodeURIComponent(station)}`);                                
    });
    console.log("Markers loaded!");
};

</script>

</body>
</html>
