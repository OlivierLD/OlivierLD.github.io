<!DOCTYPE html>
<html>
<!--
 | Requires the leafletjs resources to be in a "leaflet" directory under "web".
 | Available from http://leafletjs.com/
 | Tutorials and examples at https://leafletjs.com/examples.html
 | Note: No native way to change orientation
 +-->
<head>

    <title>Tide Stations - Leaflet. WiP.</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!--link rel="shortcut icon" type="image/x-icon" href="docs/images/favicon.ico" /-->
    <!-- link rel="icon" type="image/ico" href="icons/hammerhead.02.ico" -->
    <link rel="icon" type="image/png" href="./wave.02.jpeg">

    <style type="text/css">
.dialog-header {
    width: 103%;
    margin-left: -16px;
    margin-top: -16px;
    padding: 10px;
    font-size: 16px;
    font-family: 'Courier New', Courier, monospace;
    font-weight: 700;
    background-color: silver;
}

.dialog-header-close {
    margin-left: 10px;
    float: right;
}
.dialog-header-close:hover {
  color: cyan;
  cursor: pointer;
}

dialog {
    border-radius: 5px;
    border: 2px solid navy;
}        
dialog#generated-curve-dialog {
    z-index: 500;
    min-width: 400px;
    min-height: 300px;
}
    </style>
    <!--
    <link rel="stylesheet" href="leaflet/leaflet.css" />
    <script src="leaflet/leaflet.js"></script>
    -->

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
          integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
            integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
            crossorigin=""></script>

    <script type="module">
import * as tideEngine from './tideEngine.js';

// Adding features to the Date object.
import * as dateFmt from './date.proto.js';

const THE_YEAR = new Date().getYear() + 1900;
const VERBOSE = false;

let before = 0.0;
let after = 0.0;

let tideStations = tideEngine.default.getStations(); // ["stations"];
let mess = `We have ${Object.keys(tideStations).length} stations. ${ VERBOSE ? `retrieved in ${after - before} ms.)` : '' }`;
console.log(mess);

// Spit out station list, sorted, if needed.
let listContent = "<pre>";
Object.keys(tideStations).sort().forEach(station => {
    listContent += `${decodeURIComponent(station)}, ${tideEngine.decToSex(tideStations[station].latitude, 'NS')  + '/' +
                        tideEngine.decToSex(tideStations[station].longitude, 'EW')} \n`; 
});
listContent += "</pre>";

// Populate a drop-down list
let selectList = document.getElementById('station-list');
while (selectList.length > 0) {
    selectList.remove(0);
}
Object.keys(tideStations).sort().forEach(station => {
    let el = document.createElement("option");
    el.textContent = decodeURIComponent(station); 
    el.value = station;
    selectList.appendChild(el);
});

// Expose outside the module, functions, variables, etc.
window.tideStations = tideStations;
window.tideEngine = tideEngine;
window.THE_YEAR = THE_YEAR;

console.log("Done with inner Module");

    </script>
</head>
<body style='font-family: "Source Code Pro", "Courier New", Helvetica, Geneva; font-weight: bold;'>

<dialog id="generated-curve-dialog">
    <div class="dialog-header">
        <span>Status</span>
        <span class="dialog-header-close" onclick="closeGeneratedDialog();">&times</span>
    </div>
    <div style="text-align: left; max-height: 300px; overflow-y: scroll;">
        <pre><span id="generated-graph">Soon!</span></pre> <!-- This contains the curve -->
    </div>
</dialog>    
    

<h2>Tide Stations</h2>    
OpenSource JavaScript map API at <a href="https://leafletjs.com/" target="leaflet">leafletjs.com</a>
<table>
    <tr>
        <td valign="top">
            <!--div id="mapid" style="width: 1200px; height: 800px;"></div-->
            <div id="mapid" style="width: 1200px; height: 600px;"></div>
        </td>
        <td valign="top">
            <div id="curr-pos" style="min-height: 40px; text-align: right;"></div>
            <small>Choose your station, hit a button</small>
            <div id="station-list-div" style="margin-top: 10px;">
                <select id="station-list" style="max-width: 200px;"></select>
                <button onclick="go(PAN);" title="Click to pan">Pan</button>            
                <button onclick="go(FLY);" title="Click to fly">Fly</button>            
            </div>
        </td>
    </tr>
</table>

<script>

// Show/Hide generated graphics dialog
function showGeneratedDialog() {
    let codeDialog = document.getElementById("generated-curve-dialog");
    codeDialog.show();
}
function closeGeneratedDialog() {
    let codeDialog = document.getElementById("generated-curve-dialog");
    codeDialog.close();    
}

const FLY = 1;
const PAN = 2;
// On button click
function go(mode) {
    let stationName = document.getElementById("station-list").value; // From the list
    let station = tideEngine.default.findTideStation(stationName, THE_YEAR);
    if (station !== null) {
        console.log(`${stationName} was found: ${decodeURIComponent(station.fullName)}`);
        console.log(`Base height: ${station.baseHeight} ${station.unit}`);
        console.log(`Pos: ${station.latitude} ${station.longitude}`);
        /*
        | Try
        | - map.panTo(new L.LatLng(40.737, -73.923));
        | - map.setView(new L.LatLng(40.737, -73.923), 8);
        | - map.flyTo(new L.LatLng(40.737, -73.923));
        */
        if (mode === FLY) {
            map.flyTo(new L.LatLng(station.latitude, station.longitude));
        } else {  // PAN
            map.panTo(new L.LatLng(station.latitude, station.longitude));
        }

    } else {
        console.log(`Oops. Station ${stationName} not found.`);
    }
}

let map = L.map('mapid'); // .setView([51.505, -0.09], 13);

// L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
//     maxZoom: 28,
//     attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
//     '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
//     'Imagery © <a href="http://mapbox.com">Mapbox</a>',
//     id: 'mapbox.streets'
// }).addTo(map);

L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
    accessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
    attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',
    tileSize: 512,
    maxZoom: 28,
    zoomOffset: -1,
    id: 'mapbox/streets-v11'
}).addTo(map);

// map.setView([0, 0], 3);
map.setView([47.5, -3.0], 6);

map.addEventListener('mousemove', (event) => {
    // let lat = Math.round(event.latlng.lat * 100000) / 100000;
    // let lng = Math.round(event.latlng.lng * 100000) / 100000;
    let lat = event.latlng.lat;
    let lng = event.latlng.lng;
    while (lng > 180) {
        lng -= 360;
    }
    while (lng < -180) {
        lng += 360;
    }
    document.getElementById('curr-pos').innerHTML = `${tideEngine.decToSex(lat, "NS")}<br/>${tideEngine.decToSex(lng, "EW")}`;
});

window.onload = () => {
    console.log("Data loaded!");
    Object.keys(tideStations).sort().forEach(station => {
        let stationObj = tideStations[station];
        let popupContent = `<b>${decodeURIComponent(station)}</b><br/>`;
        if (stationObj.tideStation) {
            popupContent += `Base Height: ${stationObj.baseHeight.toFixed(2)} ${stationObj.unit}<br/>`;
            popupContent += "Tide Station<br/>";
        } else {
            popupContent += "Current Station<br/>";
        }
        popupContent += '<a href="#" onclick="showGeneratedDialog();">Current Status</a>';

        L.marker([stationObj.latitude, stationObj.longitude])
            .addTo(map)
            .bindPopup(popupContent)
            .bindTooltip(`${decodeURIComponent(station)}`);                                
    });
    console.log("Markers loaded!");
};

</script>

</body>
</html>
