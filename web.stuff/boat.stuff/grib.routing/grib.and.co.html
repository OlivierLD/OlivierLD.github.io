<!--
    Printable and translatable.
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>GRIBs, polaires, routage</title>
    <!--author>Olivier Le Diouris</author-->
    <meta name="author" content="Olivier Le Diouris">
    <link rel="icon" type="image/png" href="../small.boat.png">
    <!--script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script-->
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

    <!--link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" integrity="sha384-zB1R0rpPzHqg7Kpt0Aljp8JPLqbXI3bhnPWROx27a9N0Ll6ZP/+DiW/UqRcLbRjq" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js" integrity="sha384-y23I5Q6l+B6vatafAwxRu/0oK/79VlbSz7Q9aiSZUvyWYIYsd+qj+o24G5ZU2zJz" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js" integrity="sha384-kWPLUVMOks5AQFrykwIup5lo0m3iMkkHrD0uJ4H5cjeGihAutqP0yW0J6dpFiVkI" crossorigin="anonymous" onload="renderMathInElement(document.body);"></script-->

    <!--script type="text/javascript"-->
    <!--script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [['$','$'], ['\\(','\\)']]
        }
    });
    </script-->

    <script type="text/javascript">
        // That one is OK for the matrixes.
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"] ],
            displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        },
        "HTML-CSS": {
            availableFonts: ["TeX"] /* ,
            availableFonts: [],
            // Disable preferred fonts to ensure web fonts are used
            preferredFont: null,
            // Force the use of the Neo-Euler web font for rendering math
            webFont: "TeX" // "Neo-Euler" */
        }
    });
    </script>

    <link rel="stylesheet" href="../../nse/main.css" />
    <!-- link rel="stylesheet" media="screen" href="main.css" /-->
    <link rel="stylesheet" media="print" href="../../nse/print.css" />

    <style type="text/css">
        body {
            width: fit-content;
        }
    </style>
</head>

<section id="fr-content" style="display: none;">
    <h1><a name="least-squares">GRIBs, polaires, routage</a></h1>
    <span class="screen-only">Traduisible et imprimable</span>
    <a class="screen-only" href="javascript:void(0)" onclick="navTo('EN');"><img src="../../../systems/images/us_uk_flag.png" style="width: 30px;" title="In English" alt="In English"></a>
    <hr class="screen-only"/>
    <p>
        On veut en d&eacute;finitive faire un routage pour le bateau, c'est &agrave; dire de d&eacute;terminer la route optimale entre un point de d&eacute;part et un point d'arriv&eacute;e, en tenant compte des conditions m&eacute;t&eacute;orologiques (vent, courant, vagues) et des performances du bateau (polaires).<br/>
        Pour cela, il faut disposer de plusieurs &eacute;lements :<br/>
        <ul>
            <li>Les polaires du bateau</li>
            <li>Les donn&eacute;es m&eacute;t&eacute;orologiques, g&eacute;n&eacute;ralement au format GRIB</li>
            <li>Un algorithme de routage</li>
        </ul>
        Ce document pr&eacute;sente ces diff&eacute;rents &eacute;l&eacute;ments, et donne quelques pistes pour r&eacute;aliser un tel routage.
    </p>
    <p>
        <h2>GRIB</h2>
        L'acronyme GRIB signifie "GRIdded Binary" (binaire en grille).<br/>
        C'est un format de fichier binaire standard pour la diffusion de donn&eacute;es m&eacute;t&eacute;orologiques.<br/>
        Il est utilis&eacute; pour transmettre des pr&eacute;visions m&eacute;t&eacute;orologiques, notamment les vents, la pression atmosph&eacute;rique, les temp&eacute;ratures, etc., sur une grille g&eacute;ographique
        et temporelle.<br/>
        Pour obtenir des fichiers GRIB, il faut addresser une requ&ecirc;te &agrave; un serveur de donn&eacute;es m&eacute;t&eacute;orologiques, en pr&eacute;cisant la r&eacute;gion g&eacute;ographique, la p&eacute;riode et les param&egrave;tres souhait&eacute;s.<br/>
        Pour la zone, et la p&eacute;riode, on pr&eacute;cisera aussi le maillage (r&eacute;solution) de la grille.<br/>
        <i>Exemple :</i>
        <div class="postit bordered-box">
            GFS:65N,45S,130E,110W|2,2|0,6..24|PRMSL,WIND,HGT500,TEMP,WAVES,RAIN
        </div>
        La requ&ecirc;te ci-dessus concerne :<br/>
        <ul>
            <li>la zone g&eacute;ographique d&eacute;limit&eacute;e par les coordonn&eacute;es 65N,45S,130E,110W (coin sup&eacute;rieur gauche 65N-130E, coin inf&eacute;rieur droit 45S-110E), c'est l'Oc&eacute;an Pacifique</li>
            <li>un maillage de 2&deg; en latitude et 2&deg; en longitude</li>
            <li>des pr&eacute;visions &agrave; 0h, 6h, 12h, 18h et 24h (toutes les 6H, pendant 14H)</li>
            <li>les param&egrave;tres suivants : pression au niveau de la mer (PRMSL), vent (WIND), hauteur g&eacute;opotentielle &agrave; 500 hPa (HGT500), temp&eacute;rature (TEMP), vagues (WAVES) et pr&eacute;cipitations (RAIN)</li>
        </ul>
        La taille du fichier GRIB esp&eacute;r&eacute; est bien &eacute;videmment fonction de la taille de la zone, du maillage, de la p&eacute;riode et des param&egrave;tres demand&eacute;s.<br/>
        Plus le maillage est serr&eacute;, plus les param&egrave;tres sont nombreux, plus la p&eacute;riode est longue, plus le fichier sera volumineux.<br/>
        <div style="font-style: italic; margin: 10px; padding: 5px; border: 1px solid gray; border-radius: 5px; background-color: #f0f0f0;">
            <b>Note :</b><br/>
            Afin de diminuer la taille des fichiers &agrave; recevoir - on n'a pas toujours un d&eacute;bit Internet infini - on peut jouer sur le maillage, et proc&eacute;der ensuite &agrave; un lissage des donn&eacute;es.<br/>
            &Ccedil;a n'est certes pas aussi pr&eacute;cis, mais bien souvent le r&eacute;sutat est suffisant pour la navigation de plaisance.
        </div>
        <div>
            Le fichier re&ccedil;u apr&egrave;s la requ&ecirc;te est un fichier binaire (num&eacute;rique), illisible en l'&eacute;tat.<br/>
            Mais son contenu peut &ecirc;tre visualis&eacute; avec un logiciel adapt&eacute; (on y reviendra). <!--, par exemple <a class="list-link" href="https://www.zygrib.org/" target="zyGrib">zyGrib</a> (gratuit).--><br/>
            Le format de son contenu peut sans ausun doute &ecirc;tre compare &agrave; celui d'une feuille Excel (on dit feuille de calcul !), avec des lignes et des colonnes, chaque cellule contenant une valeur pour un param&egrave;tre donn&eacute; (vent, pression, temp&eacute;rature, etc) &agrave; une
            position g&eacute;ographique (latitude, longitude) et &agrave; un instant donn&eacute; (heure de la pr&eacute;vision).<br/>
            <div style="text-align: center;">
                <img src="docs/grib.04.png" title="Contenu du GRIB" style="max-width: 80%; border: 1px solid black;"/>
            </div>
            Au dessus, les onglets correspondant aux diff&eacute;rentes dates et heures, en dessous, les onglets des param&egrave;tres disponibles.<br/>
        </div>
        <div style="margin-top: 10px;">
            Voyons la requ&ecirc;te suivante :
            <div class="postit bordered-box">
                GFS:65N,14N,100W,10E|4,4|0,12..168|PRMSL,WIND,HGT500,TEMP,WAVES,RAIN
            </div>
            On y remarque que le maillage est de 4&deg; en latitude et 4&deg; en longitude, au lieu de 2&deg; dans l'exemple pr&eacute;c&eacute;dent,
            et qu'on aura un grib toutes les 12 heures, au lieu de 6 pr&eacute;c&eacute;demment.<br/>
            Ceci devrait all&eacute;ger la taille du <a href="docs/NorthAtlantic_2025_12_23_09_10_41_CET.grb">fichier</a> &agrave; recevoir.<br/>
            En revanche, la definition est moindre, ainsi qu'on peut le voir ici :<br/>
            <div style="text-align: center;">
                <img src="docs/grib.01.png" title="Cellulles de 4 degr&eacute;s" style="max-width: 80%; border: 1px solid black;"/>
            </div>
            On voit bien que la d&eacute;finition du vent est moins bonne.<br/>
            Le lissage peut r&eacute;soudre cette situation, en appliquant un lissage de facteur 4 (on divise chaque cellule en 4&times;4=16).<br/>
            <div style="text-align: center;">
                <img src="docs/grib.02.png" title="Celulles de 1 degr&eacute;" style="max-width: 80%; border: 1px solid black;"/>
            </div>
            Ce lissage est appliqu&eacute; ici au vent, il s'appliquera de meme aux autres param&egrave;tres (PRMSL, 500MB, RAIN, TEMP, etc).<br/>
            Le lissage appliqu&eacute; ici est g&eacute;ographique, il peut aussi s'appliquer dans le temps, pour passer d'un intervalle de 12 heures &agrave; un intervalle de 3 heures, par exemple..<br/>
            <br/>
            Il peut aussi parfois &ecirc;tre int&eacute;ressant d'afficher les donn&eacute;es du GRIB en 3D :
            <div style="text-align: center;">
                <img src="docs/grib.03.png" title="PRMSL &ap; 500MB" style="max-width: 80%; border: 1px solid black;"/>
            </div>
        </div>
        <br/>
        Le standard des fichiers GRIB a deux versions (1, et 2). Il convient pour les exploiter de savoir quelle est la version du fichier re&ccedil;u, et de disposer d'un logiciel adapt&eacute;.<br/>
        <h3>Envoi d'une requ&ecirc;te</h3>
        On peut enover la requ&ecirc;te ci-dessus &agrave; <code>query@saildocs.com</code>, par email.<br/>
        Le sujet de l'email n'a pas d'importance, le corps du message contient la requ&ecirc;te, en <i><b>plain text</b></i>.<br/>
        Par exemple <a href="mailto:query@saildocs.com?subject=GRIBRequest&body=GFS:65N,45S,130E,110W|2,2|0,6..24|PRMSL,WIND,HGT500,TEMP,WAVES,RAIN" target="new">envoyer cette requ&ecirc;te</a> par email &agrave; Saildocs.<br/>
        La reponse arrive en g&eacute;n&eacute;ral en quelques minutes - voire secondes, avec un <a href="docs/GFS20251221161301416.grb">fichier GRIB</a> en pi&egrave;ce jointe.<br/>
        Plusieurs services permettent d'envoyer des requ&ecirc;tes GRIB, par exemple :<br/>
        <ul>
            <li><a class="list-link" href="https://www.ncei.noaa.gov/products/weather-climate-models/global-forecast-system" target="NCEI">NOAA NCEI GFS</a></li>
            <li><a class="list-link" href="https://www.ventusky.com/" target="Ventusky">Ventusky</a></li>
            <li><a class="list-link" href="https://www.passageweather.com/grib-files/" target="PassageWeather">Passage Weather</a></li>
            <li><a class="list-link" href="https://saildocs.com/" target="SailMail">https://saildocs.com/</a></li>
        </ul>
    </p>

    <p>
        <h2>Polaires</h2>
        Les polaires d'un bateau sont des courbes qui repr&eacute;sentent la vitesse du bateau en fonction de l'angle et de la force du vent apparent.<br/>
        Le vent apparent est celui qui fait avancer un voilier, c'est la combinaison du vent r&eacute;el et de la vitesse du bateau.<br/>
        Le vent apparent d&eacute;pendant du vent r&eacute;el et de la vitesse du bateau, les polaires permettent de d&eacute;terminer la vitesse du bateau pour une direction et une force de vent donn&eacute;es.<br/>

        Voir <a href="https://github.com/OlivierLD/ROB/blob/master/raspberry-sailor/PolarSmoother/README.md" target="PolarSmoother">ici</a> pour un outil de lissage des polaires.<br/>
    </p>

    <p>
        <h2>Routage</h2>
        Attention, c'est l&agrave; que les choses se compliquent un peu..., tout s'assemble !<br/>
        Plusieurs algorithmes de routage existent, avec des degr&eacute;s de complexit&eacute; variables.<br/>
        Le plus simple est le routage par Dijkstra, qui permet de trouver le chemin le plus court entre deux points dans un graphe pond&eacute;r&eacute;.<br/>
        <div style="font-style: italic; margin: 10px; padding: 5px; border: 1px solid gray; border-radius: 5px; background-color: #f0f0f0;">
            <b>Note : Objectifs du Routage</b><br/>
            En course, il s'agit &eacute;videmment d'arriver le plus vite possible &agrave; destination.<br/>
            En croisi&egrave;re, on peut aussi vouloir &eacute;viter les zones de mauvais temps, ou au contraire profiter de certaines conditions m&eacute;t&eacute;orologiques particuli&egrave;res.<br/>
            Le routage peut donc int&eacute;grer des crit&egrave;res suppl&eacute;mentaires, en plus du temps de parcours.<br/>
            Genre "Quarante n&oelig;uds sur le nez, non merci !"
        </div>
        <h3>Isochrones</h3>
        Les isochrones sont le lieu des positions atteignables par le bateau en un temps donn&eacute; (iso - &iota;&sigma;&omicron;: identique, chronos - &chi;&rho;&omicron;&nu;&omicron;&sigma; : temps. IsoChrone &rarr; temps identique. Lieu de points atteignables dans le m&ecirc;me temps.).<br/>
        Une m&eacute;thode de routage couramment utilis&eacute;e est la m&eacute;thode des isochrones.<br/>
        Elle consiste &agrave; tracer des lignes isochrones, c'est-&agrave;-dire des lignes qui repr&eacute;sentent les positions atteignables par le bateau en un temps donn&eacute;.<br/>
        En utilisant les polaires du bateau et les donn&eacute;es m&eacute;t&eacute;orologiques (GRIB), on peut calculer les isochrones &agrave; intervalles de temps r&eacute;guliers, en tenant compte des conditions de vent et de courant.<br/>
        En reliant les isochrones successifs, on obtient un graphe de positions possibles.<br/>
        On peut alors appliquer un algorithme de recherche de chemin (comme Dijkstra) pour trouver le chemin optimal entre le point de d&eacute;part et le point d'arriv&eacute;e.<br/>
        <h3>Enveloppes Convexes</h3>
        Donc, comme d&eacute;crit ci-dessus, &agrave; partir de la position de d&eacute;part, on calcule les lieu des points atteignables en un temps donn&eacute; - disons ici, par exemple, 3 heures - le calcul des
        points est fait par exemple tous les 10 degr&eacute;s.<br/>
        On obtient donc 36 points (360/10).<br/>
        De chacun de ces 36 points, on refait le m&ecirc;me calcul, pour obtenir les points atteignables en 3 heures suppl&eacute;mentaires (soit 6 heures depuis le d&eacute;part).<br/>
        Ce calcul s'effectue avec les donn&eacute;es du GRIB, pour chacun des points du premier isochone (o&ugrave; les conditions sont maintenant diff&eacute;rentes les unes des autres).<br/>
        On obtient donc 36 &times; 36 = 1.296 points.<br/>
        On continue ainsi jusqu'&agrave; atteindre le point d'arriv&eacute;e.<br/>
        Le nombre de points &agrave; g&eacute;rer devient rapidement tr&egrave;s important, c'est exponentiel !<br/>
        Au troisi&egrave;me isochrone, on aura 36 &times; 36 &times; 36 = 46.656 points, 1.679.616 au quatri&egrave;me ! Et ainsi de suite...<br/>
        Ceci peut mettre n'importe quel ordinateur - si puissant soit-il - sur le toit avant d'atteindre la destination.<br/>
        Il est donc n&eacute;cessaire de r&eacute;duire le nombre de points de chaque isochrone.<br/>
        Une m&eacute;thode efficace est d'utiliser l'enveloppe convexe des points.<br/><br/>
        L'enveloppe convexe est le plus petit polygone convexe qui contient tous les points.<br/>
        <i><b>Intuitivement</b></i>, c'est comme de mettre un &eacute;lastique autour des points, l'&eacute;lastique va se tendre pour englober tous les points, formant ainsi l'enveloppe convexe.<br/>
        En ne gardant que les points de l'enveloppe convexe (en &eacute;liminant ceux qui sont &agrave; l'int&eacute;rieur de l'&eacute;lastique), on r&eacute;duit significativement le nombre de points &agrave; g&eacute;rer.
        <div style="text-align: center;">
            <img src="docs/enveloppe.png" title="enveloppe convexe" style="max-width: 80%; border: 1px solid black;"/>
        </div>
        En rouge, les points du premier isochrone.<br/>
        En jaune et vert, ceux du deuxi&egrave;me.<br/>
        Seuls les points de l'enveloppe convexe (en vert) sont conserv&eacute;s. Les jaunes sont &eacute;limin&eacute;s.
        <p>
            . . .
        </p>
        <div style="text-align: center;">
            <img src="docs/routing.01.png" title="Routing" style="max-width: 80%; border: 1px solid black;"/>
        </div>

    </p>

</section>

<section id="en-content" style="display: none;">
    <h1><a name="least-squares">GRIBs, polars, routing</a></h1>
    <span class="screen-only">Translatable and printable</span>
    <a class="screen-only" href="javascript:void(0)" onclick="navTo('FR');"><img src="../../../systems/images/france.gif" style="width: 30px;" title="En fran&ccedil;ais" alt="En fran&ccedil;ais"></a>
    <p>
        WiP . . .
    </p>

</section>

<body>

<div id="full-content">
</div>

<hr/>
<address>
    <small>
        &copy; Olivier Le Diouris - 2025<br/>
        <a href="../index.html" target="_top">OlivierLD.github.io</a>
    </small>
</address>
</body>

<script type="text/javascript">

let navTo = (prm) => {
    let url = window.location.href;
    let newUrl = url.split('?')[0] + '?lang=' + prm;
    console.log("New URL: " + newUrl);
    window.location = newUrl;
};

let getQueryParameterByName = (name, url) => {
    if (!url) {
        url = window.location.href;
    }
    name = name.replace(/[\[\]]/g, "\\$&");
    let regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) {
        return null;
    }
    if (!results[2]) {
        return '';
    }
    return decodeURIComponent(results[2].replace(/\+/g, " "));
};

let translate = (lang) => {
    let enContent = document.getElementById('en-content');
    let frContent = document.getElementById('fr-content');

    let fullContent = document.getElementById('full-content');
    if (lang === 'FR') {
        // enContent.style.display = 'none';
        // frContent.style.display = 'block';
        fullContent.innerHTML = frContent.innerHTML;
    } else {
        // enContent.style.display = 'block';
        // frContent.style.display = 'none';
        fullContent.innerHTML = enContent.innerHTML;
    }
};

window.onload = () => { // Important: window.onload
    let userLang = getQueryParameterByName('lang');
    if (!userLang) {
        let browserUserLang = navigator.language || navigator.userLanguage;
        console.log("The browser's language is: " + browserUserLang);
        if (browserUserLang) {
            if (browserUserLang.substring(0, 2).toUpperCase() === 'FR') {
                userLang = 'FR';
                console.log("On va parler fran√ßais")
            } else {
                userLang = 'EN';
                console.log("We'll speak english");
            }
        }
    }
    if (userLang) {
        langToUse = userLang;
        console.log(`Lang to use will be ${langToUse}`);
    }
    if (langToUse !== 'FR') { // Then switch to French, default is EN.
        langToUse = 'EN';
    }
    translate(langToUse);
};
</script>

</html>
