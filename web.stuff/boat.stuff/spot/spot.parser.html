<!DOCTYPE html>
<!--
 ! Removed GoogleMaps,
 ! Replaced with Leaflet
 +-->
<html>
  <head>
    <title>spot.parser</title>
    <link rel="icon" type="image/jpg" href="../icons/hammerhead.02.ico">
    <script type="text/javascript" src="js/date.proto.js"></script>
    <script type="text/javascript" src="analog.display/AnalogDisplay.js"></script>
    <!--script type="text/javascript" src="temperature/Thermometer.js"></script-->
    <script type="text/javascript" src="direction/Direction.js"></script>
    <script type="text/javascript" src="rain/Pluviometer.js"></script>
    <script type="text/javascript" src="graph/graph.js"></script>
    <script type="text/javascript" src="spot.parser.js"></script>
    <script type="text/javascript">
// Line with arrow head
function Line(x1, y1, x2, y2) {
  this.x1 = x1;
  this.y1 = y1;
  this.x2 = x2;
  this.y2 = y2;
};
Line.prototype.drawWithArrowhead = function(ctx) {
  this.drawWithArrowheads(ctx, false);
};

Line.prototype.drawWithArrowheads = function(ctx, both) {
  if (both === undefined) {
    both = true;
  }
  // arbitrary styling
  ctx.strokeStyle = "blue";
  ctx.fillStyle   = "blue";
  ctx.lineWidth   = 1;

  // draw the line
  ctx.beginPath();
  ctx.moveTo(this.x1, this.y1);
  ctx.lineTo(this.x2, this.y2);
  ctx.stroke();

  if (both) {
    // draw the starting arrowhead
    let startRadians = Math.atan((this.y2 - this.y1) / (this.x2 - this.x1));
    startRadians += ((this.x2>this.x1)?-90:90) * Math.PI/180;
    this.drawArrowhead(ctx, this.x1, this.y1, startRadians);
  }
  // draw the ending arrowhead
  let endRadians=Math.atan((this.y2 - this.y1) / (this.x2 - this.x1));
  endRadians += ((this.x2>this.x1)?90:-90) * Math.PI/180;
  this.drawArrowhead(ctx, this.x2, this.y2, endRadians);
};

const HEAD_LENGTH = 10;
const HEAD_WIDTH  = 3;

Line.prototype.drawArrowhead = function(ctx, x, y, radians) {
  ctx.save();
  ctx.beginPath();
  ctx.translate(x, y);
  ctx.rotate(radians);
  ctx.moveTo(0, 0);
  ctx.lineTo( HEAD_WIDTH, HEAD_LENGTH);
  ctx.lineTo(-HEAD_WIDTH, HEAD_LENGTH);
  ctx.closePath();
  ctx.restore();
  ctx.fill();
};
    </script>
    <!--script src="http://maps.googleapis.com/maps/api/js?v=3&amp;sensor=false&amp;key=AIzaSyDu5cW4UXjXZTswehBdIO8jCZdzUbk2v5o"
            type="text/javascript"></script-->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
                
    <script type="text/javascript">
let displayScale = 0.75;

let displayTWD, displayTWS, displayPRMSL, displayRain, thermometer, graph, map;
let withTWD = true;
 
window.onload = () => {
   displayTWD   = new Direction('twdCanvas', 100 * displayScale, 45, 5);
   displayTWS   = new AnalogDisplay('twsCanvas',   100 * displayScale,   50, 10, 1, true, 40);
   displayPRMSL = new AnalogDisplay('prmslCanvas', 100 * displayScale, 1045, 10, 1, true, 50, 985, 0);
   displayRain  = new Pluviometer('rainCanvas');
   
   loadMap();
   setDefaultTimeZone();
};
 
function setDefaultTimeZone() {
  // For the best solution, check out https://bitbucket.org/pellepim/jstimezonedetect
  let tzOffset = 0;

  let re = new RegExp("GMT([+-]\\d{4}).*"); // Like xxx GMT+0100 (xxx)
  let now = new Date();
  let match = re.exec(now);
  if (match !== null) {
    tzOffset = parseInt(match[1]);
  }
  if (isNaN(tzOffset)) {
    tzOffset = 0;
  } else {
    tzOffset /= 100;
  }
   document.getElementById("tz").value = tzOffset;
}
 
function updateOnClick(idx, tws, twd, prmsl, rain) {
   let txtDate = SpotParser.nmeaData[idx].getNMEADate();
// console.log("Date is : " + reformatDate(txtDate));
   let utc = document.getElementById("tz");   
   document.getElementById("recno").innerHTML = "Record #<b style='color:red;'>" + (idx + 1) + "</b> of " + SpotParser.nmeaData.length + ", " +  reformatDate(txtDate) + " " + utc.options[utc.selectedIndex].text;

   let wd = parseFloat(twd);
   displayTWD.animate(wd);

   let ws = parseFloat(tws);
   displayTWS.animate(ws);
   
   let pr = parseFloat(prmsl);
   displayPRMSL.animate(pr);
   
   let prate = parseFloat(rain);
   displayRain.animate(prate);
   
   graph.drawGraph("graphCanvas", graphdata, idx);
// graph.drawGraph("graphCanvas", rainData, idx); // TODO Option
   if (withTWD) { // with wind
     graph.drawWind(SpotParser.nmeaData);
   }
  placeMarker({ lat: SpotParser.position.lat, lng: SpotParser.position.lng });
  spotMap.panTo(new L.LatLng(SpotParser.position.lat, SpotParser.position.lng));

}

const SPEED_PRM = 0.05;

function getIncLat(lat) {
   let il = Math.log(Math.tan((Math.PI / 4) + (toRadians(lat) / 2)));
   return toDegrees(il);
}

function toRadians(d) {
   return Math.PI * d / 180;
}

function toDegrees(d) {
   return d * 180 / Math.PI;
}

function decToSex(val, ns_ew) {
    let absVal = Math.abs(val);
    let intValue = Math.floor(absVal);
    let dec = absVal - intValue;
    let i = intValue;
    dec *= 60;
    let s = i + "&deg;" /*"°"*/ + dec.toFixed(2) + "'";

    if (val < 0) {
        s += (ns_ew === 'NS' ? 'S' : 'W');
    } else {
        s += (ns_ew === 'NS' ? 'N' : 'E');
    }
    return s;
}

function reformatDate(utcDate, fmt) {
   if (fmt === undefined) {
     fmt = "D d-M-Y H:i";
   }
   let month = 0, day = 0, hours = 0, minutes = 0;
   // 07-03 00:00
   let dateRegExpr = new RegExp("(\\d{2})-(\\d{2})\\s(\\d{2}):(\\d{2})");
   let matches = dateRegExpr.exec(utcDate);
   if (matches !== null) {
     month   = matches[1];
     day     = matches[2];
     hours   = matches[3];
     minutes = matches[4];
   }
   let date = new Date();
   date.setMonth(parseInt(month - 1));
   date.setDate(parseInt(day));
   date.setHours(parseInt(hours));
   date.setMinutes(parseInt(minutes));
   date.setSeconds(0);
// console.log(date.toString());
   let time = date.getTime();
   let offset = parseInt(document.getElementById("tz").value);
   offset *= (60 * 60 * 1000); // 1 hour, in ms.
   time += offset;
   date = new Date(time);
// console.log("becomes: " + date.toString());
   return date.format(fmt);
}

let graphdata = [];
//let rainData = []; // rain
// Parse the data
function onDataChange() {
   let text = document.getElementById("spot").value;  
   let htmlLink = "";

   graphdata = []; // TWS
// rainData = []; // rain
   if (text.length > 0) {
     htmlLink = SpotParser.parse(text, 'updateOnClick', setPosOnMap);
     let nmeaData = SpotParser.nmeaData;
     for (let i=0; i<nmeaData.length; i++) {
       graphdata.push(new Tuple(i, parseFloat(nmeaData[i].getNMEATws())));
//     rainData.push(new Tuple(i, parseFloat(nmeaData[i].getNMEARain())));
     }
     graph = new Graph("graphCanvas", 650, 200, graphdata);
     
     if (withTWD) { // with wind
       graph.drawWind(nmeaData);
     }
   }
   document.getElementById("links").innerHTML = htmlLink;
}
 
function setPosOnMap() {
  try {
    placeMarker({ lat: SpotParser.position.lat, lng: SpotParser.position.lng });
    spotMap.panTo(new L.LatLng(SpotParser.position.lat, SpotParser.position.lng));
  } catch (err) {
     // ...
  }
}
 
function animateSpot() {
   let animateButton = document.getElementById("animate-button");
   if (!keepWorking) {
     animateButton.innerHTML = "Stop";
   } else {
     animateButton.innerHTML = "Animate";
   }
   if (!keepWorking) {
     let data = SpotParser.nmeaData;
     if (data !== undefined && data !== null && data.length > 0) {
  //   alert("There are " + data.length + " records");
       keepWorking = true;
       scrollData(0);
     } else {
       alert("Parse some data first...");
       animateButton.innerHTML = "Animate";
     }
   } else {
     keepWorking = false;
   }
}
 
let keepWorking = false;
 
function scrollData(i) {
   let data = SpotParser.nmeaData[i];
   graph.drawGraph("graphCanvas", graphdata, i);
// graph.drawGraph("graphCanvas", rainData, i); // TODO on option

   let utc = document.getElementById("tz");   
   document.getElementById("recno").innerHTML = "Record #<b style='color:red;'>" + (i + 1) + "</b> of " + SpotParser.nmeaData.length + ", " +  data.getNMEADate() + " " + utc.options[utc.selectedIndex].text;
   updateOnClick(i, data.getNMEATws(), data.getNMEATwd(), data.getNMEAPrmsl(), data.getNMEARain());
   if (i < (SpotParser.nmeaData.length - 1) && keepWorking) {
     setTimeout(function() { 
                  scrollData(i+1); 
                }, 1000);
   } else {
     keepWorking = false;
     let animateButton = document.getElementById("animate-button");
     animateButton.innerHTML = "Animate";
     document.getElementById("recno").innerHTML = "Done.";
   }
}
 
let defaultLocation = "0.0N,0.0E"; 
let spotMap = null; // L.map('map'); // Leaflet, Google,...
 
function loadMap() {
  spotMap = L.map('map'); // .setView([currentLatitude, currentLongitude], 13);
  spotMap.setView([0, 0], 3);

  L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}', {
      accessToken: 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
      attribution: '© <a href="https://www.mapbox.com/about/maps/">Mapbox</a> © <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> <strong><a href="https://www.mapbox.com/map-feedback/" target="_blank">Improve this map</a></strong>',
      tileSize: 512,
      maxZoom: 18,
      zoomOffset: -1,
      id: 'mapbox/streets-v11'
  }).addTo(spotMap);

  spotMap.addEventListener('mousemove', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        let lat = event.latlng.lat;
        let lng = event.latlng.lng;
        while (lng > 180) { // Leaflet does that...
            lng -= 360;
        }
        while (lng < -180) { // And this too
            lng += 360;
        }
        // TODO Something smart if needed
        // document.getElementById('curr-pos').innerHTML = `${decToSex(lat, "NS")}<br/>${decToSex(lng, "EW")}`;
        // document.getElementById('curr-pos-dec').innerHTML = `${lat}<br/>${lng}`;
    });
    spotMap.addEventListener('click', (event) => {
        // let lat = Math.round(event.latlng.lat * 100000) / 100000;
        // let lng = Math.round(event.latlng.lng * 100000) / 100000;
        let lat = event.latlng.lat;
        let lng = event.latlng.lng;
        while (lng > 180) {
            lng -= 360;
        }
        while (lng < -180) {
            lng += 360;
        }

        placeMarker({ lat: lat, lng: lng });
        // document.getElementById('curr-pos-click').innerHTML = `${decToSex(lat, "NS")}<br/>${decToSex(lng, "EW")}`;
        // document.getElementById('curr-pos-click-dec').innerHTML = `${lat}<br/>${lng}`;
    });
}
 
let theMarker = null;

function placeMarker(location) {
  if (theMarker !== null) {
    spotMap.removeLayer(theMarker)
  }
  theMarker = L.marker([location.lat, location.lng]);

  theMarker.addTo(spotMap)
           .bindPopup(`<b>Bulletin request for this location.<br/><span style="color: red;">${decToSex(location.lat, "NS")}<br/>${decToSex(location.lng, "EW")}</span></b>`);
  spotMap.panTo(new L.LatLng(location.lat, location.lng));

  defaultLocation = (location.lat > 0?(location.lat + "N"):(-location.lat + "S")) + "," +
                    (location.lng > 0?(location.lng + "E"):(-location.lng + "W"));
  buildRequest();
}

function buildRequest() {
   // Like spot:37.5N,122.5W|5,3|PRMSL,WIND,RAIN
   let spot = document.getElementById("spot-req");
   let req = "send spot:";
   req += (defaultLocation + "|");
   req += (document.getElementById("nb-days").value + "," + 
           document.getElementById("interval").value + "|");
//   let data = "";
//   if (document.getElementById("PRMSL").checked)
//     data += "PRMSL";
//   if (document.getElementById("WIND").checked)
//     data += ((data.length > 0?",":"") + "WIND");
//   if (document.getElementById("RAIN").checked)
//     data += ((data.length > 0?",":"") + "RAIN");
   let data = "PRMSL,WIND,RAIN";
   req += data;
   
   spot.innerHTML = req;
}
 
function compose() {
   let anchor = document.getElementById("custom-request");
   let href = "mailto:query@saildocs.com?subject=spot&body=" + document.getElementById("spot-req").innerHTML.replace(" ", "%20");
   anchor.href = href;
}

function showHelpDialog() {
  let weatherDialog = document.getElementById("spot-help");
  weatherDialog.show();
}

function closeHelpDialog() {
  let weatherDialog = document.getElementById("spot-help");
  weatherDialog.close();
}
    </script>
    <link rel="stylesheet" href="css/stylesheet.css" type="text/css"/>
    <style type="text/css">
.displayCanvas {
  border: 1px solid #9C9898;
  border-radius: 5px;
  opacity:0.9;
}
.display-scheme {
  color: white;
}
.dialog-header {
    font-size: 24px;
    font-weight: 700;
}

.dialog-header-close {
  float: right;
}
.dialog-header-close:hover {
  color: cyan;
  cursor: pointer;
}
    </style>
  </head>
  <body> <!-- onunload="GUnload();" -->    

    <dialog id="spot-help" style="width: 400px; border-radius: 8px; z-index: 10;">
      <div class="dialog-header">
        <span>What's a SPOT bulletin...</span>
        <span class="dialog-header-close" onclick="closeHelpDialog();">&times</span>
      </div>
      A SPOT bulletin is an extraction from a GRIB file, for a given location.
      <br/>
      You can obtain a SPOT bulletin by sending an email request to the address mentionned here.
      <br/>
      This page will help you to build the request. 
      Click on the map to define the spot you want the bulletin for, define the number of days, and the interval.
      <br/>
      Then send the generated request, through your favorite email client <b>in text format</b></b>.
      <br/>
      The bulletin should come to you within a few minutes, if not seconds.
      <br/>
      Then copy its content, and paste it in the box expecting it.
      <br/>
      And you're done!
    </dialog>
  
    <table>
      <tr>
        <td valign="top" colspan="4">
          <h2>Spot GRIB Parser <a href="#" onclick="showHelpDialog();" title="Help!">?</a></h2>
          <h4>Uses <a href="https://leafletjs.com/" target="leaflet">LeafLet</a></h4>
        </td>
        <td colspan="1" valign="top" rowspan="2" style="text-align: right;">
          <textarea id="spot" 
                    style="margin: 2px; height: 100px; width: 365px;" 
                    onchange="onDataChange();" 
                    placeholder="Paste SPOT bulletin here, and tab out." 
                    title="Paste here the bulletin&#13;received by email, at least from the top&#13;to the last data line."></textarea>
          <br/>
          <small>
            Paste your spot bulletin &uarr; in the box above, <b>including the header lines</b>.</small>
          </small>
        </td>
      </tr>
      <tr>
        <td valign="top" colspan="4">
          Send this spot request to <a href="mailto:query@saildocs.com?subject=spot" id="custom-request" onclick="compose();" target="mail">query@saildocs.com</a>:
          <div id="spot-req" style="color: red;">send spot:0.0N,0.0E|5,3|PRMSL,WIND,RAIN</div>
          <small>Request in the body, <i>as text</i>, any subject.</small>
        </td>
      </tr>
      <tr>
        <td colspan="4" valign="top">
          <table>
            <tr>
              <td colspan="4">Click on the map to locate the spot.</td>
            </tr>
            <tr>
              <td> Number of  days</td>
              <td style="text-align: right;">
                <select id="nb-days" onchange="buildRequest();" style="direction: rtl;">
                   <option value="1">1</option>
                   <option value="2">2</option>
                   <option value="3">3</option>
                   <option value="4">4</option>
                   <option value="5" selected="true">5</option>
                   <option value="6">6</option>
                   <option value="7">7</option>
                 </select>
              </td>
            <!--/tr>
            <tr-->
              <td>Interval in hours</td>
              <td style="text-align: right;">
                <select id="interval" onchange="buildRequest();" style="direction: rtl;">
                  <option value="3" selected="true">3</option>
                  <option value="6">6</option>
                  <option value="9">9</option>
                  <option value="12">12</option>
                  <option value="24">24</option>
                </select>
              </td>
            </tr>
            <!--tr>
              <td>Data to retreive</td> 
              <td>
                <input type="checkbox" id="PRMSL" checked="true" onchange="buildRequest();">PRMSL</input>&nbsp;
                <input type="checkbox" id="WIND" checked="true" onchange="buildRequest();">WIND</input>&nbsp;
                <input type="checkbox" id="RAIN" checked="true" onchange="buildRequest();">RAIN</input>    
              </td>
            </tr-->  
          </table>
        </td>
        <td rowspan="7" valign="top"><div id="map" style="width: 400px; height: 530px; z-index: 0;"></div></td>
      </tr>
      <tr>
        <td style="text-align: left;" colspan="4">
          Your time zone:
          <select id="tz" style="direction: ltr; font-family: 'Source Code Pro', 'courier new';">
            <option value="-12">UTC-12</option>
            <option value="-11">UTC-11</option>
            <option value="-10">UTC-10</option>
            <option value="-9">UTC -9</option>
            <option value="-8">UTC -8</option>
            <option value="-7">UTC -7</option>
            <option value="-6">UTC -6</option>
            <option value="-5">UTC -5</option>
            <option value="-4">UTC -4</option>
            <option value="-3">UTC -3</option>
            <option value="-2">UTC -2</option>
            <option value="-1">UTC -1</option>
            <option value="0">UTC &plusmn;0</option>
            <option value="1">UTC +1</option>
            <option value="2">UTC +2</option>
            <option value="3">UTC +3</option>
            <option value="4">UTC +4</option>
            <option value="5">UTC +5</option>
            <option value="6">UTC +6</option>
            <option value="7">UTC +7</option>
            <option value="8">UTC +8</option>
            <option value="9">UTC +9</option>
            <option value="10">UTC+10</option>
            <option value="11">UTC+11</option>
            <option value="12">UTC+12</option>
          </select>
        </td>
      </tr>
      <tr>
        <td colspan="4" style="text-align: center;">
          <span style="color: red;">TWS</span>/<span style="color: blue;">TWD</span>
          &nbsp;<input type="checkbox" id="raw-data"    onchange="onDataChange();">Raw
          &nbsp;<input type="checkbox" id="smooth-data" onchange="onDataChange();" checked="true">Smoothed
          &nbsp;<input type="checkbox" id="tooltip"     onchange="onDataChange();" checked="true">Tooltip
          &nbsp;<input type="checkbox" id="utc-display" onchange="onDataChange();">UTC
          <br>
          <canvas id="graphCanvas" width="650" height="200" class="displayCanvas"/>
        </td>
      </tr>
      <tr>
        <td colspan="4">      
          <small>Warning: The wind arrows indicate the direction <b><i>in which</i></b> the wind is blowing</small>
        </td>
      </tr>
      <tr>
        <td colspan="4">      
          <div id="recno">Record...</div>
        </td>
      </tr>
      <tr>
        <td style="text-align: center;">Wind Dir in &deg;</td>
        <td style="text-align: center;">Wind Speed in knots</td>
        <td style="text-align: center;">Pressure in hPa</td>
        <td style="text-align: center;">Rain in mm/h</td>
      </tr>
      <tr>
        <td style="text-align: center;" valign="top" width="200">
          <canvas id="twdCanvas" width="180" height="165" class="display-scheme displayCanvas"/>
        </td>
        <td style="text-align: center;" valign="top" width="200">
          <canvas id="twsCanvas" width="180" height="165" class="displayCanvas"/>
        </td>
        <td style="text-align: center;" valign="top" width="200">
          <canvas id="prmslCanvas" width="180" height="165" class="displayCanvas"/>
        </td>
        <td style="text-align: center;" valign="top" width="100">
          <canvas id="rainCanvas" width="90" height="165" class="displayCanvas"/>
        </td>
      </tr>
      <tr>
        <td colspan="5">
          <div id="links" style="padding:5px; background:#ddd; border-radius:5px; overflow-x: scroll; border:1px solid #CCC; margin-top:3px; height:35px;"></div>          
        </td>
      </tr>
      <tr>
        <td colspan="5" valign="top">
          <button id="animate-button" onclick="animateSpot();">Animate</button>
        </td>
      </tr>
    </table>  
    <hr/>
    &copy; 2013, 2022, OlivSoft.
  </body>
</html>